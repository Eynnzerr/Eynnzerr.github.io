<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.eynnzerr.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Eynnzerr&#39;s Blog">
<meta property="og:url" content="http://blog.eynnzerr.top/index.html">
<meta property="og:site_name" content="Eynnzerr&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Eynnzerr">
<meta property="article:tag" content="Kotin,Android,iOS,Multi-platform">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://blog.eynnzerr.top/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Eynnzerr's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Eynnzerr's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Eynnzerr's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">2021-2025 é‡æ–°å‡ºå‘</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/Eynnzerr" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.eynnzerr.top/2026/01/30/kotlin-primitive-md/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/otae.jpg">
      <meta itemprop="name" content="Eynnzerr">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eynnzerr's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/30/kotlin-primitive-md/" class="post-title-link" itemprop="url">Kotlinçš„åŸºæœ¬ç±»å‹ä¸è£…ç®±æœºåˆ¶ç®€æ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2026-01-30 12:27:02 / ä¿®æ”¹æ—¶é—´ï¼š12:39:31" itemprop="dateCreated datePublished" datetime="2026-01-30T12:27:02+08:00">2026-01-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kotlin/" itemprop="url" rel="index"><span itemprop="name">Kotlin</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>5.5k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>10 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>æœ¬æ–‡ä» Kotlin çš„åŸºæœ¬ç±»å‹å‡ºå‘ï¼Œæ·±å…¥æ¢è®¨æ•°å€¼å­—é¢é‡çš„å®ç°åŸç†ï¼Œå¹¶å…¨é¢å‰–æ Kotlin ä¸ Java ä¸­çš„è£…ç®±&#x2F;æ‹†ç®±æœºåˆ¶ï¼ŒåŠ›æ±‚åšåˆ°çŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚</p>
</blockquote>
<hr>
<h2 id="ä¸€ã€Kotlin-åŸºæœ¬ç±»å‹æ¦‚è§ˆ"><a href="#ä¸€ã€Kotlin-åŸºæœ¬ç±»å‹æ¦‚è§ˆ" class="headerlink" title="ä¸€ã€Kotlin åŸºæœ¬ç±»å‹æ¦‚è§ˆ"></a>ä¸€ã€Kotlin åŸºæœ¬ç±»å‹æ¦‚è§ˆ</h2><p>Kotlin ä½œä¸ºä¸€é—¨ç°ä»£ JVM è¯­è¨€ï¼Œå¯¹åŸºæœ¬ç±»å‹çš„å¤„ç†æ—¢ä¿ç•™äº† Java çš„é«˜æ•ˆæ€§ï¼Œåˆå¢æ·»äº†æ›´ä¼˜é›…çš„è¯­æ³•è®¾è®¡ã€‚ä¸ Java åŒºåˆ†åŸå§‹ç±»å‹å’ŒåŒ…è£…ç±»çš„ç†å¿µä¸åŒï¼ŒKotlin ä¸­<strong>ä¸€åˆ‡çš†å¯¹è±¡</strong>â€”â€”æ²¡æœ‰åŸå§‹ç±»å‹ï¼ˆprimitive typesï¼‰çš„æ¦‚å¿µï¼Œä½†ç¼–è¯‘å™¨ä¼šåœ¨åº•å±‚è‡ªåŠ¨ä¼˜åŒ–ä¸º JVM åŸå§‹ç±»å‹ä»¥ä¿è¯æ€§èƒ½ã€‚</p>
<h3 id="1-1-æ•°å€¼ç±»å‹"><a href="#1-1-æ•°å€¼ç±»å‹" class="headerlink" title="1.1 æ•°å€¼ç±»å‹"></a>1.1 æ•°å€¼ç±»å‹</h3><p>Kotlin æä¾›äº†å¤šç§æ•°å€¼ç±»å‹ï¼Œè¦†ç›–ä¸åŒç²¾åº¦éœ€æ±‚ï¼š</p>
<table>
<thead>
<tr>
<th><strong>ç±»å‹</strong></th>
<th><strong>ä½å®½</strong></th>
<th><strong>å–å€¼èŒƒå›´</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>Byte</code></td>
<td>8 ä½</td>
<td>-128 ~ 127</td>
</tr>
<tr>
<td><code>Short</code></td>
<td>16 ä½</td>
<td>-32768 ~ 32767</td>
</tr>
<tr>
<td><code>Int</code></td>
<td>32 ä½</td>
<td>$-2^{31}$ ~ 2^{31}-1</td>
</tr>
<tr>
<td><code>Long</code></td>
<td>64 ä½</td>
<td>$-2^{63}$ ~ $2^{63}-1$</td>
</tr>
<tr>
<td><code>Float</code></td>
<td>32 ä½</td>
<td>å•ç²¾åº¦æµ®ç‚¹</td>
</tr>
<tr>
<td><code>Double</code></td>
<td>64 ä½</td>
<td>åŒç²¾åº¦æµ®ç‚¹</td>
</tr>
<tr>
<td>æ³¨ï¼š<code>Byte</code>, <code>Short</code>, <code>Int</code>, <code>Long</code> è¿˜å…·æœ‰å¯¹åº”æ— ç¬¦å·ç±»å‹ï¼š<code>UByte</code>, <code>UShort</code>, <code>UInt</code>, <code>ULong</code>ã€‚</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>å­—é¢é‡å†™æ³•ï¼š</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> intNum = <span class="number">100</span>          <span class="comment">// é»˜è®¤æ¨æ–­ä¸º Int</span></span><br><span class="line"><span class="keyword">val</span> longNum = <span class="number">100L</span>        <span class="comment">// L åç¼€è¡¨ç¤º Long</span></span><br><span class="line"><span class="keyword">val</span> floatNum = <span class="number">3.14f</span>      <span class="comment">// f åç¼€è¡¨ç¤º Float</span></span><br><span class="line"><span class="keyword">val</span> doubleNum = <span class="number">3.14</span>      <span class="comment">// é»˜è®¤æ¨æ–­ä¸º Double</span></span><br><span class="line"><span class="keyword">val</span> hexNum = <span class="number">0xFF</span>         <span class="comment">// åå…­è¿›åˆ¶</span></span><br><span class="line"><span class="keyword">val</span> binaryNum = <span class="number">0b1010</span>    <span class="comment">// äºŒè¿›åˆ¶</span></span><br><span class="line"><span class="keyword">val</span> readable = <span class="number">1_000_000</span>  <span class="comment">// æ”¯æŒä¸‹åˆ’çº¿åˆ†éš”ï¼Œæå‡å¯è¯»æ€§</span></span><br></pre></td></tr></table></figure>

<p><strong>æ˜¾å¼ç±»å‹è½¬æ¢ï¼š</strong> âš ï¸Kotlin ä¸æ”¯æŒéšå¼ç±»å‹è½¬æ¢ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨è½¬æ¢å‡½æ•°ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> i: <span class="built_in">Int</span> = <span class="number">100</span></span><br><span class="line"><span class="keyword">val</span> l: <span class="built_in">Long</span> = i.toLong()  <span class="comment">// âœ… æ­£ç¡®</span></span><br><span class="line"><span class="comment">// val l: Long = i        // âŒ ç¼–è¯‘é”™è¯¯</span></span><br></pre></td></tr></table></figure>

<h4 id="1-1-1-Number-ç±»"><a href="#1-1-1-Number-ç±»" class="headerlink" title="1.1.1 Number ç±»"></a>1.1.1 Number ç±»</h4><p>ä»¥ä¸Šæ•°å€¼ç±»å‹éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„çˆ¶ç±»ï¼š<code>Number</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå¹¶å®šä¹‰äº†ä¸€ç³»åˆ—æ˜¾ç¤ºç±»å‹è½¬æ¢å‡½æ•°ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Number</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">toDouble</span><span class="params">()</span></span>: <span class="built_in">Double</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">toFloat</span><span class="params">()</span></span>: <span class="built_in">Float</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">toLong</span><span class="params">()</span></span>: <span class="built_in">Long</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">toInt</span><span class="params">()</span></span>: <span class="built_in">Int</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">toChar</span><span class="params">()</span></span>: <span class="built_in">Char</span>  <span class="comment">// Deprecated</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">toShort</span><span class="params">()</span></span>: <span class="built_in">Short</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">toByte</span><span class="params">()</span></span>: <span class="built_in">Byte</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ç»§æ‰¿ <code>Number</code>ç±»å¹¶å®ç° <code>Comparable</code>æ¥å£ï¼Œæ´¾ç”Ÿå‡ºä»¥ä¸Šæ•°å€¼ç±»å‹ã€‚</p>
<h3 id="1-2-å­—ç¬¦ä¸å­—ç¬¦ä¸²"><a href="#1-2-å­—ç¬¦ä¸å­—ç¬¦ä¸²" class="headerlink" title="1.2 å­—ç¬¦ä¸å­—ç¬¦ä¸²"></a>1.2 å­—ç¬¦ä¸å­—ç¬¦ä¸²</h3><p><code>Char</code> è¡¨ç¤ºå•ä¸ªå­—ç¬¦ï¼ˆ16-bit Unicodeï¼‰ï¼Œç”¨å•å¼•å·åŒ…è£¹ï¼›å­—ç¬¦ä¸²ç”¨åŒå¼•å·æˆ–ä¸‰å¼•å·è¡¨ç¤ºï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> letter: <span class="built_in">Char</span> = <span class="string">&#x27;A&#x27;</span></span><br><span class="line"><span class="keyword">val</span> str = <span class="string">&quot;Hello, Kotlin&quot;</span></span><br><span class="line"><span class="keyword">val</span> multiLine = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è¿™æ˜¯å¤šè¡Œå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="string">    ä¿ç•™åŸå§‹æ ¼å¼</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.trimIndent()</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ <code>Char</code> ä¸æ•°å€¼ç±»å‹äº’è½¬çš„æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨ <code>toChar()</code>æˆ– <code>toLong()</code>ç­‰å·²ç»å¼ƒç”¨ï¼Œéœ€è¦ä»¥ <code>Int</code>ç±»å‹ä½œä¸ºåª’ä»‹ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> char: <span class="built_in">Char</span> = <span class="string">&#x27;A&#x27;</span>  </span><br><span class="line"><span class="keyword">val</span> i: <span class="built_in">Int</span> = char.code <span class="comment">// Code of a Char is the value it was constructed with, and the UTF-16 code unit corresponding to this Char.  </span></span><br><span class="line"><span class="keyword">val</span> l: <span class="built_in">Long</span> = char.code.toLong()  </span><br><span class="line"><span class="keyword">val</span> c: <span class="built_in">Char</span> = i.toChar() <span class="comment">// significant 16 bits of this Int value.  </span></span><br><span class="line"><span class="keyword">val</span> d: <span class="built_in">Char</span> = i.digitToChar() <span class="comment">// decimal digit</span></span><br></pre></td></tr></table></figure>

<p>Kotlin æ”¯æŒ<strong>å­—ç¬¦ä¸²æ¨¡æ¿</strong>ï¼Œè¿™åœ¨æ„é€ ç‰¹å®šå­—ç¬¦ä¸²ä»¥åŠæ—¥å¿—æ‰“å°ç­‰åœºæ™¯éƒ½éå¸¸å¥½ç”¨ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> name = <span class="string">&quot;World&quot;</span></span><br><span class="line">println(<span class="string">&quot;Hello, <span class="variable">$name</span>!&quot;</span>)           <span class="comment">// ç®€å•å˜é‡</span></span><br><span class="line">println(<span class="string">&quot;é•¿åº¦æ˜¯ <span class="subst">$&#123;name.length&#125;</span>&quot;</span>)    <span class="comment">// è¡¨è¾¾å¼</span></span><br></pre></td></tr></table></figure>

<p>Kotlin String è¿˜æœ‰æ›´å¤šå€¼å¾—è¯´é“çš„çŸ¥è¯†ç‚¹ï¼Œåœ¨æ­¤å…ˆç•¥è¿‡ï¼Œä¹‹åå¦å†™ä¸€ç¯‡åšå®¢æ¥è¯¦ç»†æ¢è®¨ã€‚</p>
<h3 id="1-3-å¸ƒå°”ç±»å‹ä¸æ•°ç»„"><a href="#1-3-å¸ƒå°”ç±»å‹ä¸æ•°ç»„" class="headerlink" title="1.3 å¸ƒå°”ç±»å‹ä¸æ•°ç»„"></a>1.3 å¸ƒå°”ç±»å‹ä¸æ•°ç»„</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> isKotlinFun: <span class="built_in">Boolean</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³›å‹æ•°ç»„</span></span><br><span class="line"><span class="keyword">val</span> arr = arrayOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŸå§‹ç±»å‹æ•°ç»„ï¼ˆé¿å…è£…ç®±å¼€é”€ï¼‰</span></span><br><span class="line"><span class="keyword">val</span> intArr = intArrayOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="äºŒã€æ•°å€¼å­—é¢é‡çš„å®ç°æœºåˆ¶"><a href="#äºŒã€æ•°å€¼å­—é¢é‡çš„å®ç°æœºåˆ¶" class="headerlink" title="äºŒã€æ•°å€¼å­—é¢é‡çš„å®ç°æœºåˆ¶"></a>äºŒã€æ•°å€¼å­—é¢é‡çš„å®ç°æœºåˆ¶</h2><p>æ—¢ç„¶ Kotlin ä¸­ <code>Int</code> æ˜¯ä¸€ä¸ªç±»ï¼Œä¸ºä»€ä¹ˆ <code>val x = 1</code> ä¸éœ€è¦å†™æˆ <code>val x = Int(1)</code> è¿™æ ·çš„æ„é€ å‡½æ•°å½¢å¼ï¼Ÿ</p>
<h3 id="2-1-å­—é¢é‡æ˜¯è¯­è¨€çº§åˆ«çš„è¯­æ³•ç³–"><a href="#2-1-å­—é¢é‡æ˜¯è¯­è¨€çº§åˆ«çš„è¯­æ³•ç³–" class="headerlink" title="2.1 å­—é¢é‡æ˜¯è¯­è¨€çº§åˆ«çš„è¯­æ³•ç³–"></a>2.1 å­—é¢é‡æ˜¯è¯­è¨€çº§åˆ«çš„è¯­æ³•ç³–</h3><p>æ•°å€¼å­—é¢é‡æ˜¯ Kotlin è¯­è¨€è§„èŒƒç›´æ¥æ”¯æŒçš„ç‰¹æ®Šè¯­æ³•ï¼Œç¼–è¯‘å™¨çœ‹åˆ° <code>1</code> æ—¶ï¼Œç›´æ¥å°†å…¶è¯†åˆ«ä¸º <code>Int</code> ç±»å‹çš„å­—é¢é‡å¸¸é‡ï¼Œ<strong>ä¸éœ€è¦</strong>ç»è¿‡ä»»ä½•æ„é€ å‡½æ•°è°ƒç”¨ã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> x = <span class="number">1</span>        <span class="comment">// å­—é¢é‡è¯­æ³•ï¼Œç¼–è¯‘å™¨ç›´æ¥å¤„ç†</span></span><br><span class="line"><span class="keyword">val</span> y = <span class="built_in">Int</span>(<span class="number">1</span>)   <span class="comment">// âŒ ç¼–è¯‘é”™è¯¯ï¼Int æ²¡æœ‰å…¬å¼€æ„é€ å‡½æ•°</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-ä¸ºä»€ä¹ˆ-Int-æ²¡æœ‰æ„é€ å‡½æ•°ï¼Ÿ"><a href="#2-2-ä¸ºä»€ä¹ˆ-Int-æ²¡æœ‰æ„é€ å‡½æ•°ï¼Ÿ" class="headerlink" title="2.2 ä¸ºä»€ä¹ˆ Int æ²¡æœ‰æ„é€ å‡½æ•°ï¼Ÿ"></a>2.2 ä¸ºä»€ä¹ˆ Int æ²¡æœ‰æ„é€ å‡½æ•°ï¼Ÿ</h3><p>Kotlin çš„æ•°å€¼ç±»å‹æ˜¯<strong>ç‰¹æ®Šçš„å†…ç½®ç±»å‹</strong>ï¼Œæ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ï¼š</p>
<table>
<thead>
<tr>
<th><strong>è®¾è®¡åŸå› </strong></th>
<th><strong>è¯´æ˜</strong></th>
</tr>
</thead>
<tbody><tr>
<td>æ€§èƒ½ä¼˜åŒ–</td>
<td>ç¼–è¯‘å™¨å¯ä»¥ç›´æ¥æ˜ å°„åˆ° JVM åŸå§‹ç±»å‹ï¼Œæ— éœ€çœŸæ­£çš„å¯¹è±¡åˆ†é…</td>
</tr>
<tr>
<td>è¯­ä¹‰æ¸…æ™°</td>
<td><code>1</code> å°±æ˜¯ <code>1</code>ï¼Œä¸éœ€è¦ <code>new Integer(1)</code> çš„å†—ä½™</td>
</tr>
<tr>
<td>é˜²æ­¢æ»¥ç”¨</td>
<td>é¿å… <code>Int(someString)</code> è¿™ç§å®¹æ˜“å‡ºé”™çš„ç”¨æ³•</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="2-3-ç¼–è¯‘è¿‡ç¨‹ç¤ºä¾‹"><a href="#2-3-ç¼–è¯‘è¿‡ç¨‹ç¤ºä¾‹" class="headerlink" title="2.3 ç¼–è¯‘è¿‡ç¨‹ç¤ºä¾‹"></a>2.3 ç¼–è¯‘è¿‡ç¨‹ç¤ºä¾‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚  Kotlin æºç         val x = 1                       â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚  ç¼–è¯‘å™¨ç†è§£          x æ˜¯ Int ç±»å‹ï¼Œå€¼ä¸ºå­—é¢é‡ 1      â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚  å­—èŠ‚ç è¾“å‡º          ICONST_1  (JVM åŸå§‹ int æŒ‡ä»¤)   â”‚</span><br><span class="line">â”‚                     ISTORE x                        â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>

<p>åç¼–è¯‘ä¸º Java ä»£ç ï¼Œå°±æ˜¯ç®€å•çš„ <code>int x = 1;</code>â€”â€”ç›´æ¥æ˜¯åŸå§‹ç±»å‹ï¼Œé›¶å¼€é”€ã€‚</p>
<hr>
<h2 id="ä¸‰ã€Kotlin-ä¸­çš„è£…ç®±æœºåˆ¶"><a href="#ä¸‰ã€Kotlin-ä¸­çš„è£…ç®±æœºåˆ¶" class="headerlink" title="ä¸‰ã€Kotlin ä¸­çš„è£…ç®±æœºåˆ¶"></a>ä¸‰ã€Kotlin ä¸­çš„è£…ç®±æœºåˆ¶</h2><p>è™½ç„¶ Kotlin åœ¨è¯­æ³•å±‚é¢â€éšè—â€äº†è£…ç®±çš„æ¦‚å¿µï¼Œä½†<strong>è£…ç®±å¹¶ä¸æ˜¯å°±æ¶ˆå¤±äº†</strong>â€”â€”åªæ˜¯ç¼–è¯‘å™¨å¸®æˆ‘ä»¬è‡ªåŠ¨å¤„ç†äº†ã€‚</p>
<h3 id="3-1-ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿè£…ç®±ï¼Ÿ"><a href="#3-1-ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿè£…ç®±ï¼Ÿ" class="headerlink" title="3.1 ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿè£…ç®±ï¼Ÿ"></a>3.1 ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿè£…ç®±ï¼Ÿ</h3><table>
<thead>
<tr>
<th><strong>åœºæ™¯</strong></th>
<th><strong>æ˜¯å¦è£…ç®±</strong></th>
<th><strong>åº•å±‚ç±»å‹</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>val x: Int = 1</code></td>
<td>âŒ ä¸è£…ç®±</td>
<td>JVM <code>int</code></td>
</tr>
<tr>
<td><code>val x: Int? = 1</code></td>
<td>âœ… è£…ç®±</td>
<td>JVM <code>Integer</code></td>
</tr>
<tr>
<td><code>val list: List&lt;Int&gt;</code></td>
<td>âœ… è£…ç®±</td>
<td><code>List&lt;Integer&gt;</code></td>
</tr>
<tr>
<td><code>fun foo(x: Any)</code> ä¼ å…¥ <code>Int</code></td>
<td>âœ… è£…ç®±</td>
<td><code>Object</code></td>
</tr>
<tr>
<td><code>val arr: IntArray</code></td>
<td>âŒ ä¸è£…ç®±</td>
<td>JVM <code>int[]</code></td>
</tr>
<tr>
<td><code>val arr: Array&lt;Int&gt;</code></td>
<td>âœ… è£…ç®±</td>
<td>JVM <code>Integer[]</code></td>
</tr>
</tbody></table>
<h3 id="3-2-å¯ç©ºç±»å‹å¿…é¡»è£…ç®±"><a href="#3-2-å¯ç©ºç±»å‹å¿…é¡»è£…ç®±" class="headerlink" title="3.2 å¯ç©ºç±»å‹å¿…é¡»è£…ç®±"></a>3.2 å¯ç©ºç±»å‹å¿…é¡»è£…ç®±</h3><p>JVM åŸå§‹ç±»å‹æ— æ³•è¡¨ç¤º nullï¼Œæ‰€ä»¥å¯ç©ºæ•°å€¼å¿…é¡»ç”¨åŒ…è£…ç±»ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> a: <span class="built_in">Int</span> = <span class="number">1</span>      <span class="comment">// åº•å±‚: int</span></span><br><span class="line"><span class="keyword">val</span> b: <span class="built_in">Int</span>? = <span class="number">1</span>     <span class="comment">// åº•å±‚: Integerï¼ˆæ‰èƒ½å­˜ nullï¼‰</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-æ³›å‹å¼ºåˆ¶è£…ç®±"><a href="#3-3-æ³›å‹å¼ºåˆ¶è£…ç®±" class="headerlink" title="3.3 æ³›å‹å¼ºåˆ¶è£…ç®±"></a>3.3 æ³›å‹å¼ºåˆ¶è£…ç®±</h3><p>JVM çš„æ³›å‹ä½¿ç”¨ç±»å‹æ“¦é™¤ï¼Œä¸æ”¯æŒåŸå§‹ç±»å‹ä½œä¸ºç±»å‹å‚æ•°ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list = listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)  <span class="comment">// List&lt;Int&gt; â†’ List&lt;Integer&gt;</span></span><br><span class="line"><span class="comment">// æ¯ä¸ªå…ƒç´ éƒ½è¢«è£…ç®±äº†ï¼</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-Array-vs-IntArray"><a href="#3-4-Array-vs-IntArray" class="headerlink" title="3.4 Array&lt;Int&gt; vs IntArray"></a>3.4 Array&lt;Int&gt; vs IntArray</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è£…ç®±æ•°ç»„</span></span><br><span class="line"><span class="keyword">val</span> boxed: Array&lt;<span class="built_in">Int</span>&gt; = arrayOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="comment">// åº•å±‚: Integer[] &#123;Integer.valueOf(1), Integer.valueOf(2), ...&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åŸå§‹ç±»å‹æ•°ç»„</span></span><br><span class="line"><span class="keyword">val</span> primitive: IntArray = intArrayOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="comment">// åº•å±‚: int[] &#123;1, 2, 3&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>å†…å­˜å¸ƒå±€å·®å¼‚ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Array&lt;Int&gt; (è£…ç®±)                    IntArray (åŸå§‹)</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Integer å¼•ç”¨ â”€â”€â”€â”€â”€â”€â†’ [Integer å¯¹è±¡] â”‚ int: 1          â”‚</span><br><span class="line">â”‚ Integer å¼•ç”¨ â”€â”€â”€â”€â”€â”€â†’ [Integer å¯¹è±¡] â”‚ int: 2          â”‚</span><br><span class="line">â”‚ Integer å¼•ç”¨ â”€â”€â”€â”€â”€â”€â†’ [Integer å¯¹è±¡] â”‚ int: 3          â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">   é¢å¤–çš„å¯¹è±¡å¼€é”€ + æŒ‡é’ˆè·³è½¬              è¿ç»­å†…å­˜ï¼Œé›¶å¼€é”€</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥å¤šä½¿ç”¨è¯¸å¦‚ <code>IntArray</code>çš„åŸå§‹æ•°æ®ç±»å‹æ•°ç»„å¯ä»¥é¿å…è£…ç®±å¼€é”€ï¼Œç®—æ˜¯ Kotlin ä½¿ç”¨çš„åŸºæœ¬æŠ€å·§ã€‚</p>
<hr>
<h2 id="å››ã€Java-ä¸­çš„è£…ç®±æœºåˆ¶"><a href="#å››ã€Java-ä¸­çš„è£…ç®±æœºåˆ¶" class="headerlink" title="å››ã€Java ä¸­çš„è£…ç®±æœºåˆ¶"></a>å››ã€Java ä¸­çš„è£…ç®±æœºåˆ¶</h2><p>Java çš„è£…ç®±æœºåˆ¶æ¯” Kotlin æ›´â€æ˜¾çœ¼â€â€”â€”å› ä¸º Java <strong>æ˜ç¡®åŒºåˆ†åŸå§‹ç±»å‹å’ŒåŒ…è£…ç±»</strong>ã€‚</p>
<h3 id="4-1-åŸå§‹ç±»å‹-vs-åŒ…è£…ç±»"><a href="#4-1-åŸå§‹ç±»å‹-vs-åŒ…è£…ç±»" class="headerlink" title="4.1 åŸå§‹ç±»å‹ vs åŒ…è£…ç±»"></a>4.1 åŸå§‹ç±»å‹ vs åŒ…è£…ç±»</h3><table>
<thead>
<tr>
<th><strong>åŸå§‹ç±»å‹</strong></th>
<th><strong>åŒ…è£…ç±»</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>int</code></td>
<td><code>Integer</code></td>
</tr>
<tr>
<td><code>long</code></td>
<td><code>Long</code></td>
</tr>
<tr>
<td><code>double</code></td>
<td><code>Double</code></td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>Boolean</code></td>
</tr>
<tr>
<td>â€¦</td>
<td>â€¦</td>
</tr>
</tbody></table>
<h3 id="4-2-è‡ªåŠ¨è£…ç®±ä¸æ‹†ç®±"><a href="#4-2-è‡ªåŠ¨è£…ç®±ä¸æ‹†ç®±" class="headerlink" title="4.2 è‡ªåŠ¨è£…ç®±ä¸æ‹†ç®±"></a>4.2 è‡ªåŠ¨è£…ç®±ä¸æ‹†ç®±</h3><p>Java 5 å¼•å…¥äº†è‡ªåŠ¨è£…ç®±ï¼Œè®©ä¸¤ç§ç±»å‹å¯ä»¥â€æ— ç¼â€è½¬æ¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è‡ªåŠ¨è£…ç®±ï¼šint â†’ Integer</span></span><br><span class="line"><span class="type">Integer</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">100</span>;  <span class="comment">// ç¼–è¯‘å™¨è½¬æ¢ä¸º: Integer.valueOf(100)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªåŠ¨æ‹†ç®±ï¼šInteger â†’ int</span></span><br><span class="line"><span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> x;        <span class="comment">// ç¼–è¯‘å™¨è½¬æ¢ä¸º: x.intValue()</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-è£…ç®±çš„ç»å…¸é™·é˜±"><a href="#4-3-è£…ç®±çš„ç»å…¸é™·é˜±" class="headerlink" title="4.3 è£…ç®±çš„ç»å…¸é™·é˜±"></a>4.3 è£…ç®±çš„ç»å…¸é™·é˜±</h3><p><strong>é™·é˜±ä¸€ï¼š&#x3D;&#x3D; æ¯”è¾ƒçš„è¯¡å¼‚è¡Œä¸ºï¼ˆé¢è¯•å¸¸è€ƒï¼‰</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Integer</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">127</span>;</span><br><span class="line"><span class="type">Integer</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">127</span>;</span><br><span class="line">System.out.println(a == b);  <span class="comment">// true âœ…</span></span><br><span class="line"></span><br><span class="line"><span class="type">Integer</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">128</span>;</span><br><span class="line"><span class="type">Integer</span> <span class="variable">d</span> <span class="operator">=</span> <span class="number">128</span>;</span><br><span class="line">System.out.println(c == d);  <span class="comment">// false âŒ</span></span><br></pre></td></tr></table></figure>

<p>åŸå› æ˜¯ <code>Integer.valueOf()</code> å¯¹ -128 ~ 127 èŒƒå›´å†…çš„å€¼ä½¿ç”¨äº†ç¼“å­˜æ± ï¼Œè¶…å‡ºèŒƒå›´åˆ™åˆ›å»ºæ–°å¯¹è±¡ã€‚<strong>æ¯”è¾ƒå€¼æ°¸è¿œç”¨ <code>equals()</code>ï¼</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title function_">valueOf</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= -<span class="number">128</span> &amp;&amp; i &lt;= <span class="number">127</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> IntegerCache.cache[i + <span class="number">128</span>];  <span class="comment">// è¿”å›ç¼“å­˜å¯¹è±¡</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Integer</span>(i);  <span class="comment">// è¶…å‡ºèŒƒå›´ï¼Œåˆ›å»ºæ–°å¯¹è±¡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>é™·é˜±äºŒï¼šNullPointerException</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Integer</span> <span class="variable">x</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> x;  <span class="comment">// ğŸ’¥ NullPointerException!</span></span><br><span class="line"><span class="comment">// å› ä¸ºå®é™…æ‰§è¡Œçš„æ˜¯: x.intValue()</span></span><br></pre></td></tr></table></figure>

<p><strong>é™·é˜±ä¸‰ï¼šå¾ªç¯ä¸­çš„æ€§èƒ½æ€æ‰‹</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç³Ÿç³•çš„å†™æ³•ï¼šæ¯æ¬¡è¿­ä»£éƒ½è£…ç®±</span></span><br><span class="line"><span class="type">Long</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">long</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">    sum += i;  <span class="comment">// æ‹†ç®± â†’ ç›¸åŠ  â†’ è£…ç®±ï¼Œåˆ›å»ºå¤§é‡ä¸´æ—¶å¯¹è±¡</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®çš„å†™æ³•</span></span><br><span class="line"><span class="type">long</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">long</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">    sum += i;  <span class="comment">// çº¯åŸå§‹ç±»å‹æ“ä½œ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-å†…å­˜å¼€é”€å¯¹æ¯”"><a href="#4-4-å†…å­˜å¼€é”€å¯¹æ¯”" class="headerlink" title="4.4 å†…å­˜å¼€é”€å¯¹æ¯”"></a>4.4 å†…å­˜å¼€é”€å¯¹æ¯”</h3><ul>
<li>åŸå§‹ç±»å‹ int: 4 bytes</li>
<li>åŒ…è£…ç±» Integer:   å¯¹è±¡å¤´ (12 bytes) + value (4 bytes) + å¯¹é½ â‰ˆ 16 bytes + å¼•ç”¨æŒ‡é’ˆ 4-8 bytes</li>
</ul>
<p><strong>å¯è§ä¸€ä¸ª Integer æ¯” int å¤šå ç”¨çº¦ 4-5 å€å†…å­˜ï¼</strong></p>
<hr>
<h2 id="äº”ã€Kotlin-vs-Java-è£…ç®±å¯¹æ¯”"><a href="#äº”ã€Kotlin-vs-Java-è£…ç®±å¯¹æ¯”" class="headerlink" title="äº”ã€Kotlin vs Java è£…ç®±å¯¹æ¯”"></a>äº”ã€Kotlin vs Java è£…ç®±å¯¹æ¯”</h2><table>
<thead>
<tr>
<th><strong>ç‰¹æ€§</strong></th>
<th><strong>Java</strong></th>
<th><strong>Kotlin</strong></th>
</tr>
</thead>
<tbody><tr>
<td>ç±»å‹åŒºåˆ†</td>
<td>æ˜¾å¼åŒºåˆ† <code>int</code> &#x2F; <code>Integer</code></td>
<td>ç»Ÿä¸€ä¸º <code>Int</code>ï¼Œç¼–è¯‘å™¨å†³å®š</td>
</tr>
<tr>
<td>è£…ç®±è¯­æ³•</td>
<td>å¯è§ (<code>Integer x = 1</code>)</td>
<td>éšè— (<code>val x: Int? = 1</code>)</td>
</tr>
<tr>
<td>null å®‰å…¨</td>
<td>è¿è¡Œæ—¶æŠ›å¼‚å¸¸</td>
<td>ç¼–è¯‘æœŸæ£€æŸ¥</td>
</tr>
<tr>
<td>åŸå§‹æ•°ç»„</td>
<td><code>int[]</code></td>
<td><code>IntArray</code></td>
</tr>
<tr>
<td>åŒ…è£…æ•°ç»„</td>
<td><code>Integer[]</code></td>
<td><code>Array&lt;Int&gt;</code></td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Javaï¼šä½ å¿…é¡»è‡ªå·±é€‰æ‹©</span></span><br><span class="line"><span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">1</span>;        <span class="comment">// åŸå§‹ç±»å‹</span></span><br><span class="line"><span class="type">Integer</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">1</span>;    <span class="comment">// åŒ…è£…ç±»ï¼ˆè‡ªåŠ¨è£…ç®±ï¼‰</span></span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Kotlinï¼šç¼–è¯‘å™¨å¸®ä½ é€‰æ‹©</span></span><br><span class="line"><span class="keyword">val</span> a: <span class="built_in">Int</span> = <span class="number">1</span>    <span class="comment">// åº•å±‚æ˜¯ int</span></span><br><span class="line"><span class="keyword">val</span> b: <span class="built_in">Int</span>? = <span class="number">1</span>   <span class="comment">// åº•å±‚æ˜¯ Integerï¼ˆå› ä¸ºå¯ç©ºï¼‰</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="å…­ã€æœ€ä½³å®è·µ"><a href="#å…­ã€æœ€ä½³å®è·µ" class="headerlink" title="å…­ã€æœ€ä½³å®è·µ"></a>å…­ã€æœ€ä½³å®è·µ</h2><h3 id="Kotlin-æœ€ä½³å®è·µ"><a href="#Kotlin-æœ€ä½³å®è·µ" class="headerlink" title="Kotlin æœ€ä½³å®è·µ"></a>Kotlin æœ€ä½³å®è·µ</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. å°½é‡ç”¨éç©ºç±»å‹</span></span><br><span class="line"><span class="keyword">val</span> x: <span class="built_in">Int</span> = <span class="number">1</span>      <span class="comment">// âœ… åº•å±‚æ˜¯ int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. æ•°å€¼æ•°ç»„ç”¨åŸå§‹ç±»å‹ç‰ˆæœ¬</span></span><br><span class="line"><span class="keyword">val</span> arr = IntArray(<span class="number">1000</span>)       <span class="comment">// âœ… int[]</span></span><br><span class="line"><span class="keyword">val</span> arr = Array&lt;<span class="built_in">Int</span>&gt;(<span class="number">1000</span>)&#123;<span class="number">0</span>&#125;  <span class="comment">// âŒ Integer[]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. æ€§èƒ½æ•æ„Ÿåœºæ™¯æ³¨æ„æ³›å‹é›†åˆçš„è£…ç®±å¼€é”€</span></span><br></pre></td></tr></table></figure>

<h3 id="Java-æœ€ä½³å®è·µ"><a href="#Java-æœ€ä½³å®è·µ" class="headerlink" title="Java æœ€ä½³å®è·µ"></a>Java æœ€ä½³å®è·µ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. ä¼˜å…ˆä½¿ç”¨åŸå§‹ç±»å‹</span></span><br><span class="line"><span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. æ¯”è¾ƒåŒ…è£…ç±»ç”¨ equals()</span></span><br><span class="line"><span class="keyword">if</span> (integer1.equals(integer2)) &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. æ‹†ç®±å‰æ£€æŸ¥ null</span></span><br><span class="line"><span class="keyword">if</span> (value != <span class="literal">null</span> &amp;&amp; value &gt; <span class="number">0</span>) &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. é¿å…åœ¨å¾ªç¯ä¸­ä½¿ç”¨åŒ…è£…ç±»åšç´¯åŠ </span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ä¸ƒã€æ€»ç»“"><a href="#ä¸ƒã€æ€»ç»“" class="headerlink" title="ä¸ƒã€æ€»ç»“"></a>ä¸ƒã€æ€»ç»“</h2><p>ç†è§£ç±»å‹ç³»ç»Ÿå’Œè£…ç®±æœºåˆ¶ï¼Œæ˜¯å†™å‡ºé«˜è´¨é‡ JVM ä»£ç çš„åŸºç¡€ï¼š</p>
<ul>
<li><strong>Kotlin</strong> é€šè¿‡ç»Ÿä¸€çš„ç±»å‹è¯­æ³•å’Œç©ºå®‰å…¨è®¾è®¡ï¼Œå°†è£…ç®±çš„å¤æ‚æ€§éšè—åœ¨ç¼–è¯‘å™¨èƒŒåï¼Œè®©å¼€å‘è€…ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘</li>
<li><strong>Java</strong> çš„æ˜¾å¼åŒè½¨åˆ¶è¦æ±‚å¼€å‘è€…æ—¶åˆ»æ„è¯†åˆ°åŸå§‹ç±»å‹å’ŒåŒ…è£…ç±»çš„åŒºåˆ«ï¼Œé¿å…æ€§èƒ½é™·é˜±å’Œ NPE</li>
</ul>
<p>æ— è®ºä½¿ç”¨å“ªç§è¯­è¨€ï¼Œè®°ä½ä¸€ä¸ªåŸåˆ™å³å¯ï¼š<strong>åœ¨æ€§èƒ½æ•æ„Ÿçš„åœºæ™¯ä¸‹ï¼Œä¼˜å…ˆä½¿ç”¨åŸå§‹ç±»å‹ï¼›åœ¨éœ€è¦å¯¹è±¡è¯­ä¹‰çš„åœºæ™¯ä¸‹ï¼Œæ³¨æ„è£…ç®±çš„å¼€é”€å’Œç©ºå€¼å¤„ç†</strong>ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.eynnzerr.top/2026/01/29/package-size-incre-md/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/otae.jpg">
      <meta itemprop="name" content="Eynnzerr">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eynnzerr's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/29/package-size-incre-md/" class="post-title-link" itemprop="url">Compose Multiplatform åŒ…ä½“ç§¯æš´æ¶¨åŸå› æ’æŸ¥è®°å½•</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2026-01-29 16:48:52" itemprop="dateCreated datePublished" datetime="2026-01-29T16:48:52+08:00">2026-01-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2026-01-30 12:29:26" itemprop="dateModified" datetime="2026-01-30T12:29:26+08:00">2026-01-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Compose-Multiplatform/" itemprop="url" rel="index"><span itemprop="name">Compose Multiplatform</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>4k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>7 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="æ¡ˆä¾‹ä¸€"><a href="#æ¡ˆä¾‹ä¸€" class="headerlink" title="æ¡ˆä¾‹ä¸€"></a>æ¡ˆä¾‹ä¸€</h2><p>2025å¹´12æœˆ18æ—¥ï¼Œå‘ç°v1.0.3ç‰ˆæœ¬æ¡Œé¢ç«¯å®‰è£…åŒ…ä½“ç§¯çˆ†ç‚¸å¢å¤§ï¼Œä»åŸæœ¬çš„150MBå·¦å³æš´æ¶¨åˆ°1GBï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚<br><img src="/package-size-incre-md/image.png" alt="image.png"></p>
<p>ç”±äºä¸‰ç«¯å‡äº§ç”Ÿè¯¥é—®é¢˜ï¼Œä»¥ macOS ç«¯(.dmg)ä¸ºä¾‹å±•å¼€æ’æŸ¥ã€‚è§£åŒ…äº§ç‰©ï¼Œåˆ‡å…¥ <code>contents</code> ç›®å½•æŸ¥çœ‹æ–‡ä»¶å¤¹å¤§å°ï¼Œæ‰§è¡Œ <code>du -sh ./*</code>ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">116K ./Contents/_CodeSignature </span><br><span class="line">999M ./Contents/app </span><br><span class="line">4.0K ./Contents/Info.plist </span><br><span class="line">196K ./Contents/MacOS </span><br><span class="line">4.0K ./Contents/PkgInfo </span><br><span class="line">16K ./Contents/Resources </span><br><span class="line">158M ./Contents/runtime</span><br></pre></td></tr></table></figure>

<p>æ˜¾ç„¶ <strong><code>Contents/app</code>ï¼ˆ999MBï¼‰</strong> ç‚¸äº†ã€‚è¿™ä¹Ÿå°±æ˜¯è¯´ï¼šè¿™æ¬¡è†¨èƒ€åŸå› ä¸»è¦æ¥è‡ª <strong>åº”ç”¨å±‚æ‰“åŒ…è¿›å»çš„ jar&#x2F;ä¾èµ–&#x2F;èµ„æº</strong> å¼‚å¸¸åœ°å¤šï¼Œåˆæ­¥æ€€ç–‘æ˜¯æŸä¸ªåº“å‘ç”Ÿäº†é—®é¢˜ï¼Œå°†ä¸‰ä»½nativeåŒ…å…¨éƒ½æ‰“åŒ…åˆ°ä¸€ä¸ªnativeå¹³å°ä¸Šäº†ã€‚</p>
<p>åˆ‡å…¥Â <code>Contents/app</code> æ‰§è¡Œ <code>du -sh ./*</code>Â ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">22M	./opencv-4.6.0-1.5.8-android-x86-b38c986c415ad7d34111fa1ff684a19a.jar</span><br><span class="line">26M	./opencv-4.6.0-1.5.8-ios-arm64-5a95a9fd33b458cf8dc8538fff16.jar</span><br><span class="line">28M	./opencv-4.6.0-1.5.8-ios-x86_64-d3cdf6cb93ba33f2240a97fd5193.jar</span><br><span class="line">24M	./opencv-4.6.0-1.5.8-linux-arm64-91b0d28db0dcbe847ead233f99a2831.jar</span><br><span class="line">22M	./opencv-4.6.0-1.5.8-linux-armhf-4d45d47f293943abde4163761b744fc.jar</span><br><span class="line">27M	./opencv-4.6.0-1.5.8-linux-ppc64le-511dfd3698bebebd724d4052e6a34b90.jar</span><br><span class="line">27M	./opencv-4.6.0-1.5.8-linux-x86_64-91c04431ec13e27014c25b8f77ece6.jar</span><br><span class="line">28M	./opencv-4.6.0-1.5.8-linux-x86-941136bbfad2956a86b10f9242fad34.jar</span><br><span class="line">20M	./opencv-4.6.0-1.5.8-macosx-arm64-699b23fa8d64ced8f96a65d012ff48.jar</span><br><span class="line">25M	./opencv-4.6.0-1.5.8-macosx-x86_64-855f22d26a3e7eb65122adacf1e5cee4.jar</span><br><span class="line">29M	./opencv-4.6.0-1.5.8-windows-x86_64-149da917d80e13db6cac72fd53170cc.jar</span><br><span class="line">27M	./opencv-4.6.0-1.5.8-windows-x86-e136927b1d9446f968ea2bd45dfa13e.jar</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>è¿™å°±å¾ˆæ˜¾ç„¶äº†ï¼ŒéªŒè¯äº†çŒœæƒ³æ˜¯å¯¹çš„ã€‚æ˜æ˜æ˜¯macOSå¹³å°çš„åŒ…ï¼Œå´è¿ windows åŠ linux çš„jaréƒ½è¢«æ‰“åŒ…è¿›æ¥ï¼Œæ‰€ä»¥å¯¼è‡´äº†åŒ…ä½“ç§¯æš´æ¶¨ã€‚ä¸‹ä¸€æ­¥æ˜¯æ’æŸ¥æœ€ç»ˆçš„ç½ªé­ç¥¸é¦–ï¼Œæ˜¯è°å¹²äº†è¿™ä»¶è ¢äº‹ã€‚å›åˆ°é¡¹ç›®ä¸­è¿è¡Œ <code>./gradlew :composeApp:dependencyInsight --configuration desktopRuntimeClasspath --dependency javacv-platform</code>ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<p><img src="/package-size-incre-md/image-1.png" alt="image-1.png"></p>
<p>æ°´è½çŸ³å‡ºï¼Œç»“æœæ˜¾ç¤ºæ˜¯ <code>cmp-image-pick-n-crop-jvm:1.1.2</code> è¿™ä¸ªåº“ä¾èµ– <code>org.bytedeco:javacv-platform:1.5.8</code> åˆä¾èµ– <code>org.bytedeco:opencv-platform:4.6.0-1.5.8</code>ã€‚<code>cmp-image-pick-n-crop</code> æ˜¯æˆ‘åœ¨Githubä¸Šæ‰¾çš„ä¸€ä¸ªç”¨æ¥è£å‰ªå›¾ç‰‡çš„ç¬¬ä¸‰æ–¹åº“ï¼Œå®ƒçš„JVMå¹³å°åŒ…ä¾èµ–äº† <code>*-platform</code> å…¨å®¶æ¡¶ï¼Œå¯¼è‡´æš´å¢ã€‚æˆ‘åœ¨æœ¬æ¬¡æ›´æ–°çš„æ”¹åŠ¨ä¸­å°†å…¶ç‰ˆæœ¬ä» <code>1.1.1</code> å‡çº§åˆ° <code>1.1.2</code> æ‰å‡ºç°è¿™ä¸ªé—®é¢˜ï¼Œçœ‹æ¥æ˜¯ä½œè€…åœ¨æ›´æ–°ä»–çš„åº“ä¾èµ–æ—¶çŠ¯äº†ä¸ªä½çº§é”™è¯¯ã€‚</p>
<p>ä¿®å¤å¾ˆç®€å•ï¼Œå›é€€åˆ° <code>1.1.1</code> å³å¯è§£å†³ï¼Œä½†æ˜¯æ²»æ ‡ä¸æ²»æœ¬ã€‚æœ¬ç€å¼€æºç²¾ç¥è‡³ä¸Šçš„åŸåˆ™æˆ‘æŠŠè¯¥åº“forkå¹¶æ‹‰äº†ä¸‹æ¥å‡†å¤‡ç›´æ¥ä¿®å¹¶æPRï¼Œç»“æœè¿™æ‰å‘ç°è¿™æ˜¯ä¸ªå‡å¼€æºé¡¹ç›®ã€‚æºä»£ç æ˜¯ç©ºçš„ï¼Œåªæœ‰ä¸ªç¤ºä¾‹appã€‚å¯¹å°åº¦äººçš„åˆ»æ¿å°è±¡å†æ¬¡åŠ æ·±ã€‚æ— å¥ˆåªå¥½æäº†ä¸ªissueä½œç½¢ï¼Œä½†ä¼°è®¡ä¹Ÿä¸ä¼šè¢«ç†ç¬ï¼Œçœ‹commitæ—¥æœŸè¿™ä¸ªåº“å·²ç»è¢«æ”¾å¼ƒç»´æŠ¤äº†ï¼Œä»¤äººæ„Ÿå¹ã€‚</p>
<h2 id="æ¡ˆä¾‹äºŒ"><a href="#æ¡ˆä¾‹äºŒ" class="headerlink" title="æ¡ˆä¾‹äºŒ"></a>æ¡ˆä¾‹äºŒ</h2><p>2026å¹´1æœˆ28æ—¥ï¼Œå‘ç°v1.0.4ç‰ˆæœ¬æ¡Œé¢ç«¯å®‰è£…åŒ…ä½“ç§¯å†æ¬¡å‡ºç°å¼‚å¸¸å¢å¤§ï¼Œä½†è¿™æ¬¡æ¶¨å¹…ä¸å¦‚ä¸Šæ¬¡ï¼Œä¸”åªæœ‰ Win &#x2F; Linux å¹³å°å—å½±å“ã€‚</p>
<p><img src="/package-size-incre-md/image-2.png" alt="image-2.png"></p>
<p>è¿™æ¬¡ä»¥ Linux å¹³å° (.deb) ä¸ºä¾‹è¿›è¡Œæ’æŸ¥ï¼Œè¿˜æ˜¯è€æ–¹æ³•ï¼Œè§£åŒ…ç„¶åçœ‹è°å˜å¤§äº†ã€‚åˆ†åˆ«å¯¹æ–°è€ç‰ˆæœ¬å®‰è£…åŒ…è¿è¡Œ <code>du -h -d 4 old | sort -h | tail -n 30</code> æŸ¥çœ‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># old</span><br><span class="line">4.0K    old/opt/bandoristationm/share</span><br><span class="line">4.0K    old/opt/bandoristationm/share/doc</span><br><span class="line"> 20K    old/opt/bandoristationm/bin</span><br><span class="line">129M    old/opt/bandoristationm/lib/app</span><br><span class="line">168M    old/opt/bandoristationm/lib/runtime</span><br><span class="line">298M    old</span><br><span class="line">298M    old/opt</span><br><span class="line">298M    old/opt/bandoristationm</span><br><span class="line">298M    old/opt/bandoristationm/lib</span><br><span class="line"></span><br><span class="line"># new</span><br><span class="line">4.0K    new/opt/bandoristationm/share</span><br><span class="line">4.0K    new/opt/bandoristationm/share/doc</span><br><span class="line"> 24K    new/opt/bandoristationm/bin</span><br><span class="line">129M    new/opt/bandoristationm/lib/app</span><br><span class="line">480M    new/opt/bandoristationm/lib/runtime</span><br><span class="line">610M    new</span><br><span class="line">610M    new/opt</span><br><span class="line">610M    new/opt/bandoristationm</span><br><span class="line">610M    new/opt/bandoristationm/lib</span><br></pre></td></tr></table></figure>

<p><code>lib/runtime</code> ç‚¸äº†ï¼Œæ˜¾ç„¶è¿™æ¬¡ä¸æ˜¯ä¾èµ–åŒ…çš„é—®é¢˜ï¼Œè€Œæ˜¯JREå‡ºäº†å·®é”™ï¼Œå°±åƒæ²¡è¢«è£å‰ªä¸€æ ·ã€‚åœ¨æ–°ç‰ˆæœ¬åŒ…ä¸­è¿è¡Œ <code>find new/opt/bandoristationm/lib/runtime/lib -type f -print0 | xargs -0 ls -lnS | head -n 30</code>ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-rw-r--r--  1 501  20  209861688 Jan 28 17:05 new/opt/bandoristationm/lib/runtime/lib/libcef.so</span><br><span class="line">-rw-r--r--  1 501  20  147634191 Jan 28 17:05 new/opt/bandoristationm/lib/runtime/lib/modules</span><br><span class="line">-rw-r--r--  1 501  20   26726528 Jan 28 17:05 new/opt/bandoristationm/lib/runtime/lib/server/libjvm.so</span><br><span class="line">-rw-r--r--  1 501  20   10717392 Jan 28 17:05 new/opt/bandoristationm/lib/runtime/lib/icudtl.dat</span><br><span class="line">-rw-r--r--  1 501  20   10715134 Jan 28 17:05 new/opt/bandoristationm/lib/runtime/lib/ct.sym</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>ä¸€ä¸Šæ¥å°±çœ‹æ‡‚äº†ï¼Œæ€ä¹ˆæ··è¿›æ¥ä¸ªåºç„¶å¤§ç‰© <code>libcef.so</code>ï¼Œæˆ‘è¿™æ˜¯ä¸çŸ¥é“è¢«è°å¡äº†æ•´å¥— Chromium å•Šã€‚ç¿»äº†ç¿»è¿‡å»çš„ commit è®°å½•ï¼Œå®šä½äº†ç½ªé­ç¥¸é¦–ï¼šåœ¨ Android Studio å»ºè®®è¿ç§» gradle åï¼Œgradle åœ¨å‡çº§åˆ°9.0.0çš„åŒæ—¶ï¼Œé¡ºæ‰‹ç»™æˆ‘å¡äº†ä¸ª <code>gradle-daemon-jvm.properties</code>ã€‚æˆ‘æ²¡æœ‰åœ¨æ„ï¼Œä½†æ˜¯è¿™ä¸ªé…ç½®æ–‡ä»¶é‡Œé¢è®¾ç½®äº† <code>toolchainVendor=JETBRAINS</code>ï¼Œå³æŒ‡å®š JBR ä¸º Gradle Daemon çš„è¿è¡Œæ—¶ï¼Œè€Œä¸Šé¢çš„URLé‡Œé¢åˆæŒ‡å®šäº† JBR çš„ç‰ˆæœ¬æ˜¯å¸¦ JCEF çš„ç‰ˆæœ¬ï¼š</p>
<ul>
<li>Linux:Â <code>jbrsdk_jcef-21.0.9-linux-x64-b895.149.tar.gz</code></li>
<li>Windows:Â <code>jbrsdk_jcef-21.0.9-windows-x64-b895.149.zip</code></li>
<li>macOS:Â <code>jbrsdk_jcef-21.0.9-osx-aarch64-b895.149.tar.gz</code></li>
</ul>
<p>è¿™ä¹Ÿå¯¼è‡´å½“workflowåœ¨è·‘æ—¶ï¼ŒGradleæ„å»ºæ—¶ï¼Œä¸ä¼šå†ç”¨æˆ‘æŒ‡å®šçš„ temurinï¼Œè€Œæ˜¯ç°åœºä¸‹å¸¦JCEF çš„ JBR ç”¨ï¼Œè‡ªç„¶æ‰“åŒ…æ—¶æŠŠ libcef.so ç­‰ä¸€ç³»åˆ—ä¸éœ€è¦çš„ä¸œè¥¿ä¹Ÿæ‹è¿›æ¥äº†ã€‚</p>
<p>è§£å†³ï¼šç›´æ¥rollbackå³å¯ã€‚</p>
<h2 id="ç»éªŒæ€»ç»“"><a href="#ç»éªŒæ€»ç»“" class="headerlink" title="ç»éªŒæ€»ç»“"></a>ç»éªŒæ€»ç»“</h2><p>é‡åˆ°åŒ…ä½“ç§¯æš´æ¶¨ä¸ç”¨æ…Œï¼Œå‡¡äº‹çš†æœ‰è¿¹å¯å¾ªã€‚æ¡Œé¢ç«¯æ‰“åŒ…ï¼ˆCompose Desktop&#x2F;jpackageï¼‰æœ‰ä¸ªç‰¹ç‚¹ï¼š<strong>æœ€ç»ˆä½“ç§¯ä¸»è¦ç”±ä¸¤éƒ¨åˆ†å†³å®š</strong>ï¼š</p>
<ul>
<li><strong>åº”ç”¨å±‚</strong>ï¼š<code>lib/app</code>ï¼ˆjarã€èµ„æºã€ä»£ç ï¼‰-&gt; é€šå¸¸å¢é•¿æ˜¯æ¸è¿›çš„</li>
<li><strong>è¿è¡Œæ—¶å±‚</strong>ï¼š<code>lib/runtime</code>ï¼ˆJRE&#x2F;JBRã€nativeã€èµ„æºåŒ…ï¼‰-&gt; <strong>ä¸€æ—¦ç­–ç•¥å˜äº†å°±æ˜¯æ–­å´–å¼å¢é•¿</strong></li>
</ul>
<p>ä¸è¦ç”¨â€œæ€»å¤§å°â€å½“æŒ‡æ ‡ï¼Œè€Œæ˜¯è¦æŠ“â€œç»“æ„â€ï¼ŒæŠŠä½“ç§¯æ‹†æˆå¯è§£é‡Šçš„ç»“æ„æŒ‡æ ‡ï¼Œè¿…é€Ÿå½’å› ï¼š</p>
<ul>
<li><code>app</code>Â å˜å¤§ â†’ ä¾èµ–&#x2F;èµ„æº&#x2F;é‡å¤æ‰“åŒ…</li>
<li><code>runtime</code>Â å˜å¤§ â†’ JDK&#x2F;JBR å˜æ›´ã€jlink å¤±æ•ˆã€å¼•å…¥ JCEFã€debug ç¬¦å·ç­‰</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.eynnzerr.top/2025/09/08/index_in_kotlin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/otae.jpg">
      <meta itemprop="name" content="Eynnzerr">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eynnzerr's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/08/index_in_kotlin/" class="post-title-link" itemprop="url">Kotlin ä¸­çš„ '[]'</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-09-08 15:53:59" itemprop="dateCreated datePublished" datetime="2025-09-08T15:53:59+08:00">2025-09-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2026-01-27 15:53:21" itemprop="dateModified" datetime="2026-01-27T15:53:21+08:00">2026-01-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kotlin/" itemprop="url" rel="index"><span itemprop="name">Kotlin</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>3.9k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>7 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Kotlin-çš„-åˆ°åº•æ˜¯ä»€ä¹ˆ"><a href="#Kotlin-çš„-åˆ°åº•æ˜¯ä»€ä¹ˆ" class="headerlink" title="Kotlin çš„ [] åˆ°åº•æ˜¯ä»€ä¹ˆ"></a>Kotlin çš„ <code>[]</code> åˆ°åº•æ˜¯ä»€ä¹ˆ</h2><p>åˆšå†™ Kotlin æ—¶ï¼Œæˆ‘å°±å¾ˆå¿«çˆ±ä¸Šäº† <code>map[&quot;key&quot;]</code>ã€<code>list[i]</code> è¿™ç§ç®€æ´çš„ <code>[]</code> å†™æ³•ã€‚å®ƒçœ‹èµ·æ¥å°±åƒåœ¨å…¶ä»–è¯­è¨€ä¸­æ—©å·²ç†Ÿæ‚‰çš„â€œä¸‹æ ‡è®¿é—®â€ï¼Œä½†æ›´å‡†ç¡®çš„è¯´æ³•æ˜¯ï¼š<strong><code>[]</code> æ˜¯ç¼–è¯‘å™¨æä¾›çš„è¿ç®—ç¬¦çº¦å®šï¼ˆoperator conventionï¼‰è¯­æ³•ç³–</strong>ã€‚å®ƒæ—¢èƒ½è®¿é—® List&#x2F;Arrayï¼Œä¹Ÿèƒ½ç”¨äº Mapï¼Œç”šè‡³å¯ä»¥è¢«è‡ªå®šä¹‰åˆ°ä»»ä½•ç±»å‹ä¸Šã€‚</p>
<hr>
<h2 id="1-çš„åŸç†ï¼šç¼–è¯‘æœŸæ”¹å†™ä¸º-get-set"><a href="#1-çš„åŸç†ï¼šç¼–è¯‘æœŸæ”¹å†™ä¸º-get-set" class="headerlink" title="1) [] çš„åŸç†ï¼šç¼–è¯‘æœŸæ”¹å†™ä¸º get/set"></a>1) <code>[]</code> çš„åŸç†ï¼šç¼–è¯‘æœŸæ”¹å†™ä¸º <code>get/set</code></h2><p>Kotlin çš„ <code>[]</code> å¹¶ä¸æ˜¯æŸç§â€œè¿è¡Œæ—¶ç‰¹æ€§â€ã€‚ç¼–è¯‘å™¨ä¼šæŠŠå®ƒ<strong>é™æ€åœ°æ”¹å†™</strong>æˆå‡½æ•°è°ƒç”¨ï¼š</p>
<ul>
<li>è¯»å–ï¼š<code>a[b]</code>  â†’  <code>a.get(b)</code></li>
<li>å†™å…¥ï¼š<code>a[b] = c</code>  â†’  <code>a.set(b, c)</code></li>
</ul>
<p>åªè¦ä½ çš„ç±»å‹ï¼ˆæˆå‘˜å‡½æ•°æˆ–æ‰©å±•å‡½æ•°ï¼‰æä¾›äº†ç›¸åº”ç­¾åï¼Œå¹¶ç”¨ <code>operator</code> ä¿®é¥°ï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>[]</code>ã€‚ä¸€ä¸ªç®€å•çš„è‡ªå®šä¹‰ç±»å®ç°ä¾‹å­å¦‚ä¸‹ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Grid</span>&lt;<span class="type">T</span>&gt;(<span class="keyword">private</span> <span class="keyword">val</span> <span class="keyword">data</span>: Array&lt;Array&lt;T&gt;&gt;) &#123;</span><br><span class="line">    <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">(x: <span class="type">Int</span>, y: <span class="type">Int</span>)</span></span>: T = <span class="keyword">data</span>[x][y]</span><br><span class="line">    <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">set</span><span class="params">(x: <span class="type">Int</span>, y: <span class="type">Int</span>, v: <span class="type">T</span>)</span></span> &#123; <span class="keyword">data</span>[x][y] = v &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">val</span> g = Grid(arrayOf(arrayOf(<span class="number">1</span>, <span class="number">2</span>), arrayOf(<span class="number">3</span>, <span class="number">4</span>)))</span><br><span class="line">	println(g[<span class="number">1</span>, <span class="number">0</span>]) <span class="comment">// ç­‰ä»·äº g.get(1, 0)</span></span><br><span class="line">	g[<span class="number">0</span>, <span class="number">1</span>] = <span class="number">9</span>      <span class="comment">// ç­‰ä»·äº g.set(0, 1, 9)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶è€Œç»†å¿ƒçš„å°ä¼™ä¼´å¯èƒ½å°±å·²æ³¨æ„åˆ°äº†ï¼šå½“æˆ‘ä»¬åœ¨ Kotlin ä¸­ä½¿ç”¨ <code>mutableMapOf&lt;K, V&gt;()</code> åœ¨åº•å±‚åˆ›å»º<code>java.util.LinkedHashMap&lt;K, V&gt;</code>æ—¶ï¼Œ Java ç±»æœ¬èº«å¹¶æ²¡æœ‰å®šä¹‰<code>set</code>æ–¹æ³•ï¼Œæˆ‘ä»¬å´ä»å¯ä»¥åœ¨ Kotlin ä¾§ç›´æ¥ç”¨ç´¢å¼•è¯­æ³•ã€‚è¿™æ˜¯å› ä¸ºå…¶å€ŸåŠ©äº† Kotlin å¦ä¸€ä¸ªå¼ºå¤§çš„åŠŸèƒ½ï¼š<strong>æ‰©å±•æ–¹æ³•</strong>ã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@kotlin</span>.<span class="keyword">internal</span>.InlineOnly  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;@kotlin.internal.OnlyInputTypes K, V&gt;</span> Map<span class="type">&lt;out K, V&gt;</span>.<span class="title">get</span><span class="params">(key: <span class="type">K</span>)</span></span>: V? =  </span><br><span class="line">    <span class="meta">@Suppress(<span class="string">&quot;UNCHECKED_CAST&quot;</span>)</span> (<span class="keyword">this</span> <span class="keyword">as</span> Map&lt;K, V&gt;).<span class="keyword">get</span>(key)  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * Allows to use the index operator for storing values in a mutable map. */</span><span class="meta">@kotlin</span>.<span class="keyword">internal</span>.InlineOnly  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;K, V&gt;</span> MutableMap<span class="type">&lt;K, V&gt;</span>.<span class="title">set</span><span class="params">(key: <span class="type">K</span>, value: <span class="type">V</span>)</span></span>: <span class="built_in">Unit</span> &#123;  </span><br><span class="line">    put(key, value)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦å¤–ï¼Œåœ¨ Kotlin&#x2F;Java äº’æ“ä½œé‡Œï¼Œ<strong>åªè¦ Java ç±»ä¸Šç¡®å®å­˜åœ¨ç¬¦åˆç­¾åçš„ <code>get(...)</code> &#x2F; <code>set(...)</code> å®ä¾‹æ–¹æ³•ï¼ŒKotlin ä¾§é€šå¸¸å°±å¯ä»¥ç›´æ¥ç”¨ <code>[]</code></strong>â€”â€”ä¸éœ€è¦åœ¨ Java é‡Œå†™ä»€ä¹ˆ <code>operator</code>ï¼ˆJava ä¹Ÿæ²¡è¿™ä¸ªå…³é”®å­—ï¼‰ã€‚Kotlin ç¼–è¯‘å™¨ä¼šæŠŠ <code>a[i]</code>&#x2F;<code>a[i]=v</code> æŒ‰â€œè¿ç®—ç¬¦çº¦å®šâ€è§£æåˆ°è¿™äº›æ–¹æ³•ä¸Šã€‚</p>
<blockquote>
<p>å…³é”®ç‚¹ </p>
</blockquote>
<ul>
<li><strong>ç´¢å¼•å‚æ•°ä¸å¿…ä¸€å®šæ˜¯ Int</strong>ï¼šMap çš„ key å°±æ˜¯æ³›å‹ <code>K</code>ã€‚</li>
<li><code>a[x, y]</code> è¿™ç§â€œå¤šå‚æ•°ç´¢å¼•â€æ˜¯åˆæ³•çš„ï¼Œæœ¬è´¨æ˜¯ <code>get(x, y)</code>ã€‚</li>
<li>è¿™æ˜¯<strong>ç¼–è¯‘æœŸè¯­æ³•ç³–</strong>ï¼šæ˜¯å¦èƒ½ç”¨ <code>[]</code>ï¼Œç”±é™æ€ç±»å‹ä¸Šæœ‰æ²¡æœ‰åŒ¹é…çš„ <code>operator get/set</code> å†³å®šã€‚</li>
</ul>
<hr>
<h2 id="2-Kotlin-æ ‡å‡†é›†åˆé‡Œ-çš„è¯­ä¹‰ï¼šMap-â‰ -List-Array"><a href="#2-Kotlin-æ ‡å‡†é›†åˆé‡Œ-çš„è¯­ä¹‰ï¼šMap-â‰ -List-Array" class="headerlink" title="2) Kotlin æ ‡å‡†é›†åˆé‡Œ [] çš„è¯­ä¹‰ï¼šMap â‰  List&#x2F;Array"></a>2) Kotlin æ ‡å‡†é›†åˆé‡Œ <code>[]</code> çš„è¯­ä¹‰ï¼šMap â‰  List&#x2F;Array</h2><p>è™½ç„¶éƒ½ç”¨ <code>[]</code>ï¼Œä½† Map ä¸ List&#x2F;Array çš„å¤±è´¥ç­–ç•¥å®Œå…¨ä¸åŒã€‚è¿™æ˜¯ Kotlin è®¾è®¡ä¸­å¾ˆé‡è¦çš„è¯­ä¹‰åŒºåˆ†ï¼Œå†™ç æ—¶ä¹Ÿéœ€è¦æ³¨æ„ã€‚</p>
<h3 id="2-1-Mapï¼šæŸ¥è¯¢è¯­ä¹‰ï¼ˆç¼ºå¤±è¿”å›-nullï¼‰"><a href="#2-1-Mapï¼šæŸ¥è¯¢è¯­ä¹‰ï¼ˆç¼ºå¤±è¿”å›-nullï¼‰" class="headerlink" title="2.1 Mapï¼šæŸ¥è¯¢è¯­ä¹‰ï¼ˆç¼ºå¤±è¿”å› nullï¼‰"></a>2.1 Mapï¼šæŸ¥è¯¢è¯­ä¹‰ï¼ˆç¼ºå¤±è¿”å› nullï¼‰</h3><p>å¯¹ <code>Map&lt;K, V&gt;</code>ï¼š</p>
<ul>
<li><code>map[key]</code> ä¼šè°ƒç”¨ <code>get(key)</code></li>
<li><strong>key ä¸å­˜åœ¨ â†’ è¿”å› <code>null</code></strong></li>
<li>å› æ­¤è¿”å›ç±»å‹é€šå¸¸æ˜¯ <strong><code>V?</code></strong></li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> m = mapOf(<span class="string">&quot;a&quot;</span> to <span class="number">1</span>)</span><br><span class="line">println(m[<span class="string">&quot;a&quot;</span>]) <span class="comment">// 1</span></span><br><span class="line">println(m[<span class="string">&quot;b&quot;</span>]) <span class="comment">// null</span></span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼šå³ä½¿ key å­˜åœ¨ï¼Œvalue ä¹Ÿå¯èƒ½æ˜¯ <code>null</code>ï¼ˆå½“ <code>V</code> å…è®¸ä¸º null æ—¶ï¼‰ã€‚æ‰€ä»¥ <code>null</code> å¯èƒ½è¡¨ç¤ºä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li>key ä¸å­˜åœ¨  </li>
<li>key å­˜åœ¨ä½† value æœ¬æ¥å°±æ˜¯ null</li>
</ol>
<p>å¦‚æœå¸Œæœ›â€œç¼º key å°±ç›´æ¥å¤±è´¥ï¼ˆæŠ›å¼‚å¸¸ç­‰ï¼‰â€ï¼Œå¸¸è§çš„å¤„ç†æ–¹å¼æ˜¯ï¼š</p>
<ul>
<li><code>map.getValue(key)</code>ï¼šç¼ºå¤±æŠ› <code>NoSuchElementException</code></li>
<li><code>requireNotNull(map[key])</code></li>
<li><code>map[key] ?: error(&quot;...&quot;)</code></li>
</ul>
<h3 id="2-2-List-Array-Stringï¼šç´¢å¼•è¯­ä¹‰ï¼ˆè¶Šç•ŒæŠ›å¼‚å¸¸ï¼‰"><a href="#2-2-List-Array-Stringï¼šç´¢å¼•è¯­ä¹‰ï¼ˆè¶Šç•ŒæŠ›å¼‚å¸¸ï¼‰" class="headerlink" title="2.2 List &#x2F; Array &#x2F; Stringï¼šç´¢å¼•è¯­ä¹‰ï¼ˆè¶Šç•ŒæŠ›å¼‚å¸¸ï¼‰"></a>2.2 List &#x2F; Array &#x2F; Stringï¼šç´¢å¼•è¯­ä¹‰ï¼ˆè¶Šç•ŒæŠ›å¼‚å¸¸ï¼‰</h3><p>å¯¹ <code>List</code>ã€<code>Array</code>ã€<code>String</code>ï¼š</p>
<ul>
<li><code>list[i]</code> &#x2F; <code>arr[i]</code> &#x2F; <code>s[i]</code> æ˜¯ä¸¥æ ¼ç´¢å¼•è®¿é—®</li>
<li><strong>è¶Šç•Œä¼šæŠ›å¼‚å¸¸</strong>ï¼ˆå¦‚ <code>IndexOutOfBoundsException</code>ã€<code>StringIndexOutOfBoundsException</code>ï¼‰</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list = listOf(<span class="number">10</span>, <span class="number">20</span>)</span><br><span class="line">println(list[<span class="number">1</span>]) <span class="comment">// 20</span></span><br><span class="line">println(list[<span class="number">2</span>]) <span class="comment">// æŠ›å¼‚å¸¸</span></span><br></pre></td></tr></table></figure>

<p>Kotlinä¹Ÿæä¾›äº†æ›´å®‰å…¨çš„æ›¿ä»£ç‰ˆæœ¬ï¼š</p>
<ul>
<li><code>getOrNull(i)</code>ï¼šè¶Šç•Œè¿”å› <code>null</code></li>
<li><code>getOrElse(i) &#123; default &#125;</code>ï¼šè¶Šç•Œè¿”å›é»˜è®¤å€¼</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">println(list.getOrNull(<span class="number">2</span>))         <span class="comment">// null</span></span><br><span class="line">println(list.getOrElse(<span class="number">2</span>) &#123; -<span class="number">1</span> &#125;)  <span class="comment">// -1</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-Setï¼šé€šå¸¸æ²¡æœ‰"><a href="#2-3-Setï¼šé€šå¸¸æ²¡æœ‰" class="headerlink" title="2.3 Setï¼šé€šå¸¸æ²¡æœ‰ []"></a>2.3 Setï¼šé€šå¸¸æ²¡æœ‰ <code>[]</code></h3><p><code>Set</code> ä¸æ”¯æŒâ€œæŒ‰ä½ç½®â€æˆ–â€œæŒ‰ keyâ€ç´¢å¼•ï¼Œå› æ­¤æ²¡æœ‰ <code>set[i]</code> è¿™ç§å½¢å¼ã€‚å¸¸ç”¨çš„æ˜¯ï¼š</p>
<ul>
<li><code>x in set</code> &#x2F; <code>set.contains(x)</code> åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨</li>
</ul>
<hr>
<h2 id="3-å’Œ-C-Java-Python-çš„-å¯¹æ¯”"><a href="#3-å’Œ-C-Java-Python-çš„-å¯¹æ¯”" class="headerlink" title="3) å’Œ C &#x2F; Java &#x2F; Python çš„ [] å¯¹æ¯”"></a>3) å’Œ C &#x2F; Java &#x2F; Python çš„ <code>[]</code> å¯¹æ¯”</h2><p><code>[]</code> æ˜¯ä¸€ä¸ªé•¿å¾—å¾ˆåƒã€ä½†åœ¨ä¸åŒè¯­è¨€é‡Œâ€œåº•å±‚æœºåˆ¶ä¸è¯­ä¹‰â€å·®åˆ«æå¤§çš„ç¬¦å·ã€‚å¦‚æœä½ åƒæˆ‘ä¸€æ ·æ—¥å¸¸éœ€è¦ç»å¸¸åœ¨ä¸åŒè¯­è¨€çš„é¡¹ç›®é—´æ¥å›åˆ‡æ¢æ—¶ï¼Œå¯èƒ½ä¼šææ··ï¼Œæˆ–è€…ç›´æ¥è®¤ä¸º Kotlinçš„ <code>[]</code> ä¸å…¶ä»–è¯­è¨€å®Œå…¨æ˜¯ä¸€ç§ä¸œè¥¿ã€‚ç„¶è€Œä»–ä»¬è™½ä¸ºåŒä¸€ä¸ªç¬¦å·ï¼Œå®é™…å´æœ‰ç€ä¸åŒçš„å¥‘çº¦ã€‚</p>
<h3 id="3-1-Kotlin-vs-Javaï¼šJava-æ²¡æœ‰é€šç”¨çš„-é‡è½½"><a href="#3-1-Kotlin-vs-Javaï¼šJava-æ²¡æœ‰é€šç”¨çš„-é‡è½½" class="headerlink" title="3.1 Kotlin vs Javaï¼šJava æ²¡æœ‰é€šç”¨çš„ [] é‡è½½"></a>3.1 Kotlin vs Javaï¼šJava æ²¡æœ‰é€šç”¨çš„ <code>[]</code> é‡è½½</h3><p>Java çš„ <code>[]</code> åªç”¨äºæ•°ç»„è®¿é—®ï¼ˆå’Œæ•°ç»„ç±»å‹è¯­æ³•ï¼‰ï¼Œä¾‹å¦‚ <code>arr[i]</code>ã€‚<br>Java <strong>ä¸èƒ½</strong>æŠŠ <code>obj[key]</code> è§£é‡Šæˆæ–¹æ³•è°ƒç”¨ï¼ˆæ²¡æœ‰è¿ç®—ç¬¦é‡è½½ï¼‰ï¼Œæ‰€ä»¥ Java ä¸­ Map è®¿é—®åªèƒ½å†™ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">map.get(key)</span><br></pre></td></tr></table></figure>

<p>è€Œ Kotlin çš„ <code>map[key]</code> å¯¹ JVM æ¥è¯´ä»ç„¶åªæ˜¯ä¸€æ¬¡ <code>get(key)</code> æ–¹æ³•è°ƒç”¨ï¼Œæ˜¯ Kotlin ç¼–è¯‘å™¨æä¾›çš„è¯­æ³•ç³–ã€‚</p>
<h3 id="3-2-Kotlin-vs-Cï¼šC-çš„-æ˜¯æŒ‡é’ˆç®—æœ¯ï¼ˆæ— è¾¹ç•Œæ£€æŸ¥ï¼‰"><a href="#3-2-Kotlin-vs-Cï¼šC-çš„-æ˜¯æŒ‡é’ˆç®—æœ¯ï¼ˆæ— è¾¹ç•Œæ£€æŸ¥ï¼‰" class="headerlink" title="3.2 Kotlin vs Cï¼šC çš„ [] æ˜¯æŒ‡é’ˆç®—æœ¯ï¼ˆæ— è¾¹ç•Œæ£€æŸ¥ï¼‰"></a>3.2 Kotlin vs Cï¼šC çš„ <code>[]</code> æ˜¯æŒ‡é’ˆç®—æœ¯ï¼ˆæ— è¾¹ç•Œæ£€æŸ¥ï¼‰</h3><p>C é‡Œ <code>a[i]</code> ç­‰ä»·äº <code>*(a + i)</code>ï¼š</p>
<ul>
<li>è¶Šç•Œé€šå¸¸æ˜¯<strong>æœªå®šä¹‰è¡Œä¸º</strong>ï¼ˆå¯èƒ½å´©æºƒï¼Œä¹Ÿå¯èƒ½æ‚„æ‚„è¯»é”™ï¼‰</li>
<li>ä¸å­˜åœ¨â€œç¼ºå¤±è¿”å› nullâ€çš„ç»Ÿä¸€çº¦å®š</li>
</ul>
<p>è€ŒKotlin çš„ List&#x2F;Array è¶Šç•Œæ˜¯<strong>å—æ§å¤±è´¥ï¼ˆæŠ›å¼‚å¸¸ï¼‰</strong>ï¼Œé”™è¯¯æ›´å¯è§ã€æ›´å¯å®šä½ã€‚</p>
<h3 id="3-3-Kotlin-vs-Pythonï¼šéƒ½â€œåƒæ–¹æ³•â€ï¼Œä½†-Kotlin-æ˜¯é™æ€çš„ã€Python-æ›´åŠ¨æ€"><a href="#3-3-Kotlin-vs-Pythonï¼šéƒ½â€œåƒæ–¹æ³•â€ï¼Œä½†-Kotlin-æ˜¯é™æ€çš„ã€Python-æ›´åŠ¨æ€" class="headerlink" title="3.3 Kotlin vs Pythonï¼šéƒ½â€œåƒæ–¹æ³•â€ï¼Œä½† Kotlin æ˜¯é™æ€çš„ã€Python æ›´åŠ¨æ€"></a>3.3 Kotlin vs Pythonï¼šéƒ½â€œåƒæ–¹æ³•â€ï¼Œä½† Kotlin æ˜¯é™æ€çš„ã€Python æ›´åŠ¨æ€</h3><p>Python çš„ï¼š</p>
<ul>
<li><code>obj[key]</code> â†’ <code>obj.__getitem__(key)</code></li>
<li><code>obj[key] = v</code> â†’ <code>obj.__setitem__(key, v)</code></li>
</ul>
<p>è¿™å’Œ Kotlin çš„â€œæ˜ å°„åˆ°æ–¹æ³•â€å¾ˆç›¸ä¼¼ï¼Œä½†å·®å¼‚éå¸¸å…³é”®ï¼š</p>
<ul>
<li><strong>åŠ¨æ€ vs é™æ€</strong>ï¼šPython åœ¨è¿è¡Œæ—¶å†³å®šè°ƒç”¨è°ï¼›Kotlin åœ¨ç¼–è¯‘æœŸç”±é™æ€ç±»å‹è§£æ <code>get/set</code>ã€‚</li>
<li><strong>åˆ‡ç‰‡è¯­æ³•</strong>ï¼šPython æœ‰å†…å»º <code>a[1:5]</code>ï¼ˆsliceï¼‰ã€‚<br>Kotlin <strong>æ²¡æœ‰å†…å»ºåˆ‡ç‰‡ <code>[]</code></strong>ï¼š<code>list[1..5]</code> é»˜è®¤ä¸è¡¨ç¤ºåˆ‡ç‰‡ï¼ˆé™¤éè‡ªå·±å®šä¹‰ <code>get(IntRange)</code>ï¼‰ã€‚</li>
<li><strong>è´Ÿæ•°ç´¢å¼•</strong>ï¼šPython <code>a[-1]</code> æ˜¯æœ€åä¸€ä¸ªå…ƒç´ ï¼›Kotlin <code>list[-1]</code> ä¼šè¶Šç•Œå¼‚å¸¸ï¼ˆæ²¡æœ‰ç‰¹æ®Šè¯­ä¹‰ï¼‰ã€‚</li>
</ul>
<h3 id="3-4-Kotlin-vs-C-ï¼šéƒ½å¯é‡è½½ï¼Œä½†å®¹å™¨é»˜è®¤è¡Œä¸ºä¸åŒ"><a href="#3-4-Kotlin-vs-C-ï¼šéƒ½å¯é‡è½½ï¼Œä½†å®¹å™¨é»˜è®¤è¡Œä¸ºä¸åŒ" class="headerlink" title="3.4 Kotlin vs C++ï¼šéƒ½å¯é‡è½½ï¼Œä½†å®¹å™¨é»˜è®¤è¡Œä¸ºä¸åŒ"></a>3.4 Kotlin vs C++ï¼šéƒ½å¯é‡è½½ï¼Œä½†å®¹å™¨é»˜è®¤è¡Œä¸ºä¸åŒ</h3><p>C++ ä¹Ÿèƒ½é‡è½½ <code>operator[]</code>ï¼Œä½†å¾ˆå¤šå®¹å™¨çš„ <code>operator[]</code> è¯­ä¹‰å¯èƒ½æ˜¯â€œç¼º key è‡ªåŠ¨æ’å…¥é»˜è®¤å€¼â€ï¼ˆå¦‚ <code>std::map</code>ï¼‰ã€‚<br>Kotlin çš„ Map <code>[]</code> <strong>ä¸ä¼šæ’å…¥</strong>ï¼Œå®ƒæ˜¯çº¯æŸ¥è¯¢ï¼›è¦å†™å…¥å¿…é¡»æ˜¾å¼è°ƒç”¨ <code>map[key] = value</code>ã€‚</p>
<hr>
<blockquote>
<p>æ³¨æ„</p>
</blockquote>
<ol>
<li><strong>List&#x2F;Array&#x2F;String çš„ <code>[]</code> è¶Šç•Œå°±æŠ›å¼‚å¸¸</strong>ï¼Œä¸åƒ C é‚£æ ·â€œå¯èƒ½æ‚„æ‚„é”™â€ã€‚  </li>
<li><strong>Kotlin æ²¡æœ‰ Python é‚£ç§å†…å»ºåˆ‡ç‰‡</strong>ï¼›<code>list[1..3]</code> ä¸æ˜¯é»˜è®¤ç”¨æ³•ã€‚  </li>
<li><strong>Kotlin çš„ <code>[]</code> è§£æçœ‹é™æ€ç±»å‹</strong>ï¼šèƒ½ä¸èƒ½ç”¨ã€ç”¨å“ªä¸ª <code>get</code>ï¼Œç¼–è¯‘æœŸå°±å†³å®šäº†ã€‚  </li>
<li><strong>Kotlin Map çš„ <code>[]</code> ä¸ä¼šåƒæŸäº› C++ å®¹å™¨é‚£æ ·è®¿é—®å³æ’å…¥</strong>ã€‚</li>
</ol>
<hr>
<h2 id="4-æ€»ç»“"><a href="#4-æ€»ç»“" class="headerlink" title="4) æ€»ç»“"></a>4) æ€»ç»“</h2><ul>
<li>Kotlin çš„ <code>[]</code> æ˜¯<strong>ç¼–è¯‘å™¨æŠŠè¯­æ³•æ”¹å†™æˆ <code>operator get/set</code> è°ƒç”¨</strong>ã€‚  </li>
<li><code>Map</code> çš„ <code>[]</code> æ˜¯â€œæŸ¥è¯¢â€ï¼Œ<strong>ç¼ºå¤±è¿”å› null</strong>ï¼›<code>List/Array/String</code> çš„ <code>[]</code> æ˜¯â€œç´¢å¼•â€ï¼Œ<strong>è¶Šç•ŒæŠ›å¼‚å¸¸</strong>ã€‚  </li>
<li>è™½ç„¶ç¬¦å·ç›¸åŒï¼Œä½†å’Œ Cï¼ˆæŒ‡é’ˆç®—æœ¯ï¼‰ã€Javaï¼ˆæ— é‡è½½ï¼‰ã€Pythonï¼ˆåŠ¨æ€ + åˆ‡ç‰‡&#x2F;è´Ÿç´¢å¼•ï¼‰ç›¸æ¯”ï¼Œ<strong>å¥‘çº¦å·®å¼‚å¾ˆå¤§</strong>ï¼Œè·¨è¯­è¨€è¿ç§»æ—¶è¦ç‰¹åˆ«ç•™æ„ã€‚</li>
</ul>
<hr>
<h3 id="é™„ï¼šè‡ªç”¨é€ŸæŸ¥"><a href="#é™„ï¼šè‡ªç”¨é€ŸæŸ¥" class="headerlink" title="é™„ï¼šè‡ªç”¨é€ŸæŸ¥"></a>é™„ï¼šè‡ªç”¨é€ŸæŸ¥</h3><table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>Kotlin å†™æ³•</th>
<th>å¤±è´¥è¡Œä¸º</th>
</tr>
</thead>
<tbody><tr>
<td>Map æŸ¥å€¼</td>
<td><code>map[key]</code></td>
<td>key ä¸å­˜åœ¨ â†’ <code>null</code></td>
</tr>
<tr>
<td>Map å¼ºåˆ¶å¿…é¡»å­˜åœ¨</td>
<td><code>map.getValue(key)</code></td>
<td>ä¸å­˜åœ¨ â†’ æŠ›å¼‚å¸¸</td>
</tr>
<tr>
<td>List&#x2F;Array ç´¢å¼•</td>
<td><code>list[i]</code> &#x2F; <code>arr[i]</code></td>
<td>è¶Šç•Œ â†’ æŠ›å¼‚å¸¸</td>
</tr>
<tr>
<td>å®‰å…¨ç´¢å¼•</td>
<td><code>list.getOrNull(i)</code></td>
<td>è¶Šç•Œ â†’ <code>null</code></td>
</tr>
<tr>
<td>Set åˆ¤æ–­å­˜åœ¨</td>
<td><code>x in set</code></td>
<td>è¿”å› <code>true/false</code></td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.eynnzerr.top/2025/09/03/old-sealed-class/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/otae.jpg">
      <meta itemprop="name" content="Eynnzerr">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eynnzerr's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/03/old-sealed-class/" class="post-title-link" itemprop="url">å¥‡å¦™çš„ Sealed</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-09-03 15:21:27 / ä¿®æ”¹æ—¶é—´ï¼š11:13:28" itemprop="dateCreated datePublished" datetime="2025-09-03T15:21:27+08:00">2025-09-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kotlin/" itemprop="url" rel="index"><span itemprop="name">Kotlin</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>2.8k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>5 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>è¯¥ç¯‡å†…å®¹ä¸ºåŸåšå®¢åšæ–‡ï¼ŒåŸä¸Šä¼ äº2023å¹´1æœˆ18æ—¥ã€‚</strong></p>
<p><strong>Sealed Class</strong>å’Œ<strong>Sealed Interface</strong>æ˜¯ kotlin å¼•å…¥çš„å…¨æ–°ç‰¹æ€§ã€‚åœ¨åˆå­¦ kotlin æ—¶ï¼Œæˆ‘å°±ä¸€ç›´æ²¡æœ‰æŒæ¡å…¶ç”¨æ³•ï¼Œç”šè‡³åˆ°ç°åœ¨ä¹Ÿä¸èƒ½åœ¨è¯¥ç”¨çš„æ—¶å€™ç«‹åˆ»æƒ³åˆ°ã€‚</p>
<p>æœ¬ç¯‡æ–‡ç« ä¸»è¦æ€»ç»“<strong>Sealed Class</strong>çš„åŸºæœ¬æ¦‚å¿µå’Œå¸¸è§ç”¨æ³•ã€‚</p>
<h3 id="ä»€ä¹ˆæ˜¯-Sealed"><a href="#ä»€ä¹ˆæ˜¯-Sealed" class="headerlink" title="ä»€ä¹ˆæ˜¯ Sealed"></a>ä»€ä¹ˆæ˜¯ Sealed</h3><p>jetbrains å¯¹ Sealed Class&#x2F;Interface çš„ä»‹ç»å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>Sealed classes and interfaces represent restricted class hierarchies that provide more control over inheritance. All direct subclasses of a sealed class are known at compile time. No other subclasses may appear outside a module within which the sealed class is defined. For example, third-party clients canâ€™t extend your sealed class in their code. Thus, each instance of a sealed class has a type from a limited set that is known when this class is compiled.</p>
<p>The same works for sealed interfaces and their implementations: once a module with a sealed interface is compiled, no new implementations can appear.</p>
<p>In some sense, sealed classes are similar to enum classes: the set of values for an enum type is also restricted, but each enum constant exists only as a single instance, whereas a subclass of a sealed class can have multiple instances, each with its own state.</p>
</blockquote>
<p>ä»ä»¥ä¸Šä»‹ç»å¯ä»¥å¤§è‡´æ€»ç»“å‡º Sealed Class&#x2F;Interface æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li><p>è¡¨ç¤ºå—é™çš„ç±»å±‚æ¬¡ç»“æ„ï¼Œå¹¶å¯ä»¥å¯¹ç»§æ‰¿æä¾›æ›´å¤šçš„æ§åˆ¶</p>
</li>
<li><p>å¯†å°ç±»çš„å­ç±»åœ¨ç¼–è¯‘æœŸå³è¢«ç¡®å®šä¸ºä¸€ä¸ªæœ‰é™çš„é›†åˆå†…ï¼Œä¸å¯æ‰©å±•</p>
</li>
<li><p>å¯†å°ç±»çš„å­ç±»åªèƒ½ä½äºå®šä¹‰äº†è¯¥å¯†å°ç±»çš„<strong>åŒ…</strong>ä¸­</p>
</li>
<li><p>å¯†å°ç±»çš„å­ç±»å¯ä»¥æœ‰å¤šä¸ªå®ä¾‹</p>
</li>
</ul>
<p>ä»‹ç»ä¸­è¿˜æåˆ°ï¼Œsealed class å’Œ enum class åœ¨æŸç§æ„ä¹‰ä¸Šæ˜¯ç±»ä¼¼çš„ï¼Œå®é™…ä¸Šï¼Œsealed class è¯ç”Ÿçš„é‡è¦åŸå› ä¹‹ä¸€æ­£æ˜¯ä¸ºäº†å…‹æœ enum class åœ¨æŸäº›åœºåˆä¸‹çš„å±€é™æ€§ï¼Œä¹Ÿå³ä¸Šè¿°ç‰¹æ€§çš„ç¬¬ä¸€ç‚¹å’Œç¬¬å››ç‚¹ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œæšä¸¾ç±»æœ‰ä¸¤ä¸ªç‰¹æ€§ï¼Œåœ¨æŸäº›åœºåˆä¸‹æ˜¯ä¼˜ç‚¹ï¼Œä½†åœ¨å¦å¤–ä¸€äº›åœºåˆä¸‹å´å¯èƒ½æˆä¸ºç¼ºç‚¹ï¼š</p>
<ul>
<li><p>æ¯ä¸ªæšä¸¾ç±»å‹åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹ï¼ˆç§°ä¸ºæšä¸¾å¸¸é‡ï¼‰</p>
</li>
<li><p>å„æšä¸¾å¸¸é‡åªèƒ½ä½¿ç”¨ç›¸åŒç±»å‹çš„å±æ€§</p>
</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title class_">Drink</span>(<span class="keyword">val</span> id: <span class="built_in">Int</span>) &#123;</span><br><span class="line">    Milk(<span class="number">1</span>),</span><br><span class="line">    Coffee(<span class="number">2</span>),</span><br><span class="line">    Water(<span class="number">3</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å¦‚ä¸Šæˆ‘ä»¬åˆ›å»ºçš„æšä¸¾ç±»ä¸­ï¼Œå„å­ç±»ï¼ˆMilkï¼ŒCoffeeï¼ŒWaterï¼‰æ— è®ºæœ‰å¤šå°‘å¯¹è±¡ï¼Œéƒ½åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹ï¼ˆå³å•ä¾‹çš„æšä¸¾å¸¸é‡ï¼‰ï¼Œä¸”å…¶å±æ€§å‡åªèƒ½ä¸ºæšä¸¾ç±»ä¸­å®šä¹‰çš„ Int ç±»å‹ã€‚</p>
<p>è€Œå¯†å°ç±»åˆ™å–æ¶ˆäº†ä»¥ä¸Šé™åˆ¶ï¼Œå…è®¸å¯†å°ç±»çš„å­ç±»å…·æœ‰å¤šä¸ªå®ä¾‹ï¼Œä¸”å„å­ç±»å¯ä»¥å®šä¹‰è‡ªå·±çš„å±æ€§ã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title class_">Drink</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œç›´æ¥åœ¨å®šä¹‰å—å†…å®šä¹‰å­ç±»</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Milk</span>(<span class="keyword">val</span> id: <span class="built_in">Int</span>): Drink()</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Coffee</span>(<span class="keyword">val</span> id: <span class="built_in">Double</span>): Drink()</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Water</span>(<span class="keyword">val</span> id: String): Drink()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚ä¸Šï¼Œå¯†å°ç±»å…è®¸å„å­ç±»å…·æœ‰ä¸åŒç±»å‹çš„å±æ€§ï¼Œåªéœ€è¦åœ¨å­ç±»çš„ä¸»æ„é€ å‡½æ•°ä¸­å£°æ˜å³å¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯†å°ç±»åœ¨ç»§æ‰¿ä¸Šçš„å†™æ³•ä¸æŠ½è±¡ç±»åŒºåˆ«è¾ƒå¤§ï¼Œåè€Œæ›´åŠ ç±»ä¼¼äºä¸€èˆ¬çš„æŠ½è±¡ç±»ã€‚å®é™…ä¸Šï¼Œå¯†å°ç±»æ­£æ˜¯æŠ½è±¡çš„ï¼Œä¸èƒ½ç›´æ¥ç”Ÿæˆå®ä¾‹ï¼Œä¸”å¯ä»¥å…·æœ‰æŠ½è±¡æˆå‘˜ã€‚å› æ­¤ï¼Œå¯†å°ç±»å¯ä»¥åƒä¸Šè¿°å†™æ³•ä¸€æ ·å®šä¹‰ç»§æ‰¿è‡ªå¯†å°ç±»çš„å­ç±»ï¼Œä¹Ÿå¯ä»¥ç”¨<code>object</code>ç›´æ¥å®šä¹‰å­ç±»å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥å†ç”¨<code>sealed class</code>ï¼Œå³å¯†å°ç±»ç»§æ‰¿å¯†å°ç±»ï¼Œå®ç°æ›´åŠ ç»†ç²’åº¦çš„ç±»å±‚æ¬¡ç»“æ„ã€‚</p>
<p>å„å­ç±»å…è®¸æœ‰å¤šä¸ªä¸åŒçŠ¶æ€çš„å®ä¾‹ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> milk1 = Drink.Milk(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">val</span> milk2 = Drink.Milk(<span class="number">2</span>)</span><br><span class="line">println(milk1.id)</span><br><span class="line">println(milk2.id)</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ç‰¹æ€§çš„ç¬¬äºŒç‚¹æ„ä¹‰åœ¨äºï¼Œå¯†å°ç±»å¯¹è¿è¡Œæ—¶çš„æ‰©å±•æ˜¯å°é—­çš„ã€‚ç¨‹åºåœ¨ç¼–è¯‘æ—¶ï¼Œå³å¯é€šè¿‡ç»§æ‰¿å…³ç³»ç¡®è®¤å¯†å°ç±»çš„å…¨éƒ¨å­ç±»ï¼Œç”±æ­¤äº§ç”Ÿäº†å¯†å°ç±»ä¸€ä¸ªéå¸¸å®ç”¨çš„ç”¨å¤„ï¼Œåœ¨å†™ when è¯­å¥æ—¶ä¸éœ€è¦æ·»åŠ  else åˆ†æ”¯ï¼Œå› ä¸ºå…¨éƒ¨å¯èƒ½çš„åˆ†æ”¯åœ¨ç¼–è¯‘æ—¶å³å¯ç¡®å®šï¼Œæ²¡æœ‰å…¶ä»–æƒ…å†µï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">(drink: <span class="type">Drink</span>)</span></span> = <span class="keyword">when</span> (drink) &#123;</span><br><span class="line">    <span class="keyword">is</span> Drink.Milk -&gt; println(<span class="string">&quot;milk&quot;</span>)</span><br><span class="line">    <span class="keyword">is</span> Drink.Coffee -&gt; println(<span class="string">&quot;coffee&quot;</span>)</span><br><span class="line">    <span class="keyword">is</span> Drink.Water -&gt; println(<span class="string">&quot;water&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ç‰¹æ€§çš„ç¬¬ä¸‰ç‚¹æ„ä¹‰åœ¨äºï¼Œé™åˆ¶äº†å¯†å°ç±»çš„ä½œç”¨ç©ºé—´ï¼Œå¹¶ä¸”éšç€ kotlin ç‰ˆæœ¬çš„æ›´è¿­è¶Šæ¥è¶Šå®½æ¾ï¼šä»åªèƒ½åœ¨ sealed class å†…ï¼Œåˆ° 1.1 æ”¯æŒåŒä¸€æ–‡ä»¶å†…ï¼Œåˆ° 1.5 æ”¯æŒåŒä¸€åŒ…ä¸‹ã€‚</p>
<h3 id="æ€ä¹ˆç”¨-Sealed"><a href="#æ€ä¹ˆç”¨-Sealed" class="headerlink" title="æ€ä¹ˆç”¨ Sealed"></a>æ€ä¹ˆç”¨ Sealed</h3><p>kotlin åˆå­¦è€…å¾€å¾€ä¼šæŠŠ<code>sealed class</code>å½“åš<code>enum class</code>ç”¨ï¼Œä½†<code>enum class</code>å…·æœ‰å¾ˆæ˜æ˜¾çš„é€‚ç”¨åœºæ™¯ï¼Œè¿™ä¹ˆåšæ˜¯ä¸åˆé€‚çš„ã€‚æ¯”å¦‚ï¼Œä½ ä»…éœ€è¦ä¸€ç³»åˆ—ç›¸åŒç±»å‹çš„å•ä¾‹ï¼Œä¸”ä¸éœ€è¦ä»»ä½•é¢å¤–æè¿°ï¼Œä¹Ÿä¸éœ€è¦ç‰¹æ®Šçš„å‡½æ•°ï¼Œé‚£ä¹ˆç”¨æšä¸¾å°±è¶³å¤Ÿäº†ï¼Œæ¯”å¦‚åœ¨æˆ‘çš„ã€Šè®¾è®¡æ¨¡å¼ä¹‹çŠ¶æ€æ¨¡å¼ã€‹ä¸­ï¼Œå„çŠ¶æ€æœ‰ç»Ÿä¸€çš„å¤„ç†æ–¹æ³•ï¼Œç”¨æšä¸¾æ¥è¡¨ç¤ºã€‚</p>
<p>åœ¨ Android å¼€å‘ä¸­ï¼Œ <code>sealed class</code>æœ‰å¦‚ä¸‹ä¸€äº›ä½¿ç”¨åœºæ™¯ï¼š</p>
<ul>
<li><p>åˆ—è¡¨æœ‰ä¸åŒç±»å‹çš„å­é¡¹ï¼ˆæ–‡å­—ã€å›¾ç‰‡ï¼‰ï¼Œç”¨å¯†å°ç±»è¡¨ç¤ºåˆ—è¡¨çš„ item</p>
</li>
<li><p>å°è£…ç½‘ç»œè¯·æ±‚ä¸­æˆåŠŸï¼ˆå«æœ‰ä»»æ„ç±»å‹çš„è¯·æ±‚æ•°æ®ï¼‰å’Œå¤±è´¥ï¼ˆå«æœ‰å¤±è´¥ä¿¡æ¯ï¼Œå¦‚å¼‚å¸¸ï¼‰è¿”å›çš„æ•°æ®</p>
</li>
<li><p>ä½¿ç”¨<code>object</code>è¾¾åˆ°ä¸æšä¸¾ç±»ä¼¼çš„æ•ˆæœï¼ˆè™½ç„¶åœ¨ google çš„å®˜æ–¹ç¤ºä¾‹éƒ½å‡ºç°äº†è¿™ç§ç”¨æ³•ï¼Œä½†è¿˜æ˜¯ä¸æ¨èã€‚ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨æšä¸¾å‘¢ï¼Ÿï¼‰</p>
</li>
<li><p>å…¶ä»–ä¸€åˆ‡ä¸æ»¡è¶³æšä¸¾çš„åº”ç”¨åœºæ™¯ï¼Œä½†éœ€è¦ä¸æšä¸¾ç±»ä¼¼æ•ˆæœï¼Œå¯ä»¥è€ƒè™‘ç”¨å¯†å°ç±»</p>
</li>
</ul>
<h3 id="å…³äº-Sealed-Interface"><a href="#å…³äº-Sealed-Interface" class="headerlink" title="å…³äº Sealed Interface"></a>å…³äº Sealed Interface</h3><p>ä»¥ä¸Šéƒ½åœ¨è®¨è®º<code>sealed class</code>ï¼Œè€Œ<code>sealed interface</code>ä½œä¸º kotlin1.5 ä¸­ç™»åœºçš„æ–°ç‰¹æ€§ï¼Œä¹Ÿå€¼å¾—è¯´é“è¯´é“ã€‚</p>
<p>å¯†å°æ¥å£è¿›ä¸€æ­¥è¡¥è¶³äº†å¯†å°ç±»å’Œæšä¸¾ç±»çš„ä¸€äº›ä¸è¶³ä¹‹å¤„ï¼Œå¦‚æšä¸¾ç±»ç¼–è¯‘åç»§æ‰¿è‡ª<code>Enum</code>ï¼Œç”±äºå•ç»§æ‰¿ä¸èƒ½å†ç»§æ‰¿å…¶ä»–ç±»ï¼Œæ­¤æ—¶å¯ä»¥ç”¨å¯†å°æ¥å£ï¼Œå¯¹æšä¸¾ç±»åšè¿›ä¸€æ­¥åˆ’åˆ†ã€‚å½“ç„¶ç›´æ¥ç”¨åµŒå¥—å¯†å°ç±»ä¹Ÿæœªå°ä¸å¯ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.eynnzerr.top/2025/09/02/old-scope-function/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/otae.jpg">
      <meta itemprop="name" content="Eynnzerr">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eynnzerr's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/02/old-scope-function/" class="post-title-link" itemprop="url">Scope Function é€Ÿè®°é€ŸæŸ¥</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-09-02 10:06:25" itemprop="dateCreated datePublished" datetime="2025-09-02T10:06:25+08:00">2025-09-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2026-01-30 12:40:01" itemprop="dateModified" datetime="2026-01-30T12:40:01+08:00">2026-01-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kotlin/" itemprop="url" rel="index"><span itemprop="name">Kotlin</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>3.4k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>6 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>è¯¥ç¯‡å†…å®¹ä¸ºåŸåšå®¢åšæ–‡ï¼ŒåŸä¸Šä¼ äº2021å¹´11æœˆ29æ—¥ã€‚</strong></p>
<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>kotlinæ˜¯ä¸€æ¬¾ååˆ†çµæ´»è€Œåˆå¼ºå¤§çš„è¯­è¨€ã€‚åˆç†åœ°è¿ç”¨kotlinçš„ä¸€äº›ç‰¹æ€§ï¼Œå¯ä»¥æå¤§åœ°æé«˜ä»£ç å¯è¯»æ€§å’Œè´¨é‡ï¼Œæé«˜æ•ˆç‡ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥è¯´ä¸€è¯´kotlinä¸­çš„<strong>scope function</strong>ã€‚</p>
<h1 id="åŸŸå‡½æ•°"><a href="#åŸŸå‡½æ•°" class="headerlink" title="åŸŸå‡½æ•°"></a>åŸŸå‡½æ•°</h1><p>æˆ‘ä»¬ä¸»è¦ä»‹ç»<strong>let, also, with, run, apply</strong>è¿™äº”ç§å¸¸ç”¨çš„åŸŸå‡½æ•°ã€‚</p>
<h3 id="1-let"><a href="#1-let" class="headerlink" title="(1)let"></a>(1)let</h3><p>å…ˆä¸Šletå‡½æ•°çš„æºç ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T, R&gt;</span> T.<span class="title">let</span><span class="params">(block: (<span class="type">T</span>) -&gt; <span class="type">R</span>)</span></span>: R &#123;</span><br><span class="line">    contract &#123;</span><br><span class="line">        callsInPlace(block, InvocationKind.EXACTLY_ONCE)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> block(<span class="keyword">this</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»æºç æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œé¦–å…ˆï¼Œletæ˜¯å¯¹è°ƒç”¨è€…çš„æ‰©å±•å‡½æ•°ã€‚å…¶æ¬¡ï¼Œletå‡½æ•°æ¥æ”¶ä¸€ä¸ªlambdaè¡¨è¾¾å¼blockä½œä¸ºå”¯ä¸€å‚æ•°ï¼Œä¸”å°†è°ƒç”¨è€…æœ¬èº«ä½œä¸ºå‚æ•°ä¼ ç»™äº†lambdaã€‚è€Œåœ¨å‡½æ•°çš„å†…éƒ¨ï¼Œé¦–å…ˆä½¿ç”¨contractè¿›è¡Œçº¦æŸï¼Œå‘ç¼–è¯‘å™¨è¡¨æ˜è¿™ä¸ªlambdaåªä¼šæ‰§è¡Œä¸€æ¬¡ï¼ˆEXACTLY_ONCEï¼‰ï¼Œæ¥ç€å°±æ˜¯è°ƒç”¨lambdaå¹¶è¿”å›å…¶è¿”å›å€¼ã€‚<br>è¿›è€Œï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºå¦‚ä¸‹ç»“è®ºï¼š</p>
<ol>
<li>ç”±äºletå‡½æ•°å°†è°ƒç”¨è€…ä½œä¸ºlambdaçš„å‚æ•°ï¼Œå› è€Œåœ¨leté—­åŒ…å†…ï¼Œå¯ä»¥ç”¨<strong>it</strong>æŒ‡ä»£è°ƒç”¨è€…ï¼›</li>
<li>letå‡½æ•°æ˜¯å…·æœ‰è¿”å›å€¼çš„ï¼Œä¸”å…¶è¿”å›å€¼åº”ä¸ºlambdaè¡¨è¾¾å¼ä¸­çš„æœ€åä¸€è¡Œ&#x2F;returnè¯­å¥ã€‚</li>
</ol>
<p>éšä¹‹ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°letå‡½æ•°çš„ä½œç”¨ï¼š</p>
<ol>
<li>åœ¨æ˜ç¡®æŸä¸€å¯¹è±¡å®ä¾‹åœ¨ä¸€å®šèŒƒå›´å†…éœ€è¦ä½¿ç”¨æ—¶ï¼Œå¯ä»¥å¯¹å…¶è°ƒç”¨letï¼Œå†ç”¨itæŒ‡ä»£ï¼›</li>
<li>ï¼ˆå¸¸ç”¨ï¼‰å¯¹æŸä¸€å¯èƒ½ä¸ºç©ºçš„å¯¹è±¡è¿›è¡Œç»Ÿä¸€åˆ¤ç©ºçš„å¤„ç†ã€‚</li>
</ol>
<p>è¿™é‡Œå¯¹ä½œç”¨äºŒä½œä¸€äº›è§£é‡Šã€‚å¯¹äºä¸€ä¸ªå¯èƒ½ä¸ºç©ºçš„å¯¹è±¡objectï¼Œå¦‚æœä¸ä½¿ç”¨letï¼Œæ¯æ¬¡è°ƒç”¨å…¶æ–¹æ³•æˆ–å±æ€§æ—¶ï¼Œéƒ½è¦åŠ ä¸Š?æˆ–è€…!!ï¼Œä»¥åŠç±»ä¼¼if not nullçš„åˆ¤ç©ºé€»è¾‘ã€‚ä½†å¦‚æœä½¿ç”¨letï¼Œä»£ç å°±å°†ç®€åŒ–ä¸ºå¦‚ä¸‹çš„å½¢å¼ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span>?.let &#123;</span><br><span class="line">    it.doSomething()</span><br><span class="line">    it.id = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šä»£ç è¡¨ç¤ºï¼Œåªæœ‰å½“objectä¸ä¸ºç©ºæ—¶ï¼Œæ‰ä¼šæ‰§è¡Œletä¸­çš„é€»è¾‘ï¼Œä¸”ç”±äºåˆ¤ç©ºäº¤ç»™äº†objectåçš„?ç¬¦æ¥å¤„ç†ï¼Œletå†…éƒ¨ä¸å†éœ€è¦ä»»ä½•å¤šä½™çš„åˆ¤ç©ºã€‚å¦‚æ­¤ä»¥æ¥ï¼Œåˆ¤ç©ºå°±å˜å¾—ä¼˜é›…äº†è®¸å¤šã€‚</p>
<h3 id="2-also"><a href="#2-also" class="headerlink" title="(2)also"></a>(2)also</h3><p>å…ˆä¸Šalsoå‡½æ•°çš„æºç ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> T.<span class="title">also</span><span class="params">(block: (<span class="type">T</span>) -&gt; <span class="type">Unit</span>)</span></span>: T &#123;</span><br><span class="line">    contract &#123;</span><br><span class="line">        callsInPlace(block, InvocationKind.EXACTLY_ONCE)</span><br><span class="line">    &#125;</span><br><span class="line">    block(<span class="keyword">this</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»æºç å¯è§ï¼Œalsoå‡½æ•°çš„å®ç°æ€è·¯ä¸letç±»ä¼¼ï¼Œéƒ½æ˜¯å¯¹è°ƒç”¨è€…çš„æ‰©å±•ï¼Œéƒ½æ˜¯å°†è°ƒç”¨è€…ä½œä¸ºå‚æ•°ä¼ ç»™lambdaï¼Œéƒ½ä½¿ç”¨contractè¿›è¡Œè°ƒç”¨çº¦æŸï¼Œéƒ½ä¼šåœ¨å†…éƒ¨æ‰§è¡Œlambdaã€‚ä½†æœ‰å¦‚ä¸‹ä¸åŒï¼šlambdaæ²¡æœ‰è¿”å›å€¼ï¼Œè€Œä»returnè¯­å¥çœ‹ï¼Œalsoè¿”å›çš„æ˜¯è°ƒç”¨è€…æœ¬èº«ã€‚<br>è¿›è€Œï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºå¦‚ä¸‹ç»“è®ºï¼š</p>
<ol>
<li>alsoå‡½æ•°çš„åº”ç”¨åœºæ™¯ä¸letç›¸åŒï¼›</li>
<li>alsoå‡½æ•°è¿”å›å€¼ä¸ºè°ƒç”¨è€…æœ¬èº«ã€‚</li>
</ol>
<h3 id="3-with"><a href="#3-with" class="headerlink" title="(3)with"></a>(3)with</h3><p>å…ˆä¸Šwithå‡½æ•°çš„æºç ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T, R&gt;</span> <span class="title">with</span><span class="params">(receiver: <span class="type">T</span>, block: <span class="type">T</span>.() -&gt; <span class="type">R</span>)</span></span>: R &#123;</span><br><span class="line">    contract &#123;</span><br><span class="line">        callsInPlace(block, InvocationKind.EXACTLY_ONCE)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> receiver.block()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶æºç çš„æ•´ä½“é£æ ¼å’Œä¹‹å‰ä¸¤è€…ç±»ä¼¼ï¼Œä½†å…¶ä½¿ç”¨æ–¹æ³•å´æˆªç„¶ä¸åŒã€‚é¦–å…ˆï¼Œwithæ˜¯ä¸€ä¸ªé€šç”¨çš„æ‰©å±•å‡½æ•°ï¼Œå…¶æœ‰ä¸¤ä¸ªå‚æ•°ï¼šreceiverï¼Œå’Œä¸€ä¸ªlambdaã€‚æ³¨æ„è¿™é‡Œlambdaçš„å‚æ•°æ˜¯T.()ï¼Œå®ƒè¡¨æ˜å°†è¿™ä¸ªlambdaå‡½æ•°ä½œä¸ºåŒä¸ºç±»å‹Tçš„receiverçš„ä¸€ä¸ªæ‰©å±•å‡½æ•°ï¼Œä»è€Œèƒ½è¢«receiveræ‰€è°ƒç”¨ã€‚è¿›è€Œï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºå¦‚ä¸‹ç»“è®ºï¼š</p>
<ol>
<li>ç”±äºwithå†…éƒ¨æ˜¯é€šè¿‡æ‰©å±•å‡½æ•°ä½¿å¾—receiverå»è°ƒç”¨lambdaï¼Œå› è€Œå¯ä»¥åœ¨lambdaçš„é—­åŒ…å†…éƒ¨ç›´æ¥è®¿é—®receiverçš„publicæ–¹æ³•&#x2F;å±æ€§ã€‚ï¼ˆå³æ²¡æœ‰itç­‰é—´æ¥æŒ‡ä»£å€¼ï¼‰</li>
<li>withå‡½æ•°æ˜¯å…·æœ‰è¿”å›å€¼çš„ã€‚ä»æºç çš„returnè¯­å¥å¯ä»¥çœ‹å‡ºï¼Œå…¶è¿”å›çš„æ˜¯lambdaè¡¨è¾¾å¼çš„æœ€åä¸€è¡Œ&#x2F;returnè¯­å¥ã€‚</li>
</ol>
<p>éšä¹‹ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°withå‡½æ•°çš„ä½œç”¨ï¼š<br>åœ¨éœ€è¦å¤šæ¬¡è°ƒç”¨æŸä¸€å¯¹è±¡çš„æ–¹æ³•æˆ–å±æ€§æ—¶ï¼Œå¯ä»¥å°†è¯¥å¯¹è±¡ä¼ ç»™withï¼Œå†åœ¨withå†…éƒ¨å¤„ç†ç›¸åº”é€»è¾‘ã€‚è¿™æ ·å†™å¯ä»¥é¿å…å¤šæ¬¡é‡å¤åœ°å†™è¯¥å¯¹è±¡ã€‚<br>ä¸¾ä¸ªæ —å­ï¼šå½“æˆ‘ä»¬æƒ³å†™ä¸€ä¸ªalertDialogæ—¶ï¼Œéœ€è¦å…ˆåˆ›å»ºbuilderï¼Œå¯¹builderè¿›è¡Œä¸€ç³»åˆ—é…ç½®ï¼Œå†è°ƒç”¨builderçš„create()æ–¹æ³•è¿”å›ä¸€æ¡alertDialogã€‚æœ‰äº†withåï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> alertDialog: AlertDialog</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> builder = AlertDialog.Builder(activity)</span><br><span class="line">alertDialog = with (builder) &#123;</span><br><span class="line">    <span class="keyword">val</span> alertView = layoutInflater.inflate(R.layout.dialog_confirm, <span class="literal">null</span>, <span class="literal">false</span>)</span><br><span class="line">    setView(alertView)</span><br><span class="line">    setNegativeButton(<span class="string">&quot;å–æ¶ˆ&quot;</span>) &#123; dialog, which -&gt;</span><br><span class="line">        Toast.makeText(activity, <span class="string">&quot;å·²å–æ¶ˆ&quot;</span>, Toast.LENGTH_SHORT).show()</span><br><span class="line">    &#125;</span><br><span class="line">    setPositiveButton(<span class="string">&quot;ç¡®å®š&quot;</span>) &#123; dialog, which -&gt;</span><br><span class="line">        run &#123;</span><br><span class="line">            bill?.let &#123; it1 -&gt; viewModel.deleteBill(it1) &#125;</span><br><span class="line">            activity?.onBackPressed()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    create()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ˜¯ä¸æ˜¯ç®€æ´äº†è®¸å¤šï¼Ÿ</p>
<h3 id="4-run"><a href="#4-run" class="headerlink" title="(4)run"></a>(4)run</h3><p>è¿˜æ˜¯å…ˆä¸Šæºç ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;R&gt;</span> <span class="title">run</span><span class="params">(block: () -&gt; <span class="type">R</span>)</span></span>: R &#123;</span><br><span class="line">    contract &#123;</span><br><span class="line">        callsInPlace(block, InvocationKind.EXACTLY_ONCE)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> block()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T, R&gt;</span> T.<span class="title">run</span><span class="params">(block: <span class="type">T</span>.() -&gt; <span class="type">R</span>)</span></span>: R &#123;</span><br><span class="line">    contract &#123;</span><br><span class="line">        callsInPlace(block, InvocationKind.EXACTLY_ONCE)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> block()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>runæœ‰ç‚¹ç±»ä¼¼letå’Œwithçš„ç»“åˆä½“ï¼Œç»§æ‰¿äº†ä¸¤è€…å„è‡ªçš„ä¼˜ç‚¹ï¼Œå› è€Œä½¿ç”¨åœºæ™¯ååˆ†å¹¿æ³›ï¼šé¦–å…ˆï¼Œå®ƒåƒletä¸€æ ·æ˜¯å¯¹è°ƒç”¨è€…çš„æ‰©å±•ï¼Œå› è€Œå¯ä»¥<strong>ç»Ÿä¸€åˆ¤ç©ºå¤„ç†</strong>ï¼›å…¶æ¬¡ï¼Œå®ƒåˆåƒwithä¸€æ ·ï¼Œä¼ å…¥lambdaçš„æ˜¯T.()ï¼Œè¡¨æ˜å®ƒå¯ä»¥åƒwithä¸€æ ·<strong>åœ¨é—­åŒ…å†…ç›´æ¥è®¿é—®æ–¹æ³•&#x2F;å±æ€§</strong>ã€‚æœ€åï¼Œå®ƒè¿”å›çš„æ˜¯lambdaçš„è¿”å›å€¼ã€‚</p>
<h3 id="5-apply"><a href="#5-apply" class="headerlink" title="(5)apply"></a>(5)apply</h3><p>ä¸Šæºç ã€‚ã€‚ã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> T.<span class="title">apply</span><span class="params">(block: <span class="type">T</span>.() -&gt; <span class="type">Unit</span>)</span></span>: T &#123;</span><br><span class="line">    contract &#123;</span><br><span class="line">        callsInPlace(block, InvocationKind.EXACTLY_ONCE)</span><br><span class="line">    &#125;</span><br><span class="line">    block()</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸éš¾çœ‹å‡ºï¼Œapplyå’Œrunç±»ä¼¼äºalsoå’Œletçš„å…³ç³»ï¼Œä½¿ç”¨åœºæ™¯ç±»ä¼¼ï¼Œåªæ˜¯è¿”å›å€¼æœ‰å·®å¼‚ã€‚<br>è€Œç”±äºapplyè¿”å›çš„æ˜¯è°ƒç”¨è€…æœ¬èº«ï¼Œå› è€Œå®ƒååˆ†é€‚åˆç”¨æ¥åšå˜é‡çš„åˆå§‹åŒ–ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><table>
<thead>
<tr>
<th align="center">å‡½æ•°å</th>
<th align="center">ç‰¹ç‚¹</th>
<th align="center">ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td align="center">let</td>
<td align="center">1.åœ¨æŒ‡å®šåŸŸå†…å®šä¹‰å˜é‡it 2.è¿”å›æœ€åä¸€è¡Œ</td>
<td align="center">ç»Ÿä¸€åˆ¤ç©ºå¤„ç†</td>
</tr>
<tr>
<td align="center">also</td>
<td align="center">1.åœ¨æŒ‡å®šåŸŸå†…å®šä¹‰å˜é‡it 2.è¿”å›ä¼ å…¥å¯¹è±¡æœ¬èº«</td>
<td align="center">ç»Ÿä¸€åˆ¤ç©ºå¤„ç†</td>
</tr>
<tr>
<td align="center">with</td>
<td align="center">1.ç›´æ¥è®¿é—®æ–¹æ³•å’Œå±æ€§ 2.è¿”å›æœ€åä¸€è¡Œ</td>
<td align="center">å¤šæ¬¡è°ƒç”¨æ—¶çœå»å˜é‡å</td>
</tr>
<tr>
<td align="center">run</td>
<td align="center">1.letå’Œwithçš„ç»“åˆ 2.è¿”å›æœ€åä¸€è¡Œ</td>
<td align="center">ç»Ÿä¸€åˆ¤ç©ºçš„åŒæ—¶çœå»itï¼Œçœå»å˜é‡åçš„åŒæ—¶åˆ¤ç©º</td>
</tr>
<tr>
<td align="center">apply</td>
<td align="center">1.åŒrun 2.è¿”å›ä¼ å…¥å¯¹è±¡æœ¬èº«</td>
<td align="center">åŒrunï¼Œæ­¤å¤–é€‚ç”¨äºåˆå§‹åŒ–å˜é‡</td>
</tr>
</tbody></table>
<p>ä½œè€…çº¯kotlinå°ç™½ï¼Œå¦‚æœ‰ç–æ¼ä¸é”™è¯¯ï¼Œæ•¬è¯·å¤§ä½¬æŒ‡æ­£ï¼</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.eynnzerr.top/2025/09/01/old-data-lab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/otae.jpg">
      <meta itemprop="name" content="Eynnzerr">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eynnzerr's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/09/01/old-data-lab/" class="post-title-link" itemprop="url">ã€ŠCSAPPã€‹â€”â€” Data Lab</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-09-01 10:53:37" itemprop="dateCreated datePublished" datetime="2025-09-01T10:53:37+08:00">2025-09-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-03 11:03:44" itemprop="dateModified" datetime="2025-09-03T11:03:44+08:00">2025-09-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CSAPP/" itemprop="url" rel="index"><span itemprop="name">CSAPP</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CSAPP/C-C/" itemprop="url" rel="index"><span itemprop="name">C/C++</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>18 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>è¯¥ç¯‡å†…å®¹ä¸ºåŸåšå®¢åšæ–‡ï¼ŒåŸä¸Šä¼ äº2022å¹´4æœˆ30æ—¥ã€‚</strong></p>
<p>è¯è¯´ä»å¯’å‡å¼€å§‹åŠæ‘¸åŠè¯»ã€ŠCS:APPã€‹ï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰å†™Labã€‚éƒ½è¯´9ä¸ªLabæ˜¯å…¨ä¹¦çš„ç²¾åï¼Œå› æ­¤æ·±æ„Ÿæœ‰å¿…è¦åšä¸€ä¸‹ï¼Œæ‰€ä»¥å‰é˜µå­æŠ½ç©ºå…ˆæŠŠDataLabåšäº†ã€‚è™½è¯´æ˜¯ç¬¬ä¸€ä¸ªï¼ˆ<del>æ®è¯´ä¹Ÿæ˜¯æœ€ç®€å•çš„</del>ï¼‰Labï¼Œå´ä¹Ÿåšçš„ç£•ç£•ç»Šç»Šï¼Œæ·±æ„Ÿè‡ªå·±ç åŠ›ä¸è¶³ã€‚æ€»ä¹‹æœ€åæ˜¯å®Œæˆäº†ï¼Œè¿˜æ˜¯å†™ç¯‡åšå®¢è®°å½•ä¸€ä¸‹ï¼Œä¹Ÿæ–¹ä¾¿è‡ªå·±æ—¥åreviewã€‚</p>
<h3 id="1åˆ†é¢˜"><a href="#1åˆ†é¢˜" class="headerlink" title="1åˆ†é¢˜"></a>1åˆ†é¢˜</h3><p>1åˆ†é¢˜åŸºæœ¬éƒ½æ˜¯ç­¾åˆ°é¢˜ï¼Œéš¾åº¦ä¸å¤§ã€‚</p>
<h5 id="bitXor"><a href="#bitXor" class="headerlink" title="bitXor"></a>bitXor</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * bitXor - x^y using only ~ and &amp; </span></span><br><span class="line"><span class="comment"> *   Example: bitXor(4, 5) = 1</span></span><br><span class="line"><span class="comment"> *   Legal ops: ~ &amp;</span></span><br><span class="line"><span class="comment"> *   Max ops: 14</span></span><br><span class="line"><span class="comment"> *   Rating: 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">bitXor</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> ~(~(~x&amp;y)&amp;~(x&amp;~y));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åªä½¿ç”¨ä½ä¸å’Œä½éå®ç°ä½æˆ–ï¼Œè¿ç”¨<strong>De Morganâ€™s laws</strong>å°±è¡Œäº†ã€‚</p>
<h5 id="tmin"><a href="#tmin" class="headerlink" title="tmin"></a>tmin</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * tmin - return minimum two&#x27;s complement integer </span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 4</span></span><br><span class="line"><span class="comment"> *   Rating: 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">tmin</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0x1</span> &lt;&lt; <span class="number">31</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿”å›è¡¥ç è¡¨ç¤ºçš„æœ€å°æ•°ï¼Œå³0x8000_8000ï¼Œä¹Ÿå³<code>int</code>ç±»å‹èƒ½è¡¨ç¤ºçš„æœ€å°æ•°ï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¥½è¯´çš„ã€‚</p>
<h3 id="2åˆ†é¢˜"><a href="#2åˆ†é¢˜" class="headerlink" title="2åˆ†é¢˜"></a>2åˆ†é¢˜</h3><p>å¼€å§‹æœ‰äº›æŠ€å·§æ€§çš„æ“ä½œå‡ºç°äº†ã€‚</p>
<h5 id="isTmax"><a href="#isTmax" class="headerlink" title="isTmax"></a>isTmax</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * isTmax - returns 1 if x is the maximum, two&#x27;s complement number,</span></span><br><span class="line"><span class="comment"> *     and 0 otherwise </span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | +</span></span><br><span class="line"><span class="comment"> *   Max ops: 10</span></span><br><span class="line"><span class="comment"> *   Rating: 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">isTmax</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">  <span class="type">int</span> i = x + <span class="number">1</span>; <span class="comment">// Tmin,1000...</span></span><br><span class="line">  x = x + i; <span class="comment">// -1,1111...</span></span><br><span class="line">  x = ~x; <span class="comment">// 0,0000...</span></span><br><span class="line">  i = !i; <span class="comment">// exclude x=0xffff...</span></span><br><span class="line">  x = x + i; <span class="comment">// exclude x=0xffff...</span></span><br><span class="line">  <span class="keyword">return</span> !x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¦æ±‚å¦‚æœxæ˜¯è¡¥ç è¡¨ç¤ºçš„æœ€å¤§æ•°å°±è¿”å›1ï¼Œå¦åˆ™è¿”å›0ã€‚<br>é‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆè¦èƒ½è¯†åˆ«å‡ºè¡¥ç æœ€å¤§æ•°ï¼Œå¹¶ä¸”èƒ½å°†å…¶è½¬åŒ–ä¸º0x1ä½œä¸ºç»“æœã€‚æ˜¾ç„¶0x7fff_ffffå°±æ˜¯è¡¥ç æœ€å¤§æ•°ï¼Œå¦‚ä½•åˆ©ç”¨å…è®¸ä½¿ç”¨çš„è¿ç®—ç¬¦å°†å…¶è½¬åŒ–ä¸º0x1å‘¢ï¼Ÿè¿™é‡Œå°±æ¯”è¾ƒtrickyäº†ã€‚æˆ‘ä»¬å¯ä»¥å–x + 1 + xï¼Œå¦‚æœxæ˜¯0x7fff_ffffæ—¶ï¼Œå°†å¾—åˆ°0xffff_ffffï¼Œå³å…¨1ã€‚å¯¹å…¨1å–ä½åå³å¯å¾—åˆ°0ï¼Œå†å¯¹0å–é€»è¾‘éå°±èƒ½å¾—åˆ°0x1äº†ã€‚<br>ä½†è¿™é‡Œæœ‰ä¸€ä¸ªå®¹æ˜“å¿½ç•¥çš„æƒ…å½¢ï¼Œå³å½“xä¸º0xffff_ffffæ—¶ï¼Œç”±äºæº¢å‡ºï¼Œx + 1 + xä¹Ÿèƒ½å¾—åˆ°åŒæ ·çš„ç»“æœï¼ˆæˆ‘æ˜¯åœ¨btestæ—¶æ‰å‘ç°è¿™ä¸ªç‰¹ä¾‹ï¼‰ï¼Œæ‰€ä»¥éœ€è¦æ’é™¤è¿™ä¸ªæƒ…å½¢ï¼Œä½¿å¾—<strong>åªæœ‰å½“x&#x3D;0x7fff_ffffæ—¶æ‰èƒ½è¿”å›0x1</strong>ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç€æ€¥å¯¹0å–é€»è¾‘éï¼Œè€Œæ˜¯å…ˆå†å¯¹åŸæ¥çš„x+1å–é€»è¾‘éï¼Œå†åŠ ç»™å–ä½ååçš„x + 1 + xã€‚å½“xä¸º0x7fff_ffffæ—¶ï¼Œè¿™ä¸€æ­¥å¤šå‡ºçš„æ“ä½œä¸ä¼šå¯¹ç»“æœé€ æˆä»»ä½•å½±å“ï¼Œå› ä¸ºæ­¤æ—¶x + 1å–éåå¾—åˆ°çš„æ˜¯0ï¼ŒåŠ ä¸ª0æ˜¾ç„¶ä¸ä¼šæœ‰å½±å“ï¼›ä½†å¯¹äºxä¸º0xffff_ffffæ—¶ï¼Œx + 1å–éåå¾—åˆ°çš„æ˜¯1ï¼ŒåŠ å›å»åå¾—åˆ°1ï¼Œå†å–é€»è¾‘éæ—¶å°±å˜æˆäº†0ï¼Œä»è€Œæ’é™¤äº†è¿™ä¸ªä¾‹å¤–ã€‚</p>
<h5 id="allOddBits"><a href="#allOddBits" class="headerlink" title="allOddBits"></a>allOddBits</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * allOddBits - return 1 if all odd-numbered bits in word set to 1</span></span><br><span class="line"><span class="comment"> *   where bits are numbered from 0 (least significant) to 31 (most significant)</span></span><br><span class="line"><span class="comment"> *   Examples allOddBits(0xFFFFFFFD) = 0, allOddBits(0xAAAAAAAA) = 1</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 12</span></span><br><span class="line"><span class="comment"> *   Rating: 2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">allOddBits</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">  <span class="type">int</span> mask = <span class="number">0xAA</span> + (<span class="number">0xAA</span> &lt;&lt; <span class="number">8</span>);</span><br><span class="line">  mask = mask + (mask &lt;&lt; <span class="number">16</span>); <span class="comment">// mask = 0xAAAAAAAA</span></span><br><span class="line">  x = mask &amp; x;</span><br><span class="line">  <span class="keyword">return</span> !(~x &amp; mask);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»0å¼€å§‹è®¡ä½ï¼Œè‹¥xæ‰€æœ‰å¥‡æ•°ä½éƒ½ä¸º1åˆ™è¿”å›1ï¼Œå¦åˆ™è¿”å›0ã€‚<br>å¦‚ä½•æå–xçš„å¥‡æ•°ä½å‘¢ï¼Ÿæ˜¾ç„¶ç”¨ä¸€ä¸ªå¥‡æ•°ä½ä¸º1ï¼Œå¶æ•°ä½ä¸º0çš„maskå°±è¡Œäº†ï¼Œä½†æˆ‘ä»¬ä¸èƒ½ç›´æ¥ç”¨<code>int mask = 0xAAAAAAAA</code>æ„é€ å‡ºè¿™ä¸ªæ©ç ï¼Œå› ä¸ºLabè¦æ±‚æ•´æ•°å®éªŒçš„ä»£ç æœ€å¤šä½¿ç”¨8ä½å¸¸æ•°ï¼Œå¦‚0xAAï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè¦ç”¨0xAAäº§ç”Ÿ0xAAAAAAAAï¼Œæ–¹æ³•æœ‰å¾ˆå¤šï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚å†ç”¨è¿™ä¸ªmaskä¸xä½ä¸ï¼Œå³å¯åœ¨ç»“æœçš„å¥‡æ•°ä½ä¸Šå¯¹åº”å¾—åˆ°xçš„å¥‡æ•°ä½ã€‚å¦‚ä½•åˆ¤å®šxçš„å¥‡æ•°ä½æ˜¯å¦å…¨ä¸º1å‘¢ï¼Ÿæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°å¦‚æœå¦‚æ­¤ï¼Œé‚£ä¹ˆxä½ååå†ä¸maskä½ä¸ï¼Œåº”å½“å¾—åˆ°å…¨0ï¼Œå› ä¸ºä¸€ä¸ªæ˜¯å¥‡æ•°ä½å…¨0ï¼Œå¶æ•°ä½å…¨1ï¼Œå¦ä¸€ä¸ªæ˜¯å¥‡æ•°ä½å…¨1ï¼Œå¶æ•°ä½å…¨0ï¼Œæ²¡æœ‰ä¸€ä½æ˜¯ç›¸ç­‰çš„ã€‚å†å¯¹ç»“æœå–é€»è¾‘éå°±èƒ½å¾—åˆ°1ã€‚è€Œå¯¹äºä¸æ»¡è¶³çš„xï¼Œæ£€éªŒå¯çŸ¥ç»åŒæ ·çš„è¿ç®—ï¼Œæœ€ç»ˆéƒ½ä¼šå¾—åˆ°0ã€‚</p>
<h5 id="negate"><a href="#negate" class="headerlink" title="negate"></a>negate</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * negate - return -x </span></span><br><span class="line"><span class="comment"> *   Example: negate(1) = -1.</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 5</span></span><br><span class="line"><span class="comment"> *   Rating: 2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">negate</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> ~x + <span class="number">0x1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿”å›xçš„ç›¸åæ•°ã€‚åªè¦å¯¹è¡¥ç è¡¨ç¤ºæœ‰åŸºæœ¬äº†è§£ï¼Œè¿™é¢˜åº”è¯¥éƒ½æ˜¯ç§’è¿‡ï¼Œä¸å†èµ˜è¿°ã€‚</p>
<h3 id="3åˆ†é¢˜"><a href="#3åˆ†é¢˜" class="headerlink" title="3åˆ†é¢˜"></a>3åˆ†é¢˜</h3><p>éš¾åº¦æ›´å¤§äº†ã€‚ã€‚ã€‚</p>
<h5 id="isAsciiDigit"><a href="#isAsciiDigit" class="headerlink" title="isAsciiDigit"></a>isAsciiDigit</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * isAsciiDigit - return 1 if 0x30 &lt;= x &lt;= 0x39 (ASCII codes for characters &#x27;0&#x27; to &#x27;9&#x27;)</span></span><br><span class="line"><span class="comment"> *   Example: isAsciiDigit(0x35) = 1.</span></span><br><span class="line"><span class="comment"> *            isAsciiDigit(0x3a) = 0.</span></span><br><span class="line"><span class="comment"> *            isAsciiDigit(0x05) = 0.</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 15</span></span><br><span class="line"><span class="comment"> *   Rating: 3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">isAsciiDigit</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">  <span class="comment">// è€ƒå¯Ÿå¦‚ä½•ä½¿ç”¨ä½è¿ç®—æ¯”è¾ƒå¤§å°-&gt;ä¸èƒ½ç›´æ¥ç”¨ç®—æœ¯è¿ç®—ç¬¦ï¼Œä½†æ€è·¯ä¾ç„¶æ˜¯å¯ä»¥æ¯”è¾ƒç¬¦å·ä½-&gt;ç”¨ä½è¿ç®—å‡‘å‡ºç¬¦å·ä½æ”¹å˜çš„ä¸´ç•Œæ•°</span></span><br><span class="line">  <span class="type">int</span> sign = <span class="number">0x1</span> &lt;&lt; <span class="number">31</span>;</span><br><span class="line">  <span class="type">int</span> compH = ~(sign | <span class="number">0x39</span>); <span class="comment">// å½“ä¸å°äºç­‰äº0x39çš„æ•°ç›¸åŠ åï¼Œç¬¦å·ä½ä¸º0ï¼›å½“ä¸å¤§äº0x39çš„æ•°ç›¸åŠ åï¼Œç¬¦å·ä½å˜ä¸º1</span></span><br><span class="line">  <span class="type">int</span> compL = ~<span class="number">0x30</span>; <span class="comment">// å½“ä¸å¤§äº0x30çš„æ•°ç›¸åŠ åï¼Œç¬¦å·ä½ä¸º0ï¼›å½“ä¸å°äºç­‰äº0x30çš„æ•°ç›¸åŠ åï¼Œç¬¦å·ä½å˜ä¸º1</span></span><br><span class="line">  <span class="type">int</span> sign_1 = ((compH + x) &amp; sign) &gt;&gt; <span class="number">31</span>; <span class="comment">// å½“ç¬¦å·ä½ä¸º0æ—¶ï¼Œå¾—åˆ°sign_1ä¸ºå…¨0ï¼›å½“ç¬¦å·ä½ä¸º1æ—¶ï¼Œå¾—åˆ°sign_1ä¸ºå…¨1</span></span><br><span class="line">  <span class="type">int</span> sign_2 = ((compL + x + <span class="number">0x1</span>) &amp; sign) &gt;&gt; <span class="number">31</span>; <span class="comment">// è¿™é‡Œéœ€è¦é¢å¤–åŠ ä¸ª1ï¼Œå› ä¸ºå½“x=0x30æ—¶ï¼Œç¬¦å·ä½ä»ä¸º1ï¼Œéœ€è¦åŠ 1è¿›ä½ä½¿å…¶å˜ä¸º0.ä¸”åŠ 1ä¸ä¼šå¯¹0x30ä¹‹åçš„æ•°çš„ç»“æœäº§ç”Ÿå½±å“</span></span><br><span class="line">  <span class="keyword">return</span> !(sign_1 | sign_2); <span class="comment">// è¿™é‡Œè¦ç”¨é€»è¾‘éæ¥å®ç°æˆ–éï¼Œå› ä¸ºæœ€åè¦æ±‚çš„æ˜¯è¿”å›0/1ï¼Œè€Œsign_1/2ä½æˆ–åä»æ˜¯32ä½å…¨0/1æ•´æ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‹¥xæ˜¯0~9æ•°å­—çš„ASCIIç è¡¨ç¤ºï¼Œåˆ™è¿”å›1ï¼Œå¦åˆ™è¿”å›0ã€‚<br>åªè¦æˆ‘ä»¬èƒ½æ¯”è¾ƒxåŒ0x30å’Œ0x39çš„å¤§å°å°±è¡Œäº†ã€‚å¦‚ä½•ç”¨ä½è¿ç®—æ¯”è¾ƒä¸¤ä¸ªæ•°ä¹‹é—´çš„å¤§å°å‘¢ï¼Ÿï¼ˆ<del>æˆ‘ä¸é“å•Šï¼Ÿçœ‹äº†åˆ«äººçš„å†™æ³•æ‰æ‡‚</del>ï¼‰æœ‰ä¸€ç§æ¯”è¾ƒtrickyçš„å¤„ç†æ–¹å¼ï¼Œè™½ç„¶è¿™é¢˜ä¸ç»™ç”¨å‡æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å€Ÿé‰´ç±»ä¼¼çš„æƒ³æ³•ï¼Œå³è‡ªå·±æ„é€ å‡ºä¼šä½¿å¾—ç¬¦å·ä½æ”¹å˜çš„ä¸´ç•Œæ•°ï¼Œå†çœ‹ç¬¦å·ä½å°±è¡Œäº†ã€‚å…·ä½“æ€è·¯å¯ä»¥çœ‹ä»£ç æ³¨é‡Šã€‚</p>
<h5 id="conditional"><a href="#conditional" class="headerlink" title="conditional"></a>conditional</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * conditional - same as x ? y : z </span></span><br><span class="line"><span class="comment"> *   Example: conditional(2,4,5) = 4</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 16</span></span><br><span class="line"><span class="comment"> *   Rating: 3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">conditional</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">int</span> z)</span> &#123;</span><br><span class="line">  <span class="type">int</span> flag = !!x;</span><br><span class="line">  <span class="type">int</span> mask = ~flag + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> (y &amp; mask) + (z &amp; ~mask);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„éš¾ç‚¹åœ¨äºå¦‚ä½•ä»xçš„ä½çº§è¡¨ç¤ºè·å–å…¶ä¸€ä½å¸ƒå°”å€¼ï¼Œä½¿ç”¨é€»è¾‘éå³å¯ã€‚ç¬¬ä¸€æ¬¡é€»è¾‘éä¼šæŠŠ0è½¬åŒ–ä¸º1ï¼Œé0è½¬åŒ–ä¸º0ï¼Œç¬¬äºŒæ¬¡é€»è¾‘éä¼šè¿˜åŸä¸ºåŸé€»è¾‘å€¼ï¼Œæ‰€ä»¥<strong>éœ€è¦2æ¬¡é€»è¾‘é</strong>ã€‚ä½†æˆ‘ä»¬ä¸èƒ½ç›´æ¥ç”¨è¿™ä¸ªä¸€ä½å¸ƒå°”å€¼ï¼Œå› ä¸ºè¦å®ç°é€‰æ‹©æ“ä½œï¼Œç”¨ä¸€ä½åªèƒ½ä¿ç•™åŸè¾“å…¥çš„ä¸€ä½ï¼Œæ˜¾ç„¶æ˜¯ä¸å¯¹çš„ï¼Œæ•…è¿˜éœ€ç»ä¸€æ­¥å¾—åˆ°å…¨1å’Œå…¨0ï¼Œå†åšä¸æ“ä½œã€‚</p>
<h5 id="isLessOrEqual"><a href="#isLessOrEqual" class="headerlink" title="isLessOrEqual"></a>isLessOrEqual</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * isLessOrEqual - if x &lt;= y  then return 1, else return 0 </span></span><br><span class="line"><span class="comment"> *   Example: isLessOrEqual(4,5) = 1.</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 24</span></span><br><span class="line"><span class="comment"> *   Rating: 3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">isLessOrEqual</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">  <span class="type">int</span> sign = <span class="number">0x1</span> &lt;&lt; <span class="number">31</span>;</span><br><span class="line">  <span class="type">int</span> sign_x = x &amp; sign;</span><br><span class="line">  <span class="type">int</span> sign_y = y &amp; sign;</span><br><span class="line">  <span class="type">int</span> sign_inequal = ((sign_x ^ sign_y) &gt;&gt; <span class="number">31</span>) &amp; <span class="number">0x1</span>; <span class="comment">// sign_inequalä¸º0x1ï¼Œè¡¨ç¤ºç¬¦å·ä¸åŒï¼›ä¸º0åˆ™è¡¨ç¤ºç¬¦å·ç›¸åŒ</span></span><br><span class="line">  <span class="type">int</span> sign_diff = (y + ~x + <span class="number">0x1</span>) &amp; sign; <span class="comment">// y - x çš„å·®å€¼ç¬¦å·ï¼Œå½“ä¸º0x1&lt;&lt;32æ—¶è¡¨ç¤ºy&lt;xï¼Œå½“ä¸ºå…¨0æ—¶è¡¨ç¤ºy&gt;=xã€‚ æœ‰é”™è¯¯ï¼šå½“xä¸ºè´Ÿï¼Œyä¸ºæ­£æ—¶æœ‰å¯èƒ½æº¢å‡ºï¼Œå› è€Œä¸å¯é ã€‚åªæœ‰å½“ç¬¦å·ç›¸åŒæ—¶æ‰å¯é </span></span><br><span class="line">  <span class="type">int</span> same_res = !sign_diff;<span class="comment">// ç¬¦å·ç›¸åŒæ—¶çš„ç»“æœ</span></span><br><span class="line">  <span class="type">int</span> diff_res = !sign_y;<span class="comment">//ç¬¦å·ä¸åŒæ—¶çš„ç»“æœï¼Œå½“yä¸ºæ­£æ•°æ—¶è¿”å›å€¼å°±ä¸º1ï¼Œå¦åˆ™è¿”å›0</span></span><br><span class="line">  <span class="keyword">return</span> (sign_inequal &amp; diff_res) + (!sign_inequal &amp; same_res);<span class="comment">//ç¬¦å·ä¸åŒæ—¶ï¼Œå³sign_equalä¸º1æ—¶ï¼Œè¿”å›diff_resï¼›å¦åˆ™è¿”å›same_res</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¯”è¾ƒx,yå¤§å°ï¼Œè¿”å›æ¯”è¾ƒç»“æœã€‚<br>ç¬¬ä¸€çœ¼çœ‹ï¼Œæˆ‘ä»¬ä¹Ÿè®¸ä¼šæƒ³ç”¨isAsciiDigitçš„æ€è·¯åšè¿™é¢˜ï¼Œä½†è¿™æ˜¯ä¸è¡Œçš„ã€‚å› ä¸ºä¸Šä¸€é¢˜æˆ‘ä»¬åªè€ƒè™‘0x30~0x39è¿™ä¸€æ­£æ•°å°åŒºé—´ï¼Œè€Œç°åœ¨æˆ‘ä»¬éœ€è¦è€ƒè™‘æ•´ä¸ªå®æ•°åŸŸã€‚ç”¨ç›¸åŒçš„æ–¹æ³•å¤„ç†yä¸ºè´Ÿæ•°æ—¶ä¼šå‡ºç°é—®é¢˜ã€‚<br>è¿™æ—¶å°±è¦å›é€€åˆ°ä¸€èˆ¬è¿ç®—æ€è·¯ï¼Œå³ç¬¦å·ä¸åŒæ­£æ•°ä¸ºå¤§ï¼Œç¬¦å·ç›¸åŒçœ‹å·®å€¼ç¬¦å·å³å¯ã€‚è·å–å·®å€¼æ—¶ï¼Œè¿™é‡Œä¸èƒ½ç›´æ¥ç”¨â€™-â€˜ï¼Œæ•…ç”¨è¡¥ç æ–¹å¼ã€‚<br>x,yå’Œy-xçš„ç¬¦å·ä¸éš¾è·å¾—ï¼Œä½†éš¾ç‚¹åœ¨äºå¦‚ä½•é€šè¿‡ä½è¿ç®—åœ¨ç¬¦å·ä¸åŒæ—¶æ­£ç¡®é€‰æ‹©æ­£çš„é‚£ä¸€ä¸ªæ•°ï¼Œæ€è·¯å¯å‚è§ä»£ç æ³¨é‡Šã€‚</p>
<h3 id="4åˆ†é¢˜"><a href="#4åˆ†é¢˜" class="headerlink" title="4åˆ†é¢˜"></a>4åˆ†é¢˜</h3><p>è¿™å‡ ä½æ›´æ˜¯é‡é‡çº§ã€‚</p>
<h5 id="logicalNeg"><a href="#logicalNeg" class="headerlink" title="logicalNeg"></a>logicalNeg</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * logicalNeg - implement the ! operator, using all of </span></span><br><span class="line"><span class="comment"> *              the legal operators except !</span></span><br><span class="line"><span class="comment"> *   Examples: logicalNeg(3) = 0, logicalNeg(0) = 1</span></span><br><span class="line"><span class="comment"> *   Legal ops: ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 12</span></span><br><span class="line"><span class="comment"> *   Rating: 4 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">logicalNeg</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> ((x | (~x + <span class="number">1</span>)) &gt;&gt; <span class="number">31</span>) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ç°é€»è¾‘éè¿ç®—ç¬¦ã€‚è¦åšå‡ºè¿™é¢˜ï¼Œé¦–å…ˆéœ€è¦æ¸…æ¥šCè¯­è¨€ä¸­çš„å³ç§»å¯¹äºæœ‰ç¬¦å·æ•°æ˜¯ç®—æœ¯å³ç§»ï¼Œä»¥åŠæ•´æ•°ä¸­çš„1000â€¦0000è¡¨ç¤ºæœ€å°æ•°è€Œä¸æ˜¯è¡¨ç¤ºè´Ÿé›¶ã€‚å…¶æ¬¡ï¼Œè¿˜æ˜¯è¦æƒ³åŠæ³•å°†ä½çº§è¡¨ç¤ºçš„xçš„ä¿¡æ¯ç”¨ä¸€ä¸ªæ¯”ç‰¹è¡¨ç¤ºå‡ºæ¥ï¼Œä¹‹å‰æˆ‘ä»¬éƒ½æ˜¯ç”¨!!ï¼Œä½†è¿™é¢˜å°±æ˜¯éœ€è¦æˆ‘ä»¬å®ç°!ï¼Œæ•…å¾—é‡‡å–æ–°çš„æ€è·¯ã€‚æƒ³åˆ°å¯¹äº0æ¥è¯´ï¼Œå…¶åŸç å’Œè¡¥ç éƒ½æ˜¯0x0000ï¼Œç¬¦å·ä½ç›¸æˆ–ä»ä¸º0ï¼›è€Œå¯¹äºé0æ•°ï¼Œå…¶æºç å’Œè¡¥ç çš„ç¬¦å·ä½å¿…ç„¶äº’è¡¥ï¼Œä»è€Œç›¸æˆ–æ—¶ä¸º1ï¼Œè¿›è€Œå°±å¯ä»¥åŒºåˆ†0å’Œé0æ•°äº†ã€‚æœ€ç»ˆè¦æ±‚æ˜¯æ±‚åï¼Œæ•…å†åŠ 1å³å¯ã€‚<br>çœŸæ­£å®ç°èµ·æ¥ï¼Œä¸€è¡Œä»£ç å³å¯æå®šï¼Œä½†èƒŒåçš„æ€è€ƒè¿‡ç¨‹ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“ï¼Œä½ å¾—æƒ³åˆ°0å’Œé0æ•°å„è‡ªç›¸åæ•°ç¬¦å·ä½çš„å·®å¼‚ï¼Œæ‰èƒ½åšå‡ºè¿™é¢˜ã€‚</p>
<h5 id="howManyBits"><a href="#howManyBits" class="headerlink" title="howManyBits"></a>howManyBits</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* howManyBits - return the minimum number of bits required to represent x in</span></span><br><span class="line"><span class="comment"> *             two&#x27;s complement</span></span><br><span class="line"><span class="comment"> *  Examples: howManyBits(12) = 5</span></span><br><span class="line"><span class="comment"> *            howManyBits(298) = 10</span></span><br><span class="line"><span class="comment"> *            howManyBits(-5) = 4</span></span><br><span class="line"><span class="comment"> *            howManyBits(0)  = 1</span></span><br><span class="line"><span class="comment"> *            howManyBits(-1) = 1</span></span><br><span class="line"><span class="comment"> *            howManyBits(0x80000000) = 32</span></span><br><span class="line"><span class="comment"> *  Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *  Max ops: 90</span></span><br><span class="line"><span class="comment"> *  Rating: 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">howManyBits</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">  <span class="type">int</span> b16, b8, b4, b2, b1, b0; <span class="comment">// å¿…é¡»æå‰å£°æ˜ï¼Œå¦åˆ™dlcæ£€æŸ¥æ—¶ä¼šæŠ¥é”™</span></span><br><span class="line">  <span class="type">int</span> sign = x &gt;&gt; <span class="number">31</span>; <span class="comment">// æå–ç¬¦å·ä½ï¼Œsignä¸ºå…¨1æˆ–å…¨0</span></span><br><span class="line">  x = (sign &amp; ~x) | (~sign &amp; x); <span class="comment">// è¿™ä¸€æ­¥æ˜¯ä¸ºäº†æ–¹ä¾¿å¤„ç†è´Ÿæ•°ã€‚å¯¹è´Ÿæ•°å–åï¼Œå°†æ‰¾0è½¬åŒ–ä¸ºæ‰¾1ï¼Œè¿™æ ·å¯¹äºæ­£è´Ÿæ•°å°±å¯ä»¥ç»Ÿä¸€å¤„ç†äº†</span></span><br><span class="line">  <span class="comment">//ç»ä¸Šä¸€è¡Œæ“ä½œåï¼Œxç¬¦å·ä½æ€»ä¸º0ï¼Œæ•…ç®—æœ¯å³ç§»ä¸ä¼šé€ æˆå½±å“</span></span><br><span class="line">  b16 = !!(x &gt;&gt; <span class="number">16</span>) &lt;&lt; <span class="number">4</span>; <span class="comment">//è€ƒå¯Ÿé«˜16ä½æ˜¯å¦æœ‰1ï¼Œè‹¥æœ‰ï¼Œb16å¾—16ï¼Œå¦åˆ™å¾—0ï¼Œè‡³å°‘éœ€è¦16ä½ã€‚</span></span><br><span class="line">  x = x &gt;&gt; b16; <span class="comment">//è‹¥é«˜16ä½æœ‰1ï¼Œåˆ™å°†xå³ç§»16ä½ã€‚å¯¹äºb16=16ï¼Œæ­¤ä¸ºå‘å·¦ç¼©å°æœç´¢èŒƒå›´ï¼›å¯¹äºb16=0ï¼Œæ­¤ä¸ºå‘å³å¢å¤§æœç´¢èŒƒå›´</span></span><br><span class="line">  b8 = !!(x &gt;&gt; <span class="number">8</span>) &lt;&lt; <span class="number">3</span>; <span class="comment">//è€ƒå¯Ÿé«˜8ä½æ˜¯å¦æœ‰1ï¼Œè‹¥æœ‰ï¼Œb16å¾—8ï¼Œå¦åˆ™å¾—0ï¼Œè‡³å°‘éœ€è¦ä½æ•°å†åŠ 8ä½</span></span><br><span class="line">  x = x &gt;&gt; b8; <span class="comment">//ç»§ç»­ç¼©å°èŒƒå›´ï¼Œè€ƒå¯Ÿé«˜4ä½ã€‚ä¸‹é¢ä»¥æ­¤ç±»æ¨ã€‚</span></span><br><span class="line">  b4 = !!(x &gt;&gt; <span class="number">4</span>) &lt;&lt; <span class="number">2</span>;</span><br><span class="line">  x = x &gt;&gt; b4;</span><br><span class="line">  b2 = !!(x &gt;&gt; <span class="number">2</span>) &lt;&lt; <span class="number">1</span>;</span><br><span class="line">  x = x &gt;&gt; b2;</span><br><span class="line">  b1 = !!(x &gt;&gt; <span class="number">1</span>);</span><br><span class="line">  b0 = x &gt;&gt; b1; <span class="comment">// æœ€é«˜ä¸¤ä½æ˜¯11æ—¶ï¼Œæ‰€éœ€ä½æ•°è¿˜å¾—åŠ 1</span></span><br><span class="line">  <span class="keyword">return</span> b16 + b8 + b4 + b2 + b1 + b0 + <span class="number">1</span>; <span class="comment">// ç¬¦å·ä½å¿…å®šå ä¸€ä½</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ±‚ç”¨è¡¥ç è¡¨ç¤ºxè‡³å°‘éœ€è¦å‡ ä½ã€‚æ€è·¯å¾ˆå¥½æƒ³ï¼Œç¬¦å·ä½å¿…å®šå ä¸€ä½ï¼Œå‰©ä¸‹çš„ä»å·¦å¾€å³æ‰¾ç¬¬ä¸€ä¸ªæœ‰æ•ˆä½(æ­£æ•°æ˜¯1ï¼Œè´Ÿæ•°æ˜¯0)ï¼Œå…¶ä¸ä¹‹åå‰©ä¸‹çš„ä½éƒ½æ˜¯éœ€è¦çš„ä½ã€‚ä½†æ˜¯ä»£ç å®åœ¨å†™ä¸å‡ºæ¥ï¼Œå°±copyåˆ«äººçš„ä»£ç äº†ã€‚<br>å®é™…ä¸Šä»£ç çš„æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨è¿™ä¸²32ä½æ¯”ç‰¹ä¸Šåš<strong>äºŒåˆ†æœç´¢</strong>ï¼ˆ<del>è¿˜èƒ½è¿™æ ·ï¼Œè‰¹</del>ï¼‰ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆä½,åŒæ—¶ç»Ÿè®¡æ¯”ç‰¹æ•°é‡ã€‚<br>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå°æ’æ›²ï¼Œå³ä½¿ç”¨çš„ä¸´æ—¶å˜é‡éƒ½å¿…é¡»åœ¨å‡½æ•°çš„ä¸€å¼€å§‹æå‰å£°æ˜ï¼Œä¸èƒ½åœ¨ä½¿ç”¨æ—¶æ‰å£°æ˜å¹¶åˆå§‹åŒ–ï¼Œå¦åˆ™dlcæ£€æŸ¥æ—¶ä¼šæŠ¥é”™ï¼Œè¯´ä½ æ²¡æœ‰å£°æ˜å˜é‡ã€‚ä¸å¤ªæ¸…æ¥šåŸå› ã€‚</p>
<h5 id="floatScale2"><a href="#floatScale2" class="headerlink" title="floatScale2"></a>floatScale2</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * floatScale2 - Return bit-level equivalent of expression 2*f for</span></span><br><span class="line"><span class="comment"> *   floating point argument f.</span></span><br><span class="line"><span class="comment"> *   Both the argument and result are passed as unsigned int&#x27;s, but</span></span><br><span class="line"><span class="comment"> *   they are to be interpreted as the bit-level representation of</span></span><br><span class="line"><span class="comment"> *   single-precision floating point values.</span></span><br><span class="line"><span class="comment"> *   When argument is NaN, return argument</span></span><br><span class="line"><span class="comment"> *   Legal ops: Any integer/unsigned operations incl. ||, &amp;&amp;. also if, while</span></span><br><span class="line"><span class="comment"> *   Max ops: 30</span></span><br><span class="line"><span class="comment"> *   Rating: 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="title function_">floatScale2</span><span class="params">(<span class="type">unsigned</span> uf)</span> &#123;</span><br><span class="line">  <span class="type">int</span> <span class="built_in">exp</span> = (uf &amp; <span class="number">0x7f800000</span>) &gt;&gt; <span class="number">23</span>; <span class="comment">//expä½23ä½è¡¨ç¤ºåŸæ•°çš„é˜¶ç </span></span><br><span class="line">  <span class="type">int</span> sign = uf &amp; <span class="number">0x80000000</span>; <span class="comment">// signæœ€é«˜ä½ä¸ºåŸæ•°ç¬¦å·ä½ï¼Œå…¶ä½™ä½å…¨ä¸º0</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">exp</span> == <span class="number">255</span>) <span class="keyword">return</span> uf; <span class="comment">// æ— ç©·æˆ–NaN</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">exp</span> == <span class="number">0</span>) <span class="keyword">return</span> sign | (uf &lt;&lt; <span class="number">1</span>); <span class="comment">// éè§„æ ¼æ•°</span></span><br><span class="line">  <span class="keyword">if</span> (++<span class="built_in">exp</span> == <span class="number">255</span>) <span class="keyword">return</span> sign | <span class="number">0x7f800000</span>; <span class="comment">// æº¢å‡ºï¼Œè¿”å›æ— ç©·å¤§</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="built_in">exp</span> &lt;&lt; <span class="number">23</span>) | (uf &amp; <span class="number">0x807fffff</span>); <span class="comment">// è§„æ ¼æ•°ä¸”æ— æº¢å‡º</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ç°2*fã€‚ä¸å‰é¢çš„é¢˜ç›¸æ¯”ï¼Œè¿™é¢˜å…¶å®ä¸éš¾ï¼Œåªè¦è®¤çœŸè¯»äº†ä¹¦ï¼ŒçŸ¥é“æµ®ç‚¹æ•°çš„è¡¨ç¤ºæ–¹æ³•å°±èƒ½åšå‡ºæ¥ã€‚<br>è‹¥ä¸ºè§„æ ¼æ•°ï¼Œç›´æ¥é˜¶ç åŠ 1å³å¯ã€‚ä½†è‹¥é˜¶ç åŠ 1åå˜ä¸ºå…¨1ï¼Œåˆ™è¿”å›çš„åº”æ˜¯å¯¹åº”ç¬¦å·çš„æ— ç©·å¤§ã€‚<br>è‹¥ä¸ºéè§„æ ¼æ•°ï¼Œåˆ™ç›´æ¥å·¦ç§»1ä½å¹¶è¡¥ä¸Šç¬¦å·ä½å³å¯ã€‚è¿™æ˜¯å› ä¸ºå½“éè§„æ ¼æ•°çš„å°æ•°å­—æ®µæœ€é«˜ä½ä¸º0æ—¶ï¼Œç›´æ¥å·¦ç§»1ä½ä»è¡¨ç¤ºä¸ºéè§„æ ¼æ•°ï¼Œä¸”å°æ•°å­—æ®µå› å·¦ç§»è€Œä¹˜ä»¥2ï¼Œè‡ªç„¶å¾—åˆ°äº†ç»“æœ<br>å½“å°æ•°å­—æ®µæœ€é«˜ä½ä¸º1æ—¶ï¼Œå·¦ç§»1ä½ä¼šå¯¼è‡´é˜¶ç å˜ä¸º0x1è€Œæˆä¸ºè§„æ ¼æ•°ã€‚ä½†å¯¹è§„æ ¼æ•°è€Œè¨€ï¼Œ0x1é˜¶ç ä¸éè§„æ ¼æ•°è¡¨ç¤ºçš„æŒ‡æ•°ç›¸åŒï¼Œéƒ½ä¸º1-Biasã€‚ä¸”è™½ç„¶å°æ•°æœ€é«˜ä½çœ‹ä¼¼ä¸¢å¤±äº†ï¼Œä½†è§„æ ¼æ•°è¡¨ç¤ºçš„å°¾æ•°æœ¬èº«å°±æ˜¯1+fï¼Œä¸éè§„æ ¼æ•°çš„å°¾æ•°fç›¸æ¯”ï¼Œç›¸å½“äºæŠŠæœ€é«˜ä½çš„1è¡¨ç¤ºæˆåè¿›åˆ¶çš„0.5ä¹˜ä»¥2å¾—åˆ°çš„1å•ç‹¬æå–äº†å‡ºæ¥ï¼Œå…¶ä½™ä½å·¦ç§»è‡ªç„¶ä¹˜ä»¥2ã€‚å¾—ç›ŠäºIEEEæµ®ç‚¹æ ‡å‡†çš„è¿™ç§éè§„æ ¼æ•°å¹³æ»‘å‘è§„æ ¼æ•°è¿‡æ¸¡çš„è®¾è®¡ï¼Œæˆ‘ä»¬è¿™é‡Œå¤„ç†éè§„æ ¼æ•°ä¹Ÿç®€å•å¾ˆå¤šï¼Œä¸éœ€è¦æ‹…å¿ƒæº¢å‡ºã€‚<br>è‹¥ä¸ºæ— ç©·å¤§å’ŒNaNï¼Œç›´æ¥è¿”å›åŸæ•°å³å¯</p>
<h5 id="floatFloat2Int"><a href="#floatFloat2Int" class="headerlink" title="floatFloat2Int"></a>floatFloat2Int</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * floatFloat2Int - Return bit-level equivalent of expression (int) f</span></span><br><span class="line"><span class="comment"> *   for floating point argument f.</span></span><br><span class="line"><span class="comment"> *   Argument is passed as unsigned int, but</span></span><br><span class="line"><span class="comment"> *   it is to be interpreted as the bit-level representation of a</span></span><br><span class="line"><span class="comment"> *   single-precision floating point value.</span></span><br><span class="line"><span class="comment"> *   Anything out of range (including NaN and infinity) should return</span></span><br><span class="line"><span class="comment"> *   0x80000000u.</span></span><br><span class="line"><span class="comment"> *   Legal ops: Any integer/unsigned operations incl. ||, &amp;&amp;. also if, while</span></span><br><span class="line"><span class="comment"> *   Max ops: 30</span></span><br><span class="line"><span class="comment"> *   Rating: 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">floatFloat2Int</span><span class="params">(<span class="type">unsigned</span> uf)</span> &#123;</span><br><span class="line">  <span class="type">int</span> <span class="built_in">exp</span>, E, tail, sign;</span><br><span class="line">  <span class="keyword">if</span> (!(uf &amp; <span class="number">0x7fffffff</span>)) <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// å½“ufä¸º0ï¼Œ-0æ—¶ï¼Œç›´æ¥è¿”å›0å³å¯ã€‚æ³¨æ„è¿™ä¸ª-0å®¹æ˜“é—æ¼</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">exp</span> = (uf &amp; <span class="number">0x7f800000</span>) &gt;&gt; <span class="number">23</span>;</span><br><span class="line">  sign = uf &amp; <span class="number">0x80000000</span>;</span><br><span class="line">  tail = (uf &amp; <span class="number">0x007fffff</span>) | <span class="number">0x00800000</span>; <span class="comment">// ç”±äºä¹‹åçš„ä»£ç ä¼šæ’é™¤éè§„æ ¼æ•°ï¼Œæ•…å¯¹è§„æ ¼æ•°è€Œè¨€ï¼ŒçœŸå®çš„å°æ•°è¡¨ç¤ºä¸ºå°¾æ•°+1ï¼Œè¿™é‡Œä¸0x00800000ç›¸æˆ–å°±æ˜¯ä¸ºäº†åŠ ä¸Šå°æ•°ç‚¹å‰çš„1</span></span><br><span class="line"></span><br><span class="line">  E = <span class="built_in">exp</span> - <span class="number">127</span>; <span class="comment">// Eè¡¨ç¤ºç”±é˜¶ç å¤åŸå¾—åˆ°çš„çœŸå®æŒ‡æ•°ï¼Œæ³¨æ„E &gt; 31æ—¶ï¼Œå¿…å®šåœ¨å·¦ç§»æ—¶è¦†ç›–æ‰ç¬¦å·ä½ï¼Œæ‰€ä»¥ä¼šæº¢å‡ºã€‚æ­¤æ—¶ä¹ŸåŒ…æ‹¬äº†NaNå’ŒINFï¼ˆE=255-127å¿…ç„¶å¤§äº31ï¼‰</span></span><br><span class="line">  <span class="keyword">if</span> (E &gt; <span class="number">31</span>) <span class="keyword">return</span> <span class="number">0x80000000</span>;</span><br><span class="line">  <span class="keyword">if</span> (E &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// ç›´è§‚æ¥ç†è§£ï¼Œå¯¹äºå§‹ç»ˆå°äº2çš„å°¾æ•°ï¼Œå½“E &lt; 0æ—¶ï¼Œç›¸å½“äºè‡³å°‘é™¤ä»¥2ï¼Œæ‰€å¾—ä¸€å®šæ˜¯ä¸ªå°äº1çš„å°æ•°ï¼Œæ•…å–0ã€‚éè§„æ ¼æ•°ä¹Ÿåœ¨è¿™é‡Œè¢«æ’é™¤</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 0 &lt;= E &lt;= 31æ—¶ï¼Œä¾ç„¶æœ‰å¯èƒ½å‘ç”Ÿæº¢å‡ºï¼Œæ•…éœ€è¦åšç”„åˆ«å¹¶æ’é™¤</span></span><br><span class="line">  <span class="comment">// å¼€å§‹å·¦ç§»/å³ç§»ã€‚å½“E &gt; 23æ—¶ï¼Œè¯´æ˜ä¹˜æ³•åæ‰€æœ‰å°æ•°ç‚¹åçš„åŸå°¾æ•°ä½éƒ½ç§»åˆ°äº†å°æ•°ç‚¹å‰ï¼Œæ­¤æ—¶ç»“æœä¸ºä¸€ä¸ªæ•´æ•°ï¼Œæ•…ç›´æ¥å·¦ç§»å³å¯ã€‚ å½“E &lt; 23æ—¶ï¼Œ è¯´æ˜ä¹˜æ³•åä»å«æœ‰å°æ•°éƒ¨åˆ†ï¼Œ</span></span><br><span class="line">  <span class="comment">// åˆ™è½¬ä¸ºIntæ—¶ç›´æ¥ä¸¢å¼ƒè¿™äº›å°æ•°éƒ¨åˆ†å³å¯ï¼Œå¯¹åº”çš„æ“ä½œå°±æ˜¯å³ç§»</span></span><br><span class="line">  tail = (E &gt; <span class="number">23</span>) ? tail &lt;&lt; (E - <span class="number">23</span>) : tail &gt;&gt; (<span class="number">23</span> - E);</span><br><span class="line">  <span class="comment">// åŸæ¥æ˜¯æŒ‰ä½è¡¨ç¤ºçš„1+å°æ•°ï¼Œæ•…å¯¹E&gt;23æ¥è¯´ï¼Œä¸€å¼€å§‹ä¹˜2æ—¶ä¼šå…ˆç§»åŠ¨å°æ•°ç‚¹ï¼Œæ•…ä¸ä¼šæ”¹å˜ä½œä¸ºIntçš„å„ä½æ•°å€¼ã€‚åªæœ‰å½“è¶…è¿‡23éƒ¨åˆ†çš„Eä¼šå¯¼è‡´æ•°å€¼å¼€å§‹ä¹˜2ï¼Œå³å·¦ç§»</span></span><br><span class="line">  <span class="comment">// è€Œå¯¹äºE&lt;23æ¥è¯´ï¼Œæ— è®ºå¦‚ä½•éƒ½åªä¼šæ”¹å˜å°æ•°ç‚¹è€Œä¸æ”¹å˜æ•°å€¼ï¼Œå› è€Œä¸ä¼šå·¦ç§»ã€‚ä½†å› ä¸ºæ­¤æ—¶å«æœ‰å°æ•°ï¼Œæ•…æƒå€¼ä¸æ˜¯ä»0è€Œæ˜¯ä»æŸä¸ªè´Ÿæ•°å¼€å§‹ï¼Œå› è€Œå„ä½ä¸Šçš„æƒå€¼å¯¹åº”éƒ½ä¼šè¡°å‡ï¼Œæœ¬åº”æ˜¯å³ç§»23ä½æ¥å¯¹ä¸Šå°æ•°</span></span><br><span class="line">  <span class="comment">// çš„æƒå€¼ï¼Œä½†å› ä¸ºæœ‰ä¹˜Eæ¬¡2çš„æ“ä½œï¼Œæ¯æ¬¡ä¹˜2éƒ½ä¼šä½¿æƒå€¼å¯¹åº”å‡é«˜1ä½ï¼Œæ•…ä¼šæŠµæ¶ˆEæ¬¡å³ç§»æ“ä½œï¼Œæœ€ç»ˆæ•ˆæœå°±æ˜¯å³ç§»23-Eä½ã€‚åŒæ—¶åœ¨å³ç§»çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜èˆå»äº†å°æ•°çš„ä¿¡æ¯ã€‚</span></span><br><span class="line">  <span class="comment">// ç»Ÿä¸€çš„è§£é‡Šï¼šå› ä¸ºå°æ•°ä»å·¦å‘å³çš„æƒå€¼æ˜¯ä»-1å¼€å§‹çš„ï¼Œè€Œä¸æ˜¯ä»0å¼€å§‹çš„ï¼Œæ•…å¯¹äºåŸå°æ•°çš„ä½çº§è¡¨ç¤ºï¼Œåº”é¦–å…ˆå³ç§»23ä½æ¥å¯¹ä¸Šæ­£ç¡®çš„æƒå€¼(&lt;&lt;-23 or &gt;&gt;23)ã€‚</span></span><br><span class="line">  <span class="comment">// ä½†å› ä¸ºæœ‰ä¹˜Eæ¬¡2çš„æ“ä½œï¼Œæ¯æ¬¡ä¹˜2éƒ½ä¼šä½¿æƒå€¼å¯¹åº”å‡é«˜1ä½ï¼Œæ•…ä¼šæŠµæ¶ˆEæ¬¡å³ç§»æ“ä½œï¼Œæœ€ç»ˆæ•ˆæœå°±æ˜¯å³ç§»23-Eä½(&lt;&lt;E-23 or &gt;&gt; 23-E)ã€‚åŒæ—¶æ³¨æ„åœ¨å³ç§»çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜ä¼šèˆå»å°æ•°çš„ä¿¡æ¯ã€‚</span></span><br><span class="line">  <span class="keyword">return</span> sign ? -tail : tail; <span class="comment">// ä¿ç•™åŸç¬¦å·</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ç°<code>float</code>åˆ°<code>int</code>å¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚è¿™é¢˜ä¹Ÿæ²¡å†™å‡ºæ¥ï¼Œcopyäº†ç½‘ä¸Šä»£ç ï¼Œä»£ç è§£é‡Šçœ‹æ³¨é‡Šå°±è¡Œã€‚</p>
<h5 id="floatPower2"><a href="#floatPower2" class="headerlink" title="floatPower2"></a>floatPower2</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * floatPower2 - Return bit-level equivalent of the expression 2.0^x</span></span><br><span class="line"><span class="comment"> *   (2.0 raised to the power x) for any 32-bit integer x.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   The unsigned value that is returned should have the identical bit</span></span><br><span class="line"><span class="comment"> *   representation as the single-precision floating-point number 2.0^x.</span></span><br><span class="line"><span class="comment"> *   If the result is too small to be represented as a denorm, return</span></span><br><span class="line"><span class="comment"> *   0. If too large, return +INF.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *   Legal ops: Any integer/unsigned operations incl. ||, &amp;&amp;. Also if, while </span></span><br><span class="line"><span class="comment"> *   Max ops: 30 </span></span><br><span class="line"><span class="comment"> *   Rating: 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="title function_">floatPower2</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">  <span class="type">int</span> <span class="built_in">exp</span> = x + <span class="number">127</span>; <span class="comment">// åŠ ä¸Šbiaså¾—åˆ°ä½çº§è¡¨ç¤ºçš„é˜¶ç </span></span><br><span class="line">  <span class="comment">// é˜¶ç çš„èŒƒå›´æ˜¯00000000~11111111ï¼Œè¶…å‡ºè¿™ä¸ªè¡¨ç¤ºèŒƒå›´æ—¶ï¼Œå¯¹åº”0(å…¨0)å’ŒINF(0111_1111_1000_0...0)</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">exp</span> &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// æå°æ•°ï¼Œå½“åš0</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">exp</span> &gt; <span class="number">0xff</span>) <span class="keyword">return</span> <span class="number">0x7f800000</span>; <span class="comment">// INF </span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">exp</span> &lt;&lt; <span class="number">23</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ç°2çš„å¹‚æ¬¡æ–¹è¿ç®—ã€‚è¿™é¢˜ç®€å•ä¸€ç‚¹ï¼Œé¦–å…ˆç”±xåŠ ä¸Šbiaså¾—åˆ°å¯¹åº”æµ®ç‚¹æ•°çš„é˜¶ç ã€‚ç”±äº2çš„å¹‚ç¬¦å·ä½ä¸º0ï¼Œå°¾æ•°ä¹Ÿä¸ºå…¨0ï¼Œæ•…å†å¯¹é˜¶ç ç§»ä½åˆ°æµ®ç‚¹æ•°å¯¹åº”çš„ä½ç½®å³å¯ã€‚æ³¨æ„è¦æ’é™¤æå°æ•°å’Œæ— ç©·ï¼Œå³è¶…è¿‡é˜¶ç è¡¨ç¤ºçš„æ•°ã€‚</p>
<h3 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h3><p>è¿™é‡Œæœ‰ä¸ªå°æ’æ›²ï¼Œç¼–è¯‘btestæ—¶æç¤ºä¸å…¼å®¹çš„gccã€‚è¿™æ˜¯å› ä¸ºæˆ‘çš„æœºå™¨æ˜¯x86-64ï¼Œä½†Labçš„makefileä¸­æ·»åŠ äº†-m32å‚æ•°ï¼Œè€Œæˆ‘ç¼ºå°‘åœ¨64ä½æœºå™¨ç¼–è¯‘32ä½ç¨‹åºçš„åº“ã€‚è¿™é‡Œå¯ä»¥é€‰æ‹©ä¿®æ”¹makefileï¼ŒæŠŠè¿™ä¸ªå‚æ•°åˆ å»æˆ–è€…æ”¹ä¸º-m64ï¼Œæˆ–è€…å®‰è£…éœ€è¦çš„åº“ï¼Œæœ‰<strong>gcc-multilib</strong>å’Œ<strong>module-assistant</strong>ã€‚<br>æµ‹è¯•ç»“æœå¦‚å›¾ã€‚<br><img src="https://s2.loli.net/2022/04/30/JahmHNLkZU2b8AY.png" alt="lab_1_result.png"></p>
<h3 id="ç¢ç¢å¿µ"><a href="#ç¢ç¢å¿µ" class="headerlink" title="ç¢ç¢å¿µ"></a>ç¢ç¢å¿µ</h3><p>ä»è¿™ä¸ªå­¦æœŸå¼€å§‹ï¼Œæˆ‘ä¸€ç›´å¤„äºä¸€ç§æµ‘æµ‘å™©å™©çš„çŠ¶æ€ï¼Œè¯¾å†…æ²¡å­¦å¥½ï¼ŒåŠ æƒå·ä¸ä¸Šå»ï¼Œè¯¾å¤–çš„çŸ¥è¯†ä¹Ÿè¿›åº¦ç¼“æ…¢ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºCSAPPåªè¯»åˆ°äº†ç¬¬å››ç« ï¼Œè®¡ç®—æœºè§†è§‰åŠç†Ÿä¸ç†Ÿï¼Œå‡ ä¸ªæœˆæ²¡å†™å®‰å“ï¼‰ã€‚æœ€è¿‘çœ‹äº†è®¸å¤šå¤§ç‰›å­¦é•¿çš„åšå®¢å’Œä»–ä»¬çš„ç»å†åˆ†äº«ï¼Œæ”¶è·äº†å¾ˆå¤šï¼Œè¿˜æ˜¯å¸Œæœ›èƒ½å‘å¼ºè€…é æ‹¢ã€‚å¼€å§‹åšCSAPPçš„labï¼Œä¹Ÿç®—æ˜¯è‡ªå·±æŒ£è„±æ‘†çƒ‚çŠ¶æ€çš„ä¸€æ¬¡å°è¯•ã€‚å¸Œæœ›è‡ªå·±èƒ½ç»§ç»­åŠªåŠ›ï¼Œä¿æŒå­¦ä¹ å§ï¼</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.eynnzerr.top/2025/08/29/old-handler-src-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/otae.jpg">
      <meta itemprop="name" content="Eynnzerr">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eynnzerr's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/08/29/old-handler-src-analysis/" class="post-title-link" itemprop="url">Handler æ¶ˆæ¯å¤„ç†æœºåˆ¶è§£æ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-08-29 20:44:42 / ä¿®æ”¹æ—¶é—´ï¼š20:50:29" itemprop="dateCreated datePublished" datetime="2025-08-29T20:44:42+08:00">2025-08-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>19k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>35 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>è¯¥ç¯‡å†…å®¹ä¸ºåŸåšå®¢åšæ–‡ï¼ŒåŸä¸Šä¼ äº2021å¹´9æœˆ11æ—¥ã€‚</strong></p>
<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æåˆ°Androidä¸­çš„æ¶ˆæ¯æœºåˆ¶ï¼Œæƒ³å¿…å¤§å®¶å¯¹å…¶éƒ½ä¸é™Œç”Ÿã€‚Androidæ¶ˆæ¯æœºåˆ¶ï¼Œä¸€èˆ¬æŒ‡handlerå’Œå…¶é™„åŠ çš„mqåŠlooperçš„è¿è¡Œæœºåˆ¶ä¸å·¥ä½œè¿‡ç¨‹ã€‚handlerå¸¸ç”¨äºè§£å†³åœ¨å­çº¿ç¨‹ä¸èƒ½è®¿é—®UIçš„é—®é¢˜ï¼Œä¸¾ä¸€ä¸ªå¸¸è§çš„ä¾‹å­ï¼šæˆ‘ä»¬åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œäº†è€—æ—¶å·¥ä½œåï¼Œéœ€è¦å¯¹UIè¿›è¡Œæ›´æ–°ï¼Œä½†åˆä¸èƒ½ç›´æ¥åœ¨å­çº¿ç¨‹æ›´æ–°UIï¼ˆè¿™æ˜¯å› ä¸ºæ§ä»¶åœ¨é‡ç»˜å‰ä¼šè°ƒç”¨checkThread()æ£€æŸ¥å½“å‰æ˜¯å¦ä¸ºä¸»çº¿ç¨‹ï¼Œä»¥é˜²ANRï¼‰ã€‚æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºhandlerï¼Œå¹¶å°†è¦æ‰§è¡Œçš„ä»£ç é€»è¾‘å†™å…¥ä¸€ä¸ªrunnableä»»åŠ¡ä¸­ï¼Œå¹¶è°ƒç”¨handlerçš„post(æœ¬è´¨ä¸Šä»æ˜¯è°ƒç”¨send)æˆ–sendå°†ä»»åŠ¡æäº¤ç»™ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå†ç”±ä¸»çº¿ç¨‹çš„looperå–å‡ºè¿™ä¸ªä»»åŠ¡ï¼Œåœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œå¦‚æ­¤ä¾¿è‡ªç„¶åœ°ä»å­çº¿ç¨‹è½¬å…¥ä¸»çº¿ç¨‹ï¼Œå®ç°äº†UIçš„æ›´æ–°ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨Activityç±»çš„runOnUiThread()æ–¹æ³•ï¼Œé“ç†æ˜¯ä¸€æ ·çš„ã€‚ä¸‹é¢å°±è®©æˆ‘ä»¬ä¸€èµ·ä»æºç çš„è§’åº¦æ¢ç©¶handleræ¶ˆæ¯å¤„ç†æœºåˆ¶çš„åŸç†ï¼Œä»¥åŠhandlerä½¿ç”¨å­˜åœ¨çš„ä¸€äº›é—®é¢˜ã€‚</p>
<h1 id="handlerçš„æ„é€ é—®é¢˜"><a href="#handlerçš„æ„é€ é—®é¢˜" class="headerlink" title="handlerçš„æ„é€ é—®é¢˜"></a>handlerçš„æ„é€ é—®é¢˜</h1><p>handleræœ‰å¤šä¸ªæ„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬å¸¸å¸¸ç”¨åˆ°çš„æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š</p>
<ol>
<li>æ— å‚æ„é€ </li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Handler</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ„é€ æ–¹æ³•å·²ç»å¼ƒç”¨ã€‚å…¶å†…éƒ¨è°ƒç”¨äº†å¦ä¸€ä¸ªæœ‰å‚æ„é€ æ–¹æ³•ï¼Œä½†æ˜¯ä¼ çš„å€¼ä¸ºnullå’Œfalseï¼Œè®©æˆ‘ä»¬æ¥ä¸‹å»çœ‹çœ‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Handler</span><span class="params">(<span class="meta">@Nullable</span> Callback callback, <span class="type">boolean</span> async)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (FIND_POTENTIAL_LEAKS) &#123;</span><br><span class="line">        <span class="keyword">final</span> Class&lt;? <span class="keyword">extends</span> <span class="title class_">Handler</span>&gt; klass = getClass();</span><br><span class="line">        <span class="keyword">if</span> ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp;</span><br><span class="line">                (klass.getModifiers() &amp; Modifier.STATIC) == <span class="number">0</span>) &#123;</span><br><span class="line">            Log.w(TAG, <span class="string">&quot;The following Handler class should be static or leaks might occur: &quot;</span> +</span><br><span class="line">                klass.getCanonicalName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mLooper = Looper.myLooper();</span><br><span class="line">    <span class="keyword">if</span> (mLooper == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">            <span class="string">&quot;Can&#x27;t create handler inside thread &quot;</span> + Thread.currentThread()</span><br><span class="line">                    + <span class="string">&quot; that has not called Looper.prepare()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mQueue = mLooper.mQueue;</span><br><span class="line">    mCallback = callback;</span><br><span class="line">    mAsynchronous = async;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬å…ˆè§£é‡Šä¸€ä¸‹è¿™ä¸ªæ„é€ æ–¹æ³•çš„å‚æ•°ï¼šcallbackæ˜¯handlerä¸­å®šä¹‰çš„ä¸€ä¸ªæ¥å£ï¼Œç”¨äºç®€åŒ–æ„å»ºhandlerçš„è¿‡ç¨‹ï¼ˆå¯ä»¥ç”¨å®ç°è¿™ä¸ªæ¥å£æ¥é¿å…è‡ªå®šä¹‰handlerå­ç±»ï¼‰ï¼Œä¸‹æ–‡å†å¯¹è¿™ä¸ªæ¥å£åšè¯¦ç»†è§£é‡Šã€‚è¿™é‡Œä¼ å…¥å€¼ä¸ºnullï¼Œè¯´æ˜æˆ‘ä»¬ä¸é‡‡ç”¨è¿™ç§æ–¹å¼ã€‚asyncæ ‡å¿—è¿™ä¸ªhandleræ˜¯å¦é‡‡ç”¨å¼‚æ­¥æ¶ˆæ¯ï¼Œä¸‹æ–‡å†å¯¹handlerçš„å¼‚æ­¥ã€æ™®é€šå’Œå±éšœæ¶ˆæ¯ä½œåŒºåˆ«ä»¥åŠä»‹ç»åŒæ­¥å±éšœæœºåˆ¶ã€‚è¿™é‡Œä¼ å…¥falseï¼Œè¯´æ˜æˆ‘ä»¬é»˜è®¤é‡‡ç”¨çš„éƒ½æ˜¯æ™®é€šæ¶ˆæ¯æœºåˆ¶ã€‚<br>è¿™ä¸ªæ„é€ æ–¹æ³•é¦–å…ˆä¼šé€šè¿‡FIND_POTENTIAL_LEAKSåˆ¤æ–­æ˜¯å¦ç”±å¯èƒ½å­˜åœ¨çš„å†…å­˜æ³„æ¼æƒ…å†µï¼Œå¦‚æœæœ‰ï¼Œåˆ™ä¼šè¾“å‡ºæ—¥å¿—è­¦å‘Šæˆ‘ä»¬ã€‚ï¼ˆä¸è¿‡æˆ‘æ²¡æœ‰æ‰¾åˆ°è®¾ç½®è¿™ä¸ªboolå€¼ä¸ºtrueçš„ä»£ç éƒ¨åˆ†ã€‚ã€‚ã€‚ï¼‰å…³äºhandleræ½œåœ¨çš„å†…å­˜æ³„æ¼é£é™©ï¼Œä¸‹æ–‡ä¼šé‡ç‚¹è®¨è®ºã€‚æ¥ç€è°ƒç”¨Looper.myLooper()å°è¯•è·å–å½“å‰çº¿ç¨‹çš„looperã€‚æˆ‘ä»¬è¿›å…¥è¿™ä¸ªæ–¹æ³•çœ‹çœ‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@Nullable</span> Looper <span class="title function_">myLooper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> sThreadLocal.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨äº†sThreadLocalçš„getæ–¹æ³•å¹¶è¿”å›ã€‚é‚£ä¹ˆsThreadLocalæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ‰¾åˆ°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre><code>static final ThreadLocal&lt;Looper&gt; sThreadLocal = new ThreadLocal&lt;Looper&gt;();
</code></pre>
<p>å‘ç°è¿™æ˜¯ä¸€ä¸ªThreadLocalå˜é‡ã€‚å…³äºThreadLocalè¿™é‡Œä¸åšè¿‡å¤šä»‹ç»ï¼ˆè®¡åˆ’å•ç‹¬å†™ä¸€ç¯‡åšå®¢ç ”ç©¶ä¸€ä¸‹ThreadLocalï¼Œæ¯•ç«Ÿä¹Ÿæ˜¯ä¸€ä¸ªååˆ†é‡è¦çš„çŸ¥è¯†ç‚¹ï¼‰ã€‚è¿™æ ·ä»¥æ¥å°±æ˜ç¡®äº†ï¼šæ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰æœ€å¤šä¸€ä¸ªlooperï¼Œå¹¶ä¸”å­˜å‚¨åœ¨threadLocalé‡Œã€‚è°ƒç”¨getä¾¿å¯ä»¥å¾—åˆ°å½“å‰çº¿ç¨‹çš„looperã€‚ä½†æ˜¯é™¤äº†ä¸»çº¿ç¨‹ä»¥å¤–ï¼ˆä¸»çº¿ç¨‹çš„æ¶ˆæ¯æœºåˆ¶ä¸‹æ–‡ä¼šé‡ç‚¹è®¨è®ºï¼‰ï¼Œçº¿ç¨‹é»˜è®¤æ˜¯æ²¡æœ‰looperçš„ï¼Œéœ€è¦è‡ªå·±é€šè¿‡prepareåˆ›å»ºã€‚å¦‚æ­¤ï¼Œgetæ–¹æ³•å°±æœ‰å¯èƒ½è¿”å›nullã€‚å½“è¿”å›nullæ—¶ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ä»¥ä¸Šæˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼šä½¿ç”¨æ— å‚æ„é€ æ–¹æ³•ï¼Œå¿…é¡»ç¡®ä¿å½“å‰çº¿ç¨‹æŒæœ‰looperï¼Œå¦åˆ™å°±ä¼šå¯¼è‡´å¼‚å¸¸æŠ›å‡ºã€‚å› æ­¤ï¼Œè¿™ä¸ªæ–¹æ³•è¢«åºŸå¼ƒä¹Ÿå°±ä¸è¶³ä¸ºå¥‡äº†ã€‚ç›¸åº”åœ°ï¼Œgoogleå»ºè®®æˆ‘ä»¬ä½¿ç”¨å¦ä¸€ä¸ªæ„é€ æ–¹æ³•ä»£æ›¿ï¼š<br>2. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Handler</span><span class="params">(<span class="meta">@NonNull</span> Looper looper)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(looper, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ„é€ æ–¹æ³•åŒæ ·åœ¨å†…éƒ¨è°ƒç”¨äº†å¦ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Handler</span><span class="params">(<span class="meta">@NonNull</span> Looper looper, <span class="meta">@Nullable</span> Callback callback, <span class="type">boolean</span> async)</span> &#123;</span><br><span class="line">    mLooper = looper;</span><br><span class="line">    mQueue = looper.mQueue;</span><br><span class="line">    mCallback = callback;</span><br><span class="line">    mAsynchronous = async;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯è§è¿™é‡Œç›´æ¥ä½¿ç”¨äº†å‚æ•°æŒ‡å®šçš„looperï¼Œå¹¶è·å¾—äº†å…¶å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p>
<h1 id="MQçš„å·¥ä½œåŸç†"><a href="#MQçš„å·¥ä½œåŸç†" class="headerlink" title="MQçš„å·¥ä½œåŸç†"></a>MQçš„å·¥ä½œåŸç†</h1><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†handlerå¯¹è±¡ï¼Œå¹¶ä¸”è¿™ä¸ªhandlerå†…éƒ¨æŒæœ‰æŸä¸ªçº¿ç¨‹çš„looperå’ŒmessageQueueçš„å¯¹è±¡ã€‚æ¥ç€ï¼Œå°±å¯ä»¥è°ƒç”¨handlerçš„send&#x2F;postæ–¹æ³•å‘é€æ¶ˆæ¯äº†ã€‚ç”±äºæŸ¥çœ‹æºç å¯ä»¥çŸ¥é“postæ–¹æ³•æœ¬è´¨ä¸Šè¿˜æ˜¯å°†runnableåŒ…è£…æˆmessageåè°ƒç”¨sendç³»åˆ—æ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œå°±ç›´æ¥çœ‹sendç³»åˆ—æ–¹æ³•ã€‚è­¬å¦‚è°ƒç”¨sendMessageæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> sendMessageDelayed(msg, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†…éƒ¨è°ƒç”¨äº†å¦ä¸€ä¸ªæ–¹æ³•sendMessageDelayedã€‚ç”±æ­¤å¯è§ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨sendMessageDelayedå¹¶æŒ‡å®šä¸€ä¸ªå»¶è¿Ÿæ—¶é—´ï¼Œå®ç°<strong>å®šæ—¶ä»»åŠ¡</strong>çš„æ•ˆæœã€‚èµ°è¿›è¿™ä¸ªæ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">sendMessageDelayed</span><span class="params">(<span class="meta">@NonNull</span> Message msg, <span class="type">long</span> delayMillis)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (delayMillis &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        delayMillis = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆè°ƒç”¨äº†å¦ä¸€ä¸ªæ–¹æ³•sendMessageAtTimeã€‚èµ°è¿›è¿™ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendMessageAtTime</span><span class="params">(<span class="meta">@NonNull</span> Message msg, <span class="type">long</span> uptimeMillis)</span> &#123;</span><br><span class="line">        <span class="type">MessageQueue</span> <span class="variable">queue</span> <span class="operator">=</span> mQueue;</span><br><span class="line">        <span class="keyword">if</span> (queue == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">RuntimeException</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                    <span class="built_in">this</span> + <span class="string">&quot; sendMessageAtTime() called with no mQueue&quot;</span>);</span><br><span class="line">            Log.w(<span class="string">&quot;Looper&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> enqueueMessage(queue, msg, uptimeMillis);</span><br><span class="line">    &#125;</span><br><span class="line">```    </span><br><span class="line">å¯ä»¥çœ‹è§ï¼Œé¦–å…ˆæ–¹æ³•è¯•å›¾è·å–ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚æœè·å–ä¸åˆ°åˆ™ä¼šå‘å‡ºè­¦å‘Šå¹¶è¿”å›<span class="literal">false</span>ï¼Œé‚£ä¹ˆæ¶ˆæ¯åˆ™å‘é€å¤±è´¥ï¼Œä¸äº†äº†ä¹‹ã€‚å¦åˆ™ï¼Œæ¥ä¸‹æ¥ä¼šè°ƒç”¨enqueueMessageæ–¹æ³•ï¼Œèµ°è¿›è¿™ä¸ªæ–¹æ³•ï¼š</span><br><span class="line">```java</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">enqueueMessage</span><span class="params">(<span class="meta">@NonNull</span> MessageQueue queue, <span class="meta">@NonNull</span> Message msg,</span></span><br><span class="line"><span class="params">            <span class="type">long</span> uptimeMillis)</span> &#123;</span><br><span class="line">        msg.target = <span class="built_in">this</span>;</span><br><span class="line">        msg.workSourceUid = ThreadLocalWorkSource.getUid();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mAsynchronous) &#123;</span><br><span class="line">            msg.setAsynchronous(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);</span><br><span class="line">    &#125;</span><br><span class="line">```    </span><br><span class="line">ç›´æ¥çœ‹æœ€åä¸€è¡Œï¼Œå‘ç°ç»è¿‡ä¸€ç³»åˆ—æ–¹æ³•ï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„enqueueMessageæ–¹æ³•ï¼Œä¹Ÿæ˜¯æ¶ˆæ¯é˜Ÿåˆ—å·¥ä½œè¾ƒä¸ºé‡è¦çš„ä¸€ä¸ªæ–¹æ³•ã€‚èµ°è¿›è¿™ä¸ªæ–¹æ³•ï¼š</span><br><span class="line">```java</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">enqueueMessage</span><span class="params">(Message msg, <span class="type">long</span> <span class="keyword">when</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (msg.target == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Message must have a target.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (msg.isInUse()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(msg + <span class="string">&quot; This message is already in use.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">                    <span class="type">IllegalStateException</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                            msg.target + <span class="string">&quot; sending message to a Handler on a dead thread&quot;</span>);</span><br><span class="line">                    Log.w(TAG, e.getMessage(), e);</span><br><span class="line">                    msg.recycle();</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                msg.markInUse();</span><br><span class="line">                msg.<span class="keyword">when</span> = <span class="keyword">when</span>;</span><br><span class="line">                <span class="type">Message</span> <span class="variable">p</span> <span class="operator">=</span> mMessages;</span><br><span class="line">                <span class="type">boolean</span> needWake;</span><br><span class="line">                <span class="keyword">if</span> (p == <span class="literal">null</span> || <span class="keyword">when</span> == <span class="number">0</span> || <span class="keyword">when</span> &lt; p.<span class="keyword">when</span>) &#123;</span><br><span class="line">                    <span class="comment">// New head, wake up the event queue if blocked.</span></span><br><span class="line">                    msg.next = p;</span><br><span class="line">                    mMessages = msg;</span><br><span class="line">                    needWake = mBlocked;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Inserted within the middle of the queue.  Usually we don&#x27;t have to wake</span></span><br><span class="line">                    <span class="comment">// up the event queue unless there is a barrier at the head of the queue</span></span><br><span class="line">                    <span class="comment">// and the message is the earliest asynchronous message in the queue.</span></span><br><span class="line">                    needWake = mBlocked &amp;&amp; p.target == <span class="literal">null</span> &amp;&amp; msg.isAsynchronous();</span><br><span class="line">                    Message prev;</span><br><span class="line">                    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                        prev = p;</span><br><span class="line">                        p = p.next;</span><br><span class="line">                        <span class="keyword">if</span> (p == <span class="literal">null</span> || <span class="keyword">when</span> &lt; p.<span class="keyword">when</span>) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (needWake &amp;&amp; p.isAsynchronous()) &#123;</span><br><span class="line">                            needWake = <span class="literal">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    msg.next = p; <span class="comment">// invariant: p == prev.next</span></span><br><span class="line">                    prev.next = msg;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// We can assume mPtr != 0 because mQuitting is false.</span></span><br><span class="line">                <span class="keyword">if</span> (needWake) &#123;</span><br><span class="line">                    nativeWake(mPtr);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">```        </span><br><span class="line">è™½ç„¶ä¸Šé¢çš„ä»£ç æ¯”è¾ƒé•¿ï¼Œä½†å…¶å®åªåšäº†ä¸€ä»¶å¾ˆç®€å•çš„äº‹æƒ…ï¼šå‘æ¶ˆæ¯é˜Ÿåˆ—æ’å…¥å½“å‰æ¶ˆæ¯ã€‚</span><br><span class="line">é¦–å…ˆï¼Œæˆ‘ä»¬è¦äº†è§£æ¶ˆæ¯é˜Ÿåˆ—åº•å±‚é‡‡ç”¨çš„æ•°æ®ç»“æ„ã€‚è™½ç„¶ç§°ä½œé˜Ÿåˆ—ï¼Œå…¶æœ¬è´¨ä¸Šåªæ˜¯ä¸€ä¸ªæ™®é€šçš„å•é“¾è¡¨ã€‚è¿™ç‚¹å¯ä»messageç±»çš„æºç å°è¯ï¼š</span><br><span class="line">```java</span><br><span class="line">  ...</span><br><span class="line">    <span class="comment">// sometimes we store linked lists of these things</span></span><br><span class="line">        <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">        <span class="comment">/*package*/</span> Message next;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸ªmessageå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªnextæŒ‡é’ˆåŸŸã€‚<br>enqueueMessageé¦–å…ˆä¼šå¯¹ä¸€äº›ç‰¹æ®Šæƒ…å†µè¿›è¡Œå¤„ç†ï¼Œæ¥ç€ä¸Šäº†synchronizeä¿è¯å¯¹é“¾è¡¨çš„è®¿é—®æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æ¥ç€åˆ†ä¸¤ç§æƒ…å†µï¼šç¬¬ä¸€æ¬¡æ’å…¥ï¼Œå”¤é†’é˜»å¡çš„é˜Ÿåˆ—å¹¶åˆ›å»ºæ–°å¤´ï¼Œæ’å…¥ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œå¦åˆ™å°±å°¾æ’åˆ°é“¾è¡¨å°¾éƒ¨ã€‚<br>é‚£ä¹ˆï¼Œlooperæ˜¯å¦‚ä½•å–å‡ºmqä¸­çš„æ¶ˆæ¯çš„å‘¢ï¼Ÿè¿™é‡Œå°±è¦è°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•next()äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">Message <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Return here if the message loop has already quit and been disposed.</span></span><br><span class="line">    <span class="comment">// This can happen if the application tries to restart a looper after quit</span></span><br><span class="line">    <span class="comment">// which is not supported.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">ptr</span> <span class="operator">=</span> mPtr;</span><br><span class="line">    <span class="keyword">if</span> (ptr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">pendingIdleHandlerCount</span> <span class="operator">=</span> -<span class="number">1</span>; <span class="comment">// -1 only during first iteration</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">nextPollTimeoutMillis</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) &#123;</span><br><span class="line">            Binder.flushPendingCommands();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nativePollOnce(ptr, nextPollTimeoutMillis);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="comment">// Try to retrieve the next message.  Return if found.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> SystemClock.uptimeMillis();</span><br><span class="line">            <span class="type">Message</span> <span class="variable">prevMsg</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mMessages;</span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="literal">null</span> &amp;&amp; msg.target == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span></span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    prevMsg = msg;</span><br><span class="line">                    msg = msg.next;</span><br><span class="line">                &#125; <span class="keyword">while</span> (msg != <span class="literal">null</span> &amp;&amp; !msg.isAsynchronous());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (now &lt; msg.<span class="keyword">when</span>) &#123;</span><br><span class="line">                    <span class="comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span></span><br><span class="line">                    nextPollTimeoutMillis = (<span class="type">int</span>) Math.min(msg.<span class="keyword">when</span> - now, Integer.MAX_VALUE);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Got a message.</span></span><br><span class="line">                    mBlocked = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (prevMsg != <span class="literal">null</span>) &#123;</span><br><span class="line">                        prevMsg.next = msg.next;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mMessages = msg.next;</span><br><span class="line">                    &#125;</span><br><span class="line">                    msg.next = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">&quot;Returning message: &quot;</span> + msg);</span><br><span class="line">                    msg.markInUse();</span><br><span class="line">                    <span class="keyword">return</span> msg;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// No more messages.</span></span><br><span class="line">                nextPollTimeoutMillis = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Process the quit message now that all pending messages have been handled.</span></span><br><span class="line">            <span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">                dispose();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If first time idle, then get the number of idlers to run.</span></span><br><span class="line">            <span class="comment">// Idle handles only run if the queue is empty or if the first message</span></span><br><span class="line">            <span class="comment">// in the queue (possibly a barrier) is due to be handled in the future.</span></span><br><span class="line">            <span class="keyword">if</span> (pendingIdleHandlerCount &lt; <span class="number">0</span></span><br><span class="line">                    &amp;&amp; (mMessages == <span class="literal">null</span> || now &lt; mMessages.<span class="keyword">when</span>)) &#123;</span><br><span class="line">                pendingIdleHandlerCount = mIdleHandlers.size();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (pendingIdleHandlerCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// No idle handlers to run.  Loop and wait some more.</span></span><br><span class="line">                mBlocked = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mPendingIdleHandlers == <span class="literal">null</span>) &#123;</span><br><span class="line">                mPendingIdleHandlers = <span class="keyword">new</span> <span class="title class_">IdleHandler</span>[Math.max(pendingIdleHandlerCount, <span class="number">4</span>)];</span><br><span class="line">            &#125;</span><br><span class="line">            mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Run the idle handlers.</span></span><br><span class="line">        <span class="comment">// We only ever reach this code block during the first iteration.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; pendingIdleHandlerCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">IdleHandler</span> <span class="variable">idler</span> <span class="operator">=</span> mPendingIdleHandlers[i];</span><br><span class="line">            mPendingIdleHandlers[i] = <span class="literal">null</span>; <span class="comment">// release the reference to the handler</span></span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">keep</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                keep = idler.queueIdle();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                Log.wtf(TAG, <span class="string">&quot;IdleHandler threw exception&quot;</span>, t);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!keep) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                    mIdleHandlers.remove(idler);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Reset the idle handler count to 0 so we do not run them again.</span></span><br><span class="line">        pendingIdleHandlerCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// While calling an idle handler, a new message could have been delivered</span></span><br><span class="line">        <span class="comment">// so go back and look again for a pending message without waiting.</span></span><br><span class="line">        nextPollTimeoutMillis = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç ä¸­æ¶‰åŠåˆ°è®¸å¤šå€¼å¾—æ³¨æ„çš„åœ°æ–¹ï¼Œæ¯”å¦‚åŒæ­¥å±éšœæœºåˆ¶çš„å®ç°ç­‰ã€‚ä½†ç›®å‰æˆ‘ä»¬åªå…³å¿ƒnext()æ–¹æ³•çš„ä¸»è¦ä½œç”¨ï¼šå–å‡ºæ¶ˆæ¯é˜Ÿåˆ—ä¸­ä¸‹ä¸€ä¸ªæ¶ˆæ¯ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> SystemClock.uptimeMillis();</span><br><span class="line"><span class="type">Message</span> <span class="variable">prevMsg</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mMessages;</span><br><span class="line"><span class="keyword">if</span> (msg != <span class="literal">null</span> &amp;&amp; msg.target == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Stalled by a barrier.  Find the next asynchronousmessage in the queue.</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        prevMsg = msg;</span><br><span class="line">        msg = msg.next;</span><br><span class="line">    &#125; <span class="keyword">while</span> (msg != <span class="literal">null</span> &amp;&amp; !msg.isAsynchronous());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (msg != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (now &lt; msg.<span class="keyword">when</span>) &#123;</span><br><span class="line">        <span class="comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span></span><br><span class="line">        nextPollTimeoutMillis = (<span class="type">int</span>) Math.min(msg.<span class="keyword">when</span> - now, Integer.MAX_VALUE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Got a message.</span></span><br><span class="line">        mBlocked = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (prevMsg != <span class="literal">null</span>) &#123;</span><br><span class="line">            prevMsg.next = msg.next;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mMessages = msg.next;</span><br><span class="line">        &#125;</span><br><span class="line">        msg.next = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">&quot;Returning message: &quot;</span> + msg);</span><br><span class="line">        msg.markInUse();</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// No more messages.</span></span><br><span class="line">    nextPollTimeoutMillis = -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Process the quit message now that all pending messages have been handled.</span></span><br><span class="line"><span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">    dispose();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆè·å–äº†å½“å‰ç³»ç»Ÿæ—¶é—´nowã€‚æ¥ç€å¼€å§‹éå†æ¶ˆæ¯é˜Ÿåˆ—ã€‚å¦‚æœé‡åˆ°å±éšœï¼Œåˆ™è·³è¿‡æ™®é€šæ¶ˆæ¯å¯»æ‰¾ä¸‹ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯ï¼ˆæš‚ä¸”ä¸ç®¡ï¼‰ã€‚è€Œå¦‚æœéå†åˆ°çš„æ¶ˆæ¯çš„whenå­—æ®µå¤§äºå½“å‰æ—¶é—´ï¼Œè¯´æ˜è¿™ä¸ªæ¶ˆæ¯è¿˜æœªå‡†å¤‡å¥½ï¼Œäºæ˜¯ä¸å…ˆå–å‡ºè€Œæ˜¯è®¾ç½®äº†ä¸€ä¸ªå”¤é†’æ—¶é—´ï¼Œç­‰åˆ°æ—¶é—´æ—¶å†å–å‡ºã€‚å¦åˆ™ï¼Œå–å‡ºå½“å‰æ¶ˆæ¯ï¼Œå¹¶è¿”å›ç»™è°ƒç”¨è€…ï¼ˆlooperï¼‰ã€‚è€Œå¦‚æœè¿Ÿè¿Ÿæ²¡æœ‰è¿”å›ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å°±ä¼šè®¾ç½®nextPollTimeoutMillisä¸º-1ï¼Œå¹¶æ— é™å¾ªç¯åœ°é˜»å¡ä¸‹å»ï¼Œç›´åˆ°å–å‡ºå¹¶è¿”å›å¯ç”¨çš„æ¶ˆæ¯ã€‚æœ€åæ˜¯æ¶ˆæ¯é˜Ÿåˆ—é€€å‡ºæ—¶çš„ä¸€äº›å–„åæ“ä½œã€‚<br>å¦‚æ­¤ä»¥æ¥ï¼Œæ¶ˆæ¯é˜Ÿåˆ—çš„å·¥ä½œåŸç†æˆ‘ä»¬å°±å¤§è‡´æ¸…æ™°äº†ã€‚</p>
<h1 id="Looperçš„å·¥ä½œåŸç†"><a href="#Looperçš„å·¥ä½œåŸç†" class="headerlink" title="Looperçš„å·¥ä½œåŸç†"></a>Looperçš„å·¥ä½œåŸç†</h1><p>handlerè´Ÿè´£å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ï¼Œmessage queueè´Ÿè´£æŒ‰FIFOæ–¹å¼å­˜å‚¨æ¶ˆæ¯ï¼Œè€Œlooperåˆ™è´Ÿè´£æ— é™æœŸåœ°ä»mqä¸­å–å‡ºæ¶ˆæ¯å¹¶åˆ†å‘ç»™handlerã€‚looperçš„æ ¸å¿ƒæ–¹æ³•æ˜¯loop()ã€‚<br>æˆ‘ä»¬å…ˆäº†è§£ä¸€äº›looperç±»çš„å­—æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Looper&gt; sThreadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Looper&gt;();</span><br><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Looper sMainLooper;  <span class="comment">// guarded by Looper.class</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Observer sObserver;</span><br><span class="line"></span><br><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="keyword">final</span> MessageQueue mQueue;</span><br><span class="line"><span class="keyword">final</span> Thread mThread;</span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> mInLoop;</span><br><span class="line"></span><br><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="keyword">private</span> Printer mLogging;</span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> mTraceTag;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­sThreadLocalæˆ‘ä»¬å·²ç»ä¸é™Œç”Ÿäº†ï¼Œç”¨æ¥ä¿å­˜ä¸åŒçº¿ç¨‹çš„Looperå¯¹è±¡ï¼›sMainLooperæ˜¯ä¸»çº¿ç¨‹çš„looperï¼Œè¿™ä¸ªæ¯”è¾ƒç‰¹æ®Šã€‚sObserveræ˜¯ç”¨æ¥å¤„ç†äº‹åŠ¡çš„è§‚å¯Ÿè€…ï¼ˆæš‚ä¸”ä¸ç®¡ï¼‰ã€‚mQueueç”¨æ¥ä¿å­˜æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒmThreadæ˜¯å½“å‰å·¥ä½œçº¿ç¨‹ã€‚mInLoopæ ‡è®°looperæ­£åœ¨å·¥ä½œå½“ä¸­ã€‚mLoggingæ˜¯æ—¥å¿—å·¥å…·ã€‚</p>
<p>å‰é¢å·²ç»æåˆ°ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹å¿…é¡»å…ˆæ„é€ looperï¼Œæ¶ˆæ¯æœºåˆ¶æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚é‚£ä¹ˆæˆ‘ä»¬å°±æ¥çœ‹ä¸€çœ‹Looperçš„æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">Looper</span><span class="params">(<span class="type">boolean</span> quitAllowed)</span> &#123;</span><br><span class="line">    mQueue = <span class="keyword">new</span> <span class="title class_">MessageQueue</span>(quitAllowed);</span><br><span class="line">    mThread = Thread.currentThread();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯è§è¿™é‡Œå°±æ˜¯ç®€å•åœ°æ„é€ äº†looperå¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶ä¿å­˜äº†å½“å‰çš„çº¿ç¨‹å¯¹è±¡ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªå”¯ä¸€çš„æ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œè¯´æ˜æˆ‘ä»¬ä¸èƒ½ç›´æ¥é€šè¿‡newè·å–ä¸€ä¸ªlooperã€‚ç›¸åï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨prepare()æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">prepare</span><span class="params">()</span> &#123;</span><br><span class="line">    prepare(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">prepare</span><span class="params">(<span class="type">boolean</span> quitAllowed)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sThreadLocal.get() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Only one Looper may be created per thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sThreadLocal.set(<span class="keyword">new</span> <span class="title class_">Looper</span>(quitAllowed));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨prepareæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¼šå…ˆå°è¯•ä»threadLocalä¸­è·å–looperï¼Œçœ‹çœ‹å½“å‰çº¿ç¨‹æ˜¯å¦å·²ç»æœ‰looperäº†ã€‚å¦‚æœæœ‰ï¼Œå°†ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä»¥æ­¤ä¿è¯æ¯ä¸ªçº¿ç¨‹åªèƒ½æŒæœ‰æœ€å¤šä¸€ä¸ªlooperå¯¹è±¡ã€‚å¦‚æœæ²¡æœ‰ï¼Œå°±ä¼šæ„é€ looperå¹¶æ”¾å…¥threadLocalä¸­ã€‚</p>
<p>å‰é¢æˆ‘ä»¬åå¤æåˆ°äº†ä¸»çº¿ç¨‹looperçš„ç‰¹æ®Šæ€§ã€‚å®é™…ä¸Šï¼ŒLooperç±»è¿˜æä¾›äº†ä¸€ä¸ªprepareMainLooper()æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">prepareMainLooper</span><span class="params">()</span> &#123;</span><br><span class="line">        prepare(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">synchronized</span> (Looper.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sMainLooper != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;The main Looper has already been prepared.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sMainLooper = myLooper();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">```    </span><br><span class="line">è¿™ä¸ªæ–¹æ³•åŸæœ¬ç”¨äºè®©ActivityThreadåˆ›å»ºä¸»çº¿ç¨‹looperï¼Œä½†ç°åœ¨å®‰å“ç¯å¢ƒä¼šè‡ªå·±å¸®ä½ åˆ›å»ºï¼Œäºæ˜¯è¿™ä¸ªæ–¹æ³•å°±è¢«åºŸå¼ƒäº†ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“ä¸»çº¿ç¨‹looperæ˜¯ç³»ç»Ÿè‡ªèº«å·²ç»åˆ›å»ºå¥½çš„ï¼Œä¸éœ€è¦è‡ªå·±å†è°ƒç”¨prepareæ–¹æ³•åˆ›å»ºã€‚</span><br><span class="line">ä¸‹é¢æˆ‘ä»¬å¼€å§‹ä»‹ç»loop()æ–¹æ³•ã€‚åªæœ‰è°ƒç”¨äº†loop()ï¼Œæ¶ˆæ¯å¾ªç¯æ‰èƒ½çœŸæ­£èµ·ä½œç”¨ã€‚</span><br><span class="line">```java</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Looper</span> <span class="variable">me</span> <span class="operator">=</span> myLooper();</span><br><span class="line">        <span class="keyword">if</span> (me == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;No Looper; Looper.prepare() wasn&#x27;t called on this thread.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (me.mInLoop) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Loop again would have the queued messages be executed&quot;</span></span><br><span class="line">                    + <span class="string">&quot; before this one completed.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        me.mInLoop = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">MessageQueue</span> <span class="variable">queue</span> <span class="operator">=</span> me.mQueue;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure the identity of this thread is that of the local process,</span></span><br><span class="line">        <span class="comment">// and keep track of what that identity token actually is.</span></span><br><span class="line">        Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">ident</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Allow overriding a threshold with a system prop. e.g.</span></span><br><span class="line">        <span class="comment">// adb shell &#x27;setprop log.looper.1000.main.slow 1 &amp;&amp; stop &amp;&amp; start&#x27;</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">thresholdOverride</span> <span class="operator">=</span></span><br><span class="line">                SystemProperties.getInt(<span class="string">&quot;log.looper.&quot;</span></span><br><span class="line">                        + Process.myUid() + <span class="string">&quot;.&quot;</span></span><br><span class="line">                        + Thread.currentThread().getName()</span><br><span class="line">                        + <span class="string">&quot;.slow&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">slowDeliveryDetected</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> queue.next(); <span class="comment">// might block</span></span><br><span class="line">            <span class="keyword">if</span> (msg == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// No message indicates that the message queue is quitting.</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Printer</span> <span class="variable">logging</span> <span class="operator">=</span> me.mLogging;</span><br><span class="line">            <span class="keyword">if</span> (logging != <span class="literal">null</span>) &#123;</span><br><span class="line">                logging.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot;</span> + msg.target + <span class="string">&quot; &quot;</span> +</span><br><span class="line">                        msg.callback + <span class="string">&quot;: &quot;</span> + msg.what);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Make sure the observer won&#x27;t change while processing a transaction.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Observer</span> <span class="variable">observer</span> <span class="operator">=</span> sObserver;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">traceTag</span> <span class="operator">=</span> me.mTraceTag;</span><br><span class="line">            <span class="type">long</span> <span class="variable">slowDispatchThresholdMs</span> <span class="operator">=</span> me.mSlowDispatchThresholdMs;</span><br><span class="line">            <span class="type">long</span> <span class="variable">slowDeliveryThresholdMs</span> <span class="operator">=</span> me.mSlowDeliveryThresholdMs;</span><br><span class="line">            <span class="keyword">if</span> (thresholdOverride &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                slowDispatchThresholdMs = thresholdOverride;</span><br><span class="line">                slowDeliveryThresholdMs = thresholdOverride;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">logSlowDelivery</span> <span class="operator">=</span> (slowDeliveryThresholdMs &gt; <span class="number">0</span>) &amp;&amp; (msg.<span class="keyword">when</span> &gt; <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">logSlowDispatch</span> <span class="operator">=</span> (slowDispatchThresholdMs &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">needStartTime</span> <span class="operator">=</span> logSlowDelivery || logSlowDispatch;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">needEndTime</span> <span class="operator">=</span> logSlowDispatch;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (traceTag != <span class="number">0</span> &amp;&amp; Trace.isTagEnabled(traceTag)) &#123;</span><br><span class="line">                Trace.traceBegin(traceTag, msg.target.getTraceName(msg));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">dispatchStart</span> <span class="operator">=</span> needStartTime ? SystemClock.uptimeMillis() : <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> dispatchEnd;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">token</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (observer != <span class="literal">null</span>) &#123;</span><br><span class="line">                token = observer.messageDispatchStarting();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">long</span> <span class="variable">origWorkSource</span> <span class="operator">=</span> ThreadLocalWorkSource.setUid(msg.workSourceUid);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                msg.target.dispatchMessage(msg);</span><br><span class="line">                <span class="keyword">if</span> (observer != <span class="literal">null</span>) &#123;</span><br><span class="line">                    observer.messageDispatched(token, msg);</span><br><span class="line">                &#125;</span><br><span class="line">                dispatchEnd = needEndTime ? SystemClock.uptimeMillis() : <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">                <span class="keyword">if</span> (observer != <span class="literal">null</span>) &#123;</span><br><span class="line">                    observer.dispatchingThrewException(token, msg, exception);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> exception;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                ThreadLocalWorkSource.restore(origWorkSource);</span><br><span class="line">                <span class="keyword">if</span> (traceTag != <span class="number">0</span>) &#123;</span><br><span class="line">                    Trace.traceEnd(traceTag);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logSlowDelivery) &#123;</span><br><span class="line">                <span class="keyword">if</span> (slowDeliveryDetected) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((dispatchStart - msg.<span class="keyword">when</span>) &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">&quot;Drained&quot;</span>);</span><br><span class="line">                        slowDeliveryDetected = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (showSlowLog(slowDeliveryThresholdMs, msg.<span class="keyword">when</span>, dispatchStart, <span class="string">&quot;delivery&quot;</span>,</span><br><span class="line">                            msg)) &#123;</span><br><span class="line">                        <span class="comment">// Once we write a slow delivery log, suppress until the queue drains.</span></span><br><span class="line">                        slowDeliveryDetected = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logSlowDispatch) &#123;</span><br><span class="line">                showSlowLog(slowDispatchThresholdMs, dispatchStart, dispatchEnd, <span class="string">&quot;dispatch&quot;</span>, msg);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (logging != <span class="literal">null</span>) &#123;</span><br><span class="line">                logging.println(<span class="string">&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot;</span> + msg.target + <span class="string">&quot; &quot;</span> + msg.callback);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Make sure that during the course of dispatching the</span></span><br><span class="line">            <span class="comment">// identity of the thread wasn&#x27;t corrupted.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">newIdent</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">            <span class="keyword">if</span> (ident != newIdent) &#123;</span><br><span class="line">                Log.wtf(TAG, <span class="string">&quot;Thread identity changed from 0x&quot;</span></span><br><span class="line">                        + Long.toHexString(ident) + <span class="string">&quot; to 0x&quot;</span></span><br><span class="line">                        + Long.toHexString(newIdent) + <span class="string">&quot; while dispatching to &quot;</span></span><br><span class="line">                        + msg.target.getClass().getName() + <span class="string">&quot; &quot;</span></span><br><span class="line">                        + msg.callback + <span class="string">&quot; what=&quot;</span> + msg.what);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            msg.recycleUnchecked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">```java</span><br><span class="line">æå–å‡ºæ ¸å¿ƒä»£ç ï¼Œå…¶å®loopçš„å·¥ä½œéå¸¸ç®€å•ï¼š</span><br><span class="line">```java</span><br><span class="line">    <span class="title function_">for</span> <span class="params">(;;)</span> &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> queue.next(); <span class="comment">// might block</span></span><br><span class="line">        <span class="keyword">if</span> (msg == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// No message indicates that the message queue is quitting.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>å°±æ˜¯æ— é™å¾ªç¯åœ°è°ƒç”¨mqçš„next()æ–¹æ³•ï¼Œç›´åˆ°mqé€€å‡ºè¿”å›Nullã€‚ä»€ä¹ˆæ—¶å€™mqè¿”å›nullå‘¢ï¼Ÿå½“looperè°ƒç”¨quitæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">quit</span><span class="params">()</span> &#123;</span><br><span class="line">        mQueue.quit(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">```    </span><br><span class="line">ä¼šæ¥ç€è°ƒç”¨mqçš„quit:</span><br><span class="line">```java</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">quit</span><span class="params">(<span class="type">boolean</span> safe)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mQuitAllowed) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Main thread not allowed to quit.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mQuitting = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (safe) &#123;</span><br><span class="line">                removeAllFutureMessagesLocked();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                removeAllMessagesLocked();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We can assume mPtr != 0 because mQuitting was previously false.</span></span><br><span class="line">            nativeWake(mPtr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">```    </span><br><span class="line">è¿™é‡Œå°†æ¶ˆæ¯é˜Ÿåˆ—çš„mQuittingè®¾ç½®ä¸ºäº†<span class="literal">true</span>ã€‚å†çœ‹next()ä¸­çš„ä¸€æ®µä»£ç ï¼š</span><br><span class="line">```java</span><br><span class="line">    <span class="comment">// Process the quit message now that all pending messages have been handled.</span></span><br><span class="line">    <span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">        dispose();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ç”±æ­¤å¯è§ï¼Œlooperè°ƒç”¨quitæ—¶ï¼Œmqå°±ä¼šé€€å‡ºã€‚æ¶ˆæ¯å¾ªç¯ç»ˆæ­¢ã€‚<br>ç°åœ¨ï¼Œæˆ‘ä»¬æœ‰äº†looperï¼Œå½“Looperä»mqä¸­å–å‡ºäº†ä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œå°±ä¼šå¯¹å…¶è¿›è¡Œå¤„ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    msg.target.dispatchMessage(msg);</span><br><span class="line">```    </span><br><span class="line">å…¶ä¸­ï¼Œmsg.targetå°±æ˜¯å‘é€è¿™æ¡æ¶ˆæ¯çš„å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨handlerå‘é€ä¸€æ¡æ¶ˆæ¯åï¼Œè¿™æ¡æ¶ˆæ¯ç»è¿‡æ”¾å…¥mqï¼Œå†è¢«looperå–å‡ºï¼Œåˆè¢«looperåˆ†å‘ç»™äº†åŒä¸€ä¸ªhandlerã€‚åªä¸è¿‡handlerå¯¹è±¡è™½ç„¶æ˜¯åŒä¸€ä¸ªï¼Œå‘é€å’Œæ¥æ”¶æ¶ˆæ¯æ—¶æ‰€å¤„çš„çº¿ç¨‹å´ä¸ä¸€å®šç›¸åŒã€‚ä¸‹é¢æˆ‘ä»¬ä¸€æ¢handlerçš„dispatchMessage()æ–¹æ³•ï¼š</span><br><span class="line"></span><br><span class="line"># Handlerçš„å·¥ä½œåŸç†</span><br><span class="line">å¦‚ä½•ä½¿ç”¨handlerå‘é€æ¶ˆæ¯ï¼Œå·²ç»åœ¨ä»‹ç»MQæ—¶è¯´è¿‡äº†ã€‚æˆ‘ä»¬ä¸»è¦çœ‹ä¸€çœ‹handleræ˜¯å¦‚ä½•å¤„ç†Looperå–å‡ºçš„æ¶ˆæ¯çš„ï¼š</span><br><span class="line">```java</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dispatchMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.callback != <span class="literal">null</span>) &#123;</span><br><span class="line">            handleCallback(msg);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCallback != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            handleMessage(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆä¼šæ£€æŸ¥æ¶ˆæ¯ä¸­çš„callbackæ˜¯å¦ä¸ºç©ºï¼Œè¿™é‡Œcallbackå°±æ˜¯é€šè¿‡postæ–¹å¼æäº¤çš„runnableå¯¹è±¡ã€‚å¦‚æœä¸ä¸ºç©ºï¼Œè¿›ä¸€æ­¥è°ƒç”¨handleCallback()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleCallback</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        message.callback.run();</span><br><span class="line">    &#125;</span><br><span class="line">```    </span><br><span class="line">å°±æ˜¯æ‰§è¡Œrunnableçš„runæ–¹æ³•ï¼Œå®Œæˆå…¶ä¸­çš„ä»»åŠ¡ã€‚</span><br><span class="line">å¦‚æœcallbackä¸ºç©ºï¼Œä¼šæ¥ç€æ£€æŸ¥mCallbackæ˜¯å¦ä¸ºç©ºã€‚å‰é¢æˆ‘ä»¬å·²ç»ä»‹ç»è¿‡ï¼ŒmCallbackæ˜¯handlerå†…éƒ¨å®šä¹‰çš„ä¸€ä¸ªæ¥å£ï¼Œæä¾›äº†å¦ä¸€ç§ä½¿ç”¨Handlerçš„æ–¹å¼ï¼š<span class="type">Handler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Handler</span>(Callback)ï¼Œè¿™æ—¶å°±ä¼šæŒ‰ç…§callbackå†…éƒ¨çš„å¤„ç†é€»è¾‘ï¼ˆè‡ªå·±åœ¨åˆ›å»ºæ—¶å®ç°ï¼‰æ¥å¤„ç†æ–¹æ³•ã€‚æœ€åï¼Œå¦‚æœmCallbackä¸ºç©ºï¼Œè¯´æ˜å¤„ç†çš„æ˜¯æ™®é€šçš„messageã€‚è°ƒç”¨handleMessage(å¿…é¡»åœ¨åˆ›å»ºhandleræ—¶é‡å†™ï¼Œé»˜è®¤æ˜¯ä¸€ä¸ªç©ºçš„æ–¹æ³•)æ¥å¤„ç†å³å¯ã€‚</span><br><span class="line">è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¤§è‡´ææ¸…æ¥šäº†handleræ¶ˆæ¯æœºåˆ¶çš„ä¸»è¦å·¥ä½œåŸç†ï¼Œå³handler,mq,looperä¸‰å¤§ä»¶å„è‡ªçš„ä½œç”¨åŠä½¿ç”¨æ–¹æ³•ã€‚handlerä½¿ç”¨ç®€å•ï¼Œå¿«æ·ï¼Œä½†ä¹Ÿå­˜åœ¨ä¸€ä¸ªä¸€ç›´ä¸ºäººè¯Ÿç—…çš„æ½œåœ¨é—®é¢˜ï¼š**å†…å­˜æ³„éœ²**ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥æ¢è®¨handlerå¼•å‘å†…å­˜æ³„éœ²çš„é—®é¢˜å’Œå¸¸ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚</span><br><span class="line"># Handlerå†…å­˜æ³„æ¼</span><br><span class="line">ä¼—æ‰€å‘¨çŸ¥åœ¨javaä¸­ï¼Œæˆå‘˜å¯¹è±¡ä¼šé»˜è®¤éšå¼åœ°æŒæœ‰å¤–éƒ¨ç±»çš„å¯¹è±¡ã€‚å‡è®¾ç°åœ¨æˆ‘ä»¬åœ¨MainActivityä¸­åˆ›å»ºäº†ä¸€ä¸ªhandlerå¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªhandlerä¹Ÿå°±æŒæœ‰äº†MainActivityçš„å¼•ç”¨ã€‚ç°åœ¨è€ƒè™‘è¿™æ ·ä¸€ç§æƒ…å†µï¼šå¦‚æœå‘handleræäº¤äº†ä¸€ç»„ä»»åŠ¡ï¼Œå½“handlerè¿˜åœ¨å¤„ç†ä»»åŠ¡çš„æ—¶å€™é€€å‡ºMainActivityä¼šæ€ä¹ˆæ ·ï¼Ÿ</span><br><span class="line">æ­£å¸¸æ¥è¯´ï¼ŒMainActivityåº”è¯¥è¢«å›æ”¶å¹¶é‡Šæ”¾ã€‚ä½†ç”±äºæ­¤æ—¶handlerä»åœ¨å¤„ç†æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡è€Œå­˜åœ¨ï¼Œå…¶æŒæœ‰MainActivityçš„å¼•ç”¨ï¼Œå¯¼è‡´gcæ— æ³•åŠæ—¶å¯¹MainActivityè¿›è¡Œå›æ”¶ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œä¾¿å‘ç”Ÿäº†å†…å­˜æ³„éœ²ã€‚</span><br><span class="line">é€šå¸¸æƒ…å†µä¸‹ï¼Œhandlerçš„å†…å­˜æ³„éœ²éƒ½æ˜¯æš‚æ—¶çš„ï¼Œå½“å…¶ä¸­çš„ä»»åŠ¡å…¨éƒ¨å¤„ç†å®Œæ¯•æ—¶ï¼Œå†…å­˜è¿˜æ˜¯ä¼šå¾—åˆ°é‡Šæ”¾ã€‚ä½†æœ‰é—®é¢˜å°±åº”è¯¥è§£å†³ï¼Œä»¥é˜²æ­¢æ›´å¤§çš„é—®é¢˜äº§ç”Ÿã€‚å¦‚ä½•è§„é¿è¿™ç§æƒ…å†µå‘¢ï¼Ÿ</span><br><span class="line">é¦–å…ˆæˆ‘ä»¬å¯ä»¥æƒ³åˆ°ï¼Œå°†handleråŠ ä¸Š<span class="keyword">static</span>ä¿®é¥°ï¼Œ**å˜æˆé™æ€å†…éƒ¨ç±»**ï¼Œè¿™æ ·handlerå°±ä¸ä¼šå†éšå¼æŒæœ‰activityçš„å¼•ç”¨äº†ã€‚ä½†æ˜¯è¿™æ ·ï¼Œå°±åˆäº§ç”Ÿäº†ä¸€ä¸ªé—®é¢˜ï¼šé™æ€çš„handleræ— æ³•è®¿é—®activityå®ä¾‹ï¼Œå¦‚æœè¦ç”¨åˆ°activityçš„èµ„æºæ€ä¹ˆåŠï¼Ÿ</span><br><span class="line">æ–¹æ³•å¾ˆç®€å•ï¼Œè®©handleræŒæœ‰å¤–éƒ¨activityçš„**å¼±å¼•ç”¨**ä¸å°±å¥½äº†ï¼Ÿå¼±å¼•ç”¨ä¼šåœ¨é‡åˆ°gcæ—¶è¢«å›æ”¶ï¼Œè¿™æ ·å°±åŸºæœ¬ä¸Šè§£å†³äº†é—®é¢˜ã€‚</span><br><span class="line">æœ€åï¼Œæˆ‘ä»¬ä¸Šä¸€ä¸ªæ¼”ç¤ºå®ä¾‹ã€‚å‡è®¾ç°åœ¨æœ‰è¿™æ ·ä¸€ä¸ªéœ€æ±‚ï¼šè¿›å…¥appæ—¶å±•ç¤ºæ¬¢è¿ç•Œé¢ï¼Œä¸€æ®µæ—¶é—´åè·³è½¬è‡³å¦ä¸€ç•Œé¢ã€‚ä¸€ä¸ªç®€å•çš„å®ç°æ˜¯å‡†å¤‡ä¸¤ä¸ªactivityï¼Œç”¨handlerå®ç°å®šæ—¶intentè·³è½¬ã€‚</span><br><span class="line">æˆ‘ä»¬é‡‡ç”¨è‡ªå®šä¹‰handlerçš„æ–¹å¼ï¼š</span><br><span class="line">```java</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line">        WeakReference&lt;WelcomeActivity&gt; mactivity;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MyHandler</span><span class="params">(<span class="meta">@NonNull</span> Looper looper, WelcomeActivity activity)</span>&#123;</span><br><span class="line">            <span class="built_in">super</span>(looper);<span class="comment">//è°ƒç”¨çˆ¶ç±»çš„æ˜¾å¼æŒ‡æ˜çš„æ„é€ å‡½æ•°</span></span><br><span class="line">            mactivity = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;WelcomeActivity&gt;(activity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.handleMessage(msg);</span><br><span class="line"></span><br><span class="line">            <span class="type">WelcomeActivity</span> <span class="variable">nactivity</span> <span class="operator">=</span> mactivity.get();</span><br><span class="line">            <span class="keyword">if</span>(nactivity == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(mactivity.get(), LoginActivity.class);</span><br><span class="line">                    mactivity.get().startActivity(intent);</span><br><span class="line">                    mactivity.get().finish();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æˆ‘è¿™é‡Œå°±é‡‡ç”¨äº†staticå’ŒweakReferenceæ¥é¿å…å†…å­˜æ³„éœ²å’Œå¼•ç”¨activityã€‚åˆ›å»ºhandlerå®ä¾‹åï¼Œåœ¨activityçš„onCreate()ä¸­è°ƒç”¨handler.sendEmptyMessageDelayed(0,3000);å³å¯å®ç°åŠŸèƒ½ã€‚</p>
<h1 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h1><p>handleræ¶ˆæ¯æœºåˆ¶æ˜¯androidå¼€å‘é‡è¦çš„åŠŸèƒ½ï¼Œéœ€è¦æˆ‘ä»¬æ¸…æ¥šå…¶åŸç†å’Œå®ç°ã€‚<br>è¿™æ˜¯æˆ‘ç¬¬ä¸€æ¬¡å°è¯•è‡ªä¸»åˆ†ææºç ï¼Œå› æ­¤æ–‡ç« ä¸­å¯èƒ½å­˜åœ¨é”™è¯¯ï¼Œä»¥åŠä¸€äº›ç†è§£ä¸å¤Ÿæ·±å…¥ã€‚æ¬¢è¿å¤§ä½¬æå‡ºé—®é¢˜å¹¶æŒ‡æ­£ï¼</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.eynnzerr.top/2025/08/29/old-docker-principle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/otae.jpg">
      <meta itemprop="name" content="Eynnzerr">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eynnzerr's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/08/29/old-docker-principle/" class="post-title-link" itemprop="url">DockeråŸºç¡€åŸç†æ¢ç©¶</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-08-29 20:34:26 / ä¿®æ”¹æ—¶é—´ï¼š20:44:00" itemprop="dateCreated datePublished" datetime="2025-08-29T20:34:26+08:00">2025-08-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>20k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>37 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>è¯¥ç¯‡å†…å®¹ä¸ºåŸåšå®¢åšæ–‡ï¼ŒåŸä¸Šä¼ äº2021å¹´11æœˆ27æ—¥ã€‚</strong></p>
<h2 id="ä¸€ã€å‰è¨€-Dockeræ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#ä¸€ã€å‰è¨€-Dockeræ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ä¸€ã€å‰è¨€ Dockeræ˜¯ä»€ä¹ˆï¼Ÿ"></a>ä¸€ã€å‰è¨€ Dockeræ˜¯ä»€ä¹ˆï¼Ÿ</h2><blockquote>
<p>Docker takes away repetitive, mundane configuration tasks and is used throughout the development lifecycle for fast, easy and portable application development - desktop and cloud. Dockerâ€™s comprehensive end to end platform includes UIs, CLIs, APIs and security that are engineered to work together across the entire application delivery lifecycle.</p>
</blockquote>
<p>Dockeræ˜¯ä¸€ä¸ªç”¨Goç¼–å†™çš„å¼€æºå·¥å…·ï¼Œå®ƒå¯ä»¥å°†ä½ çš„åº”ç”¨æ‰“åŒ…æˆä¸€ä¸ªæ ‡å‡†æ ¼å¼çš„é•œåƒï¼Œå¹¶ä¸”ä»¥å®¹å™¨çš„æ–¹å¼è¿è¡Œã€‚Dockerå®¹å™¨å°†ä¸€ç³»åˆ—è½¯ä»¶åŒ…è£…åœ¨ä¸€ä¸ªå®Œæ•´çš„<strong>æ–‡ä»¶ç³»ç»Ÿ</strong>ä¸­ï¼Œè¿™ä¸ªæ–‡ä»¶ç³»ç»ŸåŒ…å«åº”ç”¨ç¨‹åºè¿è¡Œæ‰€éœ€è¦çš„ä¸€åˆ‡ï¼šä»£ç ã€è¿è¡Œæ—¶å·¥å…·ã€ç³»ç»Ÿå·¥å…·ã€ç³»ç»Ÿä¾èµ–ï¼Œå‡ ä¹æœ‰ä»»ä½•å¯ä»¥å®‰è£…åœ¨æœåŠ¡å™¨ä¸Šçš„ä¸œè¥¿ã€‚è¿™äº›ç­–ç•¥ä¿è¯äº†å®¹å™¨å†…åº”ç”¨ç¨‹åºè¿è¡Œç¯å¢ƒçš„ç¨³å®šæ€§ï¼Œä¸ä¼šè¢«å®¹å™¨å¤–çš„ç³»ç»Ÿç¯å¢ƒæ‰€å½±å“ã€‚</p>
<p><img src="https://i.loli.net/2021/11/16/FUWQXIS5ZNdvA7Y.jpg" alt="R-C.jpeg"></p>
<h3 id="Dockerå®¹å™¨çš„ç‰¹ç‚¹ï¼š"><a href="#Dockerå®¹å™¨çš„ç‰¹ç‚¹ï¼š" class="headerlink" title="Dockerå®¹å™¨çš„ç‰¹ç‚¹ï¼š"></a>Dockerå®¹å™¨çš„ç‰¹ç‚¹ï¼š</h3><ol>
<li>è½»é‡ï¼š åœ¨åŒä¸€å°å®¿ä¸»æœºä¸Šçš„å®¹å™¨å°†å…±äº«ç³»ç»Ÿkernelï¼Œä½¿å¾—å®ƒä»¬å¯ä»¥è¿…é€Ÿå¯åŠ¨è€Œä¸”å ç”¨è¾ƒå°‘çš„å†…å­˜ã€‚é•œåƒæ˜¯ä»¥<strong>åˆ†å±‚æ–‡ä»¶ç³»ç»Ÿ</strong>æ„é€ çš„ï¼Œè¿™å¯ä»¥è®©å®ƒä»¬å…±äº«ç›¸åŒçš„æ–‡ä»¶ï¼Œä½¿å¾—ç£ç›˜ä½¿ç”¨ç‡å’Œé•œåƒä¸‹è½½é€Ÿåº¦éƒ½å¾—åˆ°è¾ƒå¤§æé«˜ã€‚</li>
<li>å¼€æ”¾ï¼š Dockerå®¹å™¨åŸºäºå¼€æ”¾æ ‡å‡†ï¼Œä½¿å¾—å…¶å¯ä»¥è¿è¡Œåœ¨å„ç§ä¸»æµLinux Distributionå’ŒWindowsï¼Œä»¥åŠMac OSä¸Šã€‚</li>
<li>å®‰å…¨ï¼š å®¹å™¨å°†å„ä¸ªè¿è¡Œçš„åº”ç”¨ç¨‹åºç›¸äº’éš”ç¦»å¼€æ¥ï¼Œç»™æ‰€æœ‰çš„åº”ç”¨ç¨‹åºæä¾›äº†ä¸€å±‚é¢å¤–çš„å®‰å…¨é˜²æŠ¤ã€‚</li>
</ol>
<h3 id="å®¹å™¨å’Œè™šæ‹Ÿæœºç›¸æ¯”"><a href="#å®¹å™¨å’Œè™šæ‹Ÿæœºç›¸æ¯”" class="headerlink" title="å®¹å™¨å’Œè™šæ‹Ÿæœºç›¸æ¯”"></a>å®¹å™¨å’Œè™šæ‹Ÿæœºç›¸æ¯”</h3><p>å®¹å™¨å’Œè™šæ‹ŸæœºåŒæ ·å…·æœ‰èµ„æºéš”ç¦»å’Œåˆ†é…çš„åŠŸèƒ½ï¼Œä½†ç”±äºå…¶æ¶æ„çš„ä¸åŒï¼Œå®¹å™¨æ¯”è™šæ‹Ÿæœºæ›´åŠ ä¾¿æ·å’Œé«˜æ•ˆã€‚<br>é¦–å…ˆæ˜¯çŠ¯ä¸‹å‚²æ…¢ä¹‹ç½ªçš„è™šæ‹Ÿæœºï¼ŒåŒ…å«ç”¨æˆ·çš„ç¨‹åºï¼Œå¿…è¦çš„å‡½æ•°åº“å’Œæ•´ä¸ªå®¢æˆ·æ“ä½œç³»ç»Ÿï¼Œè‡³å°‘ä¹Ÿéœ€è¦å ç”¨å¥½å‡ ä¸ªGBçš„ç©ºé—´ã€‚å¦‚å›¾æ‰€ç¤ºï¼Œé™¤äº†ä½¿ç”¨HypervisoræŠ€æœ¯å¯¹ç¡¬ä»¶è®¾æ–½è¿›è¡Œè™šæ‹ŸåŒ–å¤–ï¼Œè™šæ‹Ÿæœºè¿˜å¤šä¸€å±‚guest OSã€‚<br>è€Œdockerå®¹å™¨åˆ™æ˜¯åœ¨docker engineçš„æ§åˆ¶å’Œé©±åŠ¨ä¸‹ï¼Œä»¥ç”¨æˆ·æ€è¿è¡Œï¼Œå¹¶åœ¨å®¿ä¸»æœºä¸Šäº’ç›¸éš”ç¦»ã€‚dockerç›´æ¥ä½¿ç”¨ç¡¬ä»¶èµ„æºå’Œå…±äº«å†…æ ¸ï¼Œä¸å’Œä»»ä½•åŸºç¡€è®¾æ–½ç»‘å®šã€‚</p>
<p><img src="https://i.loli.net/2021/11/16/yYOHjz3NRrJPZVp.png" alt="20006deca0fccda0d536edd626835e9e_720w.png"></p>
<h3 id="å®¹å™¨åŸºæœ¬æ¦‚å¿µ"><a href="#å®¹å™¨åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="å®¹å™¨åŸºæœ¬æ¦‚å¿µ"></a>å®¹å™¨åŸºæœ¬æ¦‚å¿µ</h3><p>æˆ‘ä»¬è¿˜æ˜¯å…ˆå›é¡¾ä¸€æ³¢dockerä¸­çš„åŸºç¡€æ¦‚å¿µã€‚</p>
<table>
<thead>
<tr>
<th align="center">åç§°</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">é•œåƒï¼ˆImageï¼‰</td>
<td>Docker é•œåƒï¼ˆImageï¼‰ï¼Œå°±ç›¸å½“äºæ˜¯ä¸€ä¸ª root æ–‡ä»¶ç³»ç»Ÿã€‚æ¯”å¦‚å®˜æ–¹é•œåƒ centos8 å°±åŒ…å«äº†å®Œæ•´çš„ä¸€å¥— CentOS 8 æœ€å°ç³»ç»Ÿçš„ root æ–‡ä»¶ç³»ç»Ÿã€‚</td>
</tr>
<tr>
<td align="center">å®¹å™¨ï¼ˆContainerï¼‰</td>
<td>é•œåƒï¼ˆImageï¼‰å’Œå®¹å™¨ï¼ˆContainerï¼‰çš„å…³ç³»ï¼Œå°±åƒæ˜¯é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡ä¸­çš„ç±»å’Œå®ä¾‹ä¸€æ ·ï¼Œé•œåƒæ˜¯é™æ€çš„å®šä¹‰ï¼Œå®¹å™¨æ˜¯é•œåƒè¿è¡Œæ—¶çš„å®ä½“ã€‚å®¹å™¨å¯ä»¥è¢«åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢ã€åˆ é™¤ã€æš‚åœç­‰ã€‚</td>
</tr>
<tr>
<td align="center">ä»“åº“ï¼ˆRepositoryï¼‰</td>
<td>ä»“åº“å¯çœ‹æˆä¸€ä¸ªä»£ç æ§åˆ¶ä¸­å¿ƒï¼Œç”¨æ¥ä¿å­˜é•œåƒã€‚</td>
</tr>
<tr>
<td align="center">Docker å®¢æˆ·ç«¯(Clientï¼‰</td>
<td>Docker å®¢æˆ·ç«¯é€šè¿‡å‘½ä»¤è¡Œæˆ–è€…å…¶ä»–å·¥å…·ä½¿ç”¨ Docker SDK (<a target="_blank" rel="noopener" href="https://docs.docker.com/develop/sdk/">https://docs.docker.com/develop/sdk/</a>) ä¸ Docker çš„å®ˆæŠ¤è¿›ç¨‹é€šä¿¡ã€‚</td>
</tr>
<tr>
<td align="center">Docker ä¸»æœº(Host)</td>
<td>ä¸€ä¸ªç‰©ç†æˆ–è€…è™šæ‹Ÿçš„æœºå™¨ç”¨äºæ‰§è¡Œ Docker å®ˆæŠ¤è¿›ç¨‹å’Œå®¹å™¨ã€‚</td>
</tr>
<tr>
<td align="center">Docker Registry</td>
<td>Docker ä»“åº“ç”¨æ¥ä¿å­˜é•œåƒï¼Œå¯ä»¥ç†è§£ä¸ºä»£ç æ§åˆ¶ä¸­çš„ä»£ç ä»“åº“ã€‚Docker Hub(<a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com</a>) æä¾›äº†åºå¤§çš„é•œåƒé›†åˆä¾›ä½¿ç”¨ã€‚ä¸€ä¸ª Docker Registry ä¸­å¯ä»¥åŒ…å«å¤šä¸ªä»“åº“ï¼ˆRepositoryï¼‰ï¼›æ¯ä¸ªä»“åº“å¯ä»¥åŒ…å«å¤šä¸ªæ ‡ç­¾ï¼ˆTagï¼‰ï¼›æ¯ä¸ªæ ‡ç­¾å¯¹åº”ä¸€ä¸ªé•œåƒã€‚é€šå¸¸ï¼Œä¸€ä¸ªä»“åº“ä¼šåŒ…å«åŒä¸€ä¸ªè½¯ä»¶ä¸åŒç‰ˆæœ¬çš„é•œåƒï¼Œè€Œæ ‡ç­¾å°±å¸¸ç”¨äºå¯¹åº”è¯¥è½¯ä»¶çš„å„ä¸ªç‰ˆæœ¬ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ &lt;ä»“åº“å&gt;:&lt;æ ‡ç­¾&gt; çš„æ ¼å¼æ¥æŒ‡å®šå…·ä½“æ˜¯è¿™ä¸ªè½¯ä»¶å“ªä¸ªç‰ˆæœ¬çš„é•œåƒã€‚å¦‚æœä¸ç»™å‡ºæ ‡ç­¾ï¼Œå°†ä»¥ latest ä½œä¸ºé»˜è®¤æ ‡ç­¾ã€‚</td>
</tr>
</tbody></table>
<h2 id="äºŒã€dockerçš„åŸºæœ¬ä½¿ç”¨"><a href="#äºŒã€dockerçš„åŸºæœ¬ä½¿ç”¨" class="headerlink" title="äºŒã€dockerçš„åŸºæœ¬ä½¿ç”¨"></a>äºŒã€dockerçš„åŸºæœ¬ä½¿ç”¨</h2><p>ä»¥ä¸€ä¸ªç²¾ç®€çš„UNIXå·¥å…·ç®±busyboxä¸ºä¾‹</p>
<p><code>docker pull busybox</code><br>ä»ä»“åº“æ‹‰å–latestçš„busyboxé•œåƒ</p>
<p><code>docker images</code><br>æŸ¥çœ‹æœ¬åœ°é•œåƒ</p>
<p><code>docker rmi  -f busybox</code><br>å¼ºåˆ¶åˆ é™¤busyboxé•œåƒ</p>
<p><code>docker run -it ubuntu /bin/bash</code><br>ä»é•œåƒç”Ÿæˆä¸€ä¸ªå®¹å™¨ï¼Œåˆ†é…ä¼ªç»ˆç«¯ï¼Œå¹¶é‡‡ç”¨äº¤äº’æ¨¡å¼è¿è¡Œï¼Œä¸”åœ¨è¿›å…¥å®¹å™¨åæ‰§è¡Œ&#x2F;bin&#x2F;bash</p>
<p><code>docker ps</code><br>æŸ¥çœ‹æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼ŒåŠ å‚æ•°-aè¿˜å¯ä»¥æŸ¥çœ‹åœè¿çš„å®¹å™¨</p>
<p><code>docker start busybox</code><br>å¯åŠ¨åœæ­¢è¿è¡Œçš„å®¹å™¨busybox</p>
<p><code>docker stop busybox</code><br>åœæ­¢æ­£åœ¨è¿è¡Œçš„å®¹å™¨busybox</p>
<p><code>docker restart busybox</code><br>é‡å¯å®¹å™¨busybox</p>
<p><code>docker kill busybox</code><br>æ€æ­»è¿è¡Œä¸­çš„å®¹å™¨busybox</p>
<p><code>docker rm -f busybox</code><br>ç§»é™¤å®¹å™¨busybox</p>
<p><code>docker pause busybox</code><br>æš‚åœå®¹å™¨ä¸­æ‰€æœ‰è¿›ç¨‹</p>
<p><code>docker unpause busybox</code><br>æš‚åœåç»§ç»­å®¹å™¨ä¸­æ‰€æœ‰è¿›ç¨‹</p>
<p><code>docker create busybox</code><br>åˆ›å»ºä¸€ä¸ªå®¹å™¨ä½†æ˜¯ä¸å¯åŠ¨</p>
<p><code>docker exec -it busybox /bin/bash</code><br>åœ¨æ­£åœ¨è¿è¡Œçš„å®¹å™¨ä¸­æ‰§è¡Œ&#x2F;bin&#x2F;bashè¿™ä¸ªå‘½ä»¤<br>è¿™ä¹Ÿæ˜¯è¿›å…¥è¿è¡Œä¸­å®¹å™¨çš„ä¸€ç§æ–¹æ³•</p>
<p>and so onâ€¦â€¦</p>
<h2 id="äºŒã€Dockerå®ç°åŸç†æ¢ç©¶"><a href="#äºŒã€Dockerå®ç°åŸç†æ¢ç©¶" class="headerlink" title="äºŒã€Dockerå®ç°åŸç†æ¢ç©¶"></a>äºŒã€Dockerå®ç°åŸç†æ¢ç©¶</h2><p>é‚£ä¹ˆï¼Œdockeræ˜¯å¦‚ä½•ç”Ÿæˆè¿™æ ·ç²¾ç®€è€Œå¥å…¨çš„ä¸€ä¸ªä¸ªå®¹å™¨çš„å‘¢ï¼Ÿä»Šå¤©ï¼Œæˆ‘ä»¬å°±æ¥ç ”ç©¶ä¸€æ³¢å…¶ä¸­è¿ç”¨åˆ°çš„ä¸‰ä¸ªä¸»è¦çš„åŠŸèƒ½ï¼š<strong>Linux namespace, cgroups, Union File System(UFS)</strong>ã€‚ä¸‹é¢æˆ‘ä»¬ä¸€ä¸€è¿›è¡Œæ¢è®¨ã€‚</p>
<h3 id="Linux-namespace"><a href="#Linux-namespace" class="headerlink" title="Linux namespace"></a>Linux namespace</h3><p>æœ¬æ¥ï¼Œä¸åŒçš„è¿›ç¨‹æ˜¯å…±äº«åŒä¸€ä»½å†…æ ¸èµ„æºçš„ã€‚è¦åšä¸€ä¸ªé€šä¿—çš„ç±»æ¯”çš„è¯ï¼Œå¦‚æœè¯´æ¯ä¸ªè¿›ç¨‹æ˜¯å•ç‹¬çš„ä¸€ä¸ªä½æˆ·ï¼Œé‚£ä¹ˆå†…æ ¸èµ„æºå°±å¥½æ¯”æ˜¯å°åŒºé‡Œçš„å…¬å…±åœºæ‰€ï¼Œå¤§å®¶éƒ½å¯ä»¥ä½¿ç”¨ï¼Œä¸”ä½¿ç”¨æƒ…å†µå¯¹å½¼æ­¤éƒ½å¯è§ã€‚è€Œnsçš„ä½œç”¨ï¼Œå°±æ˜¯æŠŠè¿™æ ·çš„å…¬å…±åœºæ‰€éš”ç¦»å¼€æ¥ã€‚ä½†è¿™é‡Œçš„<strong>éš”ç¦»</strong>ï¼Œè¯´çš„å¹¶ä¸æ˜¯å°†å…¬å…±åœºæ‰€åˆ†æˆå‡ éƒ¨åˆ†ï¼Œäº¤ç»™ä¸åŒçš„è¿›ç¨‹ï¼Œè€Œæ˜¯æ¯ä¸ªè¿›ç¨‹ä¾ç„¶æœ‰åŸæ¥ä¸€æ ·å¤§çš„å…¬å…±åœºæ‰€ï¼Œå…¬å…±åœºæ‰€ä¸­çš„èµ„æºå’Œå˜æ›´æƒ…å†µåªæœ‰ä»–è‡ªå·±èƒ½çœ‹åˆ°ã€‚å¦‚æœä»–åœ¨å…¬å…±åœºæ‰€ä¸¢äº†ä¸€æ ¹çƒŸå¤´ï¼Œåˆ™åªæœ‰ä»–è‡ªå·±çŸ¥é“ï¼Œå…¶ä»–äººï¼ˆè¿›ç¨‹ï¼‰æ˜¯æ„ŸçŸ¥ä¸åˆ°çš„ã€‚<br>Linux Namespaceå°±æ˜¯è¿™æ ·æä¾›äº†ä¸€ç§å†…æ ¸çº§åˆ«éš”ç¦»ç³»ç»Ÿèµ„æºçš„æ–¹æ³•ï¼Œé€šè¿‡å°†ç³»ç»Ÿçš„å…¨å±€èµ„æºæ”¾åœ¨ä¸åŒçš„Namespaceä¸­ï¼Œæ¥å®ç°èµ„æºéš”ç¦»çš„ç›®çš„ã€‚ä¸åŒNamespaceçš„ç¨‹åºï¼Œå¯ä»¥äº«æœ‰ä¸€ä»½ç‹¬ç«‹çš„ç³»ç»Ÿèµ„æºã€‚<br><img src="https://i.loli.net/2021/11/16/dHxQRgG9uBOZDTr.jpg" alt="OIP-C.jpeg"><br>namespaceçš„APIæœ‰å¦‚ä¸‹3ä¸ªsyscall:</p>
<ul>
<li>clone() åˆ›å»ºæ–°è¿›ç¨‹ï¼Œå¹¶æ ¹æ®ä¼ å…¥çš„ç³»ç»Ÿè°ƒç”¨å‚æ•°åˆ¤æ–­é‚£äº›ç±»å‹çš„namespaceè¢«åˆ›å»ºï¼Œå¹¶ä¸”å…¶å­è¿›ç¨‹ä¹Ÿä¼šåŒ…å«åˆ°è¿™äº›namespaceä¸­ã€‚</li>
<li>unshare() å°†è¿›ç¨‹ç§»å‡ºæŸä¸ªnamespaceã€‚</li>
<li>setns() å°†è¿›ç¨‹åŠ å…¥æŸä¸ªnamespaceã€‚</li>
</ul>
<p>ç›®å‰Linuxä¸­æä¾›äº†å…­ç±»ç³»ç»Ÿèµ„æºçš„éš”ç¦»æœºåˆ¶ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>Mount: éš”ç¦»æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹</li>
<li>UTS: éš”ç¦»ä¸»æœºåå’ŒåŸŸåä¿¡æ¯</li>
<li>IPC: éš”ç¦»è¿›ç¨‹é—´é€šä¿¡</li>
<li>PID: éš”ç¦»è¿›ç¨‹çš„ID</li>
<li>Network: éš”ç¦»ç½‘ç»œèµ„æº</li>
<li>User: éš”ç¦»ç”¨æˆ·å’Œç”¨æˆ·ç»„çš„ID</li>
<li>Cgroup: éš”ç¦»cgroupæ ¹ç›®å½•ï¼ˆæœ€æ–°ï¼Œå°šæœªè¢«dockeré‡‡ç”¨ï¼‰<br>ä¸‹é¢ä¸€ä¸€è§£é‡Šä»–ä»¬çš„ä½œç”¨ï¼š</li>
</ul>
<h4 id="Mount-namespace"><a href="#Mount-namespace" class="headerlink" title="Mount namespace"></a>Mount namespace</h4><p>Mount Namespaceç”¨æ¥<em>éš”ç¦»å„ä¸ªè¿›ç¨‹çœ‹åˆ°çš„æŒ‚è½½ç‚¹è§†å›¾</em>ã€‚ä¸åŒnamespaceçš„è¿›ç¨‹ï¼Œçœ‹åˆ°çš„æ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡æ˜¯ä¸åŒçš„ã€‚åœ¨mount namespaceä¸­è°ƒç”¨mount, umountç­‰å‘½ä»¤åªä¼šå½±å“å½“å‰namespaceå†…çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œå¯¹å…¨å±€çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯æ²¡æœ‰å½±å“çš„ã€‚ï¼ˆäº‹å®ä¸Šï¼Œdockerå®¹å™¨å†…çš„æŒ‚è½½æƒ…å†µç¡®å®å’Œå®¿ä¸»æœºä¸åŒã€‚ï¼‰<br>Mount Namespaceæ˜¯linuxç¬¬ä¸€ä¸ªå®ç°çš„namespaceç±»å‹ï¼Œå› è€Œå®ƒçš„syscallå‚æ•°æ¯”è¾ƒç‰¹æ®Šï¼Œæ˜¯NEWNSã€‚<br><img src="https://i.loli.net/2021/11/16/amiSFvLeyJ6k5A7.png" alt="ns-mount.png"><br>ä½†æ˜¯æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼šæœ‰äº›æ—¶å€™ï¼ŒMount Namespaceå…¶å®å¹¶ä¸èƒ½çœŸæ­£éš”ç¦»æŒ‚è½½ä¿¡æ¯ï¼è¿™æ˜¯å› ä¸ºlinuxä¸­è¿˜å­˜åœ¨ä¸€ç§åä¸º<strong>Shared Subtree</strong>çš„æœºåˆ¶ï¼<br>å¼•å…¥è¯¥æœºåˆ¶æ˜¯ä¸ºäº†æ¶ˆé™¤mount nså¸¦æ¥çš„ä¸ä¾¿ï¼Œæ¯”å¦‚ç³»ç»Ÿæ–°å¢ä¸€å—ç£ç›˜ï¼Œæˆ‘å¸Œæœ›æ‰€æœ‰çš„NSéƒ½æ„ŸçŸ¥åˆ°æ–°æŒ‚è½½çš„è¿™å—ç£ç›˜ï¼Œé‚£ä¹ˆå¦‚æœNS ä¹‹é—´æ˜¯å®Œå…¨éš”ç¦»çš„ï¼Œå°±éœ€è¦æ¯ä¸ªéƒ½æ‰§è¡Œä¸€æ¬¡æŒ‚è½½æ“ä½œï¼Œè¿™æ˜¯éå¸¸ä¸å˜çš„ï¼Œshared subtreeä¿è¯äº†ä¸åŒçš„NS ä¹‹é—´å¯ä»¥å…±äº«æŒ‚è½½ä¿¡æ¯ã€‚<br>å…±äº«å­æ ‘æœ‰ä¸¤å¤§æ ¸å¿ƒï¼š<strong>peer group</strong>å’Œ<strong>propagate type</strong>ã€‚</p>
<ul>
<li>peer group<br>è¡¨ç¤ºäº†ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‚è½½ç‚¹çš„é›†åˆï¼Œä¸‹é¢ä¸¤ç§æƒ…å†µå±äºç»Ÿä¸€groupï¼š</li>
</ul>
<p>é€šè¿‡â€“bindæ“ä½œæŒ‚è½½çš„æºæŒ‚è½½ç‚¹å’Œç›®æ ‡æŒ‚è½½ç‚¹ï¼ˆå‰ææ˜¯æºç›®å½•æ˜¯ä¸ªæŒ‚è½½ç‚¹ï¼‰<br>ç”Ÿæˆæ–°mount nsæ—¶ï¼Œå¤åˆ¶è¿‡å»çš„æŒ‚è½½ç‚¹ä¹‹é—´åŒåœ¨ä¸€ä¸ªgroup</p>
<ul>
<li>propagate type(ä¼ æ’­å±æ€§)<br>è¿™æ˜¯mountç‚¹çš„å±æ€§ï¼Œå…¶å¸¸è§å€¼æœ‰ï¼š</li>
</ul>
<ol>
<li>MS_SHARED  è¯¥æŒ‚è½½ç‚¹çš„åˆ é™¤æ“ä½œã€è¯¥æŒ‚è½½ç‚¹ä¸‹å­æŒ‚è½½ç‚¹çš„æ–°å¢å’Œåˆ é™¤æ“ä½œéƒ½ä¼šåŒæ­¥åˆ°åŒä¸€groupä¸­çš„å…¶ä»–mountç‚¹ï¼Œä¸”å…¶ä»–åŒgroupçš„mountç‚¹çš„æ“ä½œä¹Ÿä¼šåŒæ­¥åˆ°è¯¥mountç‚¹</li>
<li>MS_PRIVATE  ä¸1ç›¸åï¼Œä¸ä¼šå°†è‡ªå·±çš„ä¿¡æ¯å…±äº«å‡ºå»ï¼Œä¹Ÿä¸æ¥å—å…¶ä»–ç‚¹çš„å…±äº«ï¼Œä»è€Œå®ç°çœŸæ­£çš„éš”ç¦»</li>
<li>MS_SLAVE  å•å‘çš„å…±äº«ï¼Œè‡ªå·±çš„æ›´æ–°ä¸ä¼šå½±å“åˆ°ä»–äººï¼Œä½†æ˜¯ä»–äººçš„æ“ä½œä¼šåŒæ­¥åˆ°è‡ªå·±</li>
</ol>
<p>é€šè¿‡ä»¥ä¸‹å‘½ä»¤å½“å‰æŒ‚è½½ç‚¹çš„ä¼ æ’­å±æ€§ï¼š<br><code>cat /proc/self/mountinfo </code><br>å¯ä»¥å‘ç°æ‰€æœ‰è¿›ç¨‹é»˜è®¤æƒ…å†µä¸‹éƒ½æ˜¯sharedçš„ã€‚åˆå› ä¸ºé€šè¿‡ç³»ç»Ÿè°ƒç”¨cloneå‡ºçš„namespaceä¸çˆ¶è¿›ç¨‹å¤„åœ¨ä¸€ä¸ªpeer groupä¸‹ï¼Œæ‰€ä»¥ä¼šå®Œå…¨copyçˆ¶è¿›ç¨‹çš„æŒ‚è½½ç‚¹ä¿¡æ¯ï¼Œå› æ­¤å­è¿›ç¨‹çš„æŒ‚è½½ç‚¹ä¹Ÿæ˜¯sharedã€‚å¦‚æœä¸æ³¨æ„åˆ°è¿™ç‚¹çš„è¯ï¼Œåˆ›å»ºçš„å®¹å™¨å°±ä¸ä¼šçœŸæ­£éš”ç»æŒ‚è½½ä¿¡æ¯ï¼Œä¸”ä¼šå¼•èµ·ä¸€äº›ä¸å¦™çš„åæœã€‚æˆ‘ä»¬æ”¾åœ¨åé¢æ„å»ºç®€å•dockerå®¹å™¨çš„å®æˆ˜ä¸­å†è¯´è¿™ä¸ªbugã€‚</p>
<h4 id="UTS-namespace"><a href="#UTS-namespace" class="headerlink" title="UTS namespace"></a>UTS namespace</h4><p>UTS namespaceä¸»è¦ç”¨æ¥<em>nodenameå’Œdomainname</em>ä¸¤ä¸ªç³»ç»Ÿæ ‡è¯†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªUTS Namespaceè¢«å…è®¸æœ‰è‡ªå·±çš„ä¸»æœºåï¼ˆdockerç½‘ç»œé€šä¿¡çš„é‡è¦åŸºç¡€ä¹‹ä¸€ï¼‰ã€‚<br>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªç®€å•çš„Goè¯­è¨€demoæ¥éªŒè¯UTS namespaceçš„ä½œç”¨ï¼š</p>
<pre><code>func main() &#123;
    cmd := exec.Command(&quot;sh&quot;)//æŒ‡å®šæ–°è¿›ç¨‹çš„åˆå§‹å‘½ä»¤
    cmd.SysProcAttr = &amp;syscall.SysProcAttr &#123;
        CloneFlags: syscall.CLONE_NEWUTS,
    &#125;//è®¾å®šç³»ç»Ÿè°ƒç”¨å±æ€§
    cmd.Stdin = os.Stdin
    cmd.Stdout = os.Stdout
    cmd.Stderr = os.Stderr//è®¾ç½®æ ‡å‡†è¾“å…¥è¾“å‡º

    if err := cmd.Run(); err != nil &#123;
        log.Fatal(err)
    &#125;//è¿è¡Œå‘½ä»¤å’Œé”™è¯¯å¤„ç†
&#125;
</code></pre>
<p>æ‰§è¡Œä»£ç ï¼Œåœ¨å¯åŠ¨çš„äº¤äº’å¼ç¯å¢ƒé‡Œï¼Œå…ˆç”¨echo $$è¾“å‡ºä¸€ä¸‹å½“å‰è¿›ç¨‹çš„PIDï¼Œå†ç”¨pstree -plæŸ¥çœ‹è¿›ç¨‹æ ‘ï¼Œæ‰¾åˆ°çˆ¶è¿›ç¨‹ã€‚ç”±äºåœ¨è¿›ç¨‹ç›®å½•ä¸‹çš„nsç›®å½•åŒ…å«è¿›ç¨‹çš„namespaceä¿¡æ¯ï¼Œå…¶ä¸­utså°±å¯¹åº” UTS namespaceçš„ä¿¡æ¯ã€‚ä¸”ç”±äºnsç›®å½•ä¸‹çš„è¿™äº›æ–‡ä»¶å…¶å®éƒ½æ˜¯ç‰¹æ®Šçš„ç¬¦å·é“¾æ¥ï¼Œæ‰€ä»¥éœ€è¦ç”¨readlinkè¯»å–å…¶å®é™…æŒ‡å‘çš„å†…å®¹ï¼Œä¾¿å¯ä»¥çŸ¥é“å…¶UTS namespaceçš„inodeå·äº†ã€‚äºæ˜¯ç”¨readlink &#x2F;proc&#x2F;xxxxx&#x2F;ns&#x2F;utsæ¯”è¾ƒnsçš„inodeï¼Œå¯ä»¥éªŒè¯ä»–ä»¬ä¸åœ¨åŒä¸€ä¸ªUTS Namespaceä¸­ã€‚<br>æ¥ç€ï¼Œæ‰§è¡Œhostname -b chenpengï¼Œä¿®æ”¹å½“å‰ä¸»æœºåã€‚å¦å¤–å¯åŠ¨ä¸€ä¸ªshellï¼Œä½¿ç”¨hostnameå‘½ä»¤ï¼Œä¼šå‘ç°å¤–éƒ¨çš„hostnameå¹¶æœªå› å†…éƒ¨çš„ä¿®æ”¹è€Œæ”¹å˜ï¼Œè¯æ˜äº†UTS Namespaceçš„ä½œç”¨ã€‚<br>å…¶ä»–namespaceçš„ä½œç”¨å¯ä»¥ç±»ä¼¼åœ°éªŒè¯ï¼Œæ¥ä¸‹æ¥å°±ä¸»è¦ä»‹ç»ä»–ä»¬çš„ä½œç”¨å³å¯ã€‚</p>
<h4 id="IPC-Namespace"><a href="#IPC-Namespace" class="headerlink" title="IPC Namespace"></a>IPC Namespace</h4><p>ç”¨æ¥éš”ç¦»System V IPCå’ŒPOSIX message queuesã€‚</p>
<h4 id="PID-Namespace"><a href="#PID-Namespace" class="headerlink" title="PID Namespace"></a>PID Namespace</h4><p>ç”¨æ¥éš”ç¦»è¿›ç¨‹IDã€‚åŒæ ·ä¸€ä¸ªè¿›ç¨‹åœ¨ä¸åŒçš„PID Namespaceä¸­å¯ä»¥æ‹¥æœ‰ä¸åŒçš„PIDã€‚å¯ä»¥é€šè¿‡åˆ†åˆ«åœ¨å®¿ä¸»æœºå’Œå®¹å™¨å†…æ‰§è¡Œps -eféªŒè¯dockerå¯¹è¿™ä¸ªnamespaceçš„è¿ç”¨ã€‚</p>
<h4 id="User-Namespace"><a href="#User-Namespace" class="headerlink" title="User Namespace"></a>User Namespace</h4><p>ç”¨æ¥éš”ç¦»ç”¨æˆ·çš„ç”¨æˆ·ç»„IDã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªè¿›ç¨‹çš„User IDå’ŒGroup IDåœ¨User Namespaceå†…å¤–å¯ä»¥æ˜¯ä¸åŒçš„ã€‚æ¯”å¦‚åœ¨å®¿ä¸»æœºä¸Šçš„ä»¥érootç”¨æˆ·è¿è¡Œåˆ›å»ºä¸€ä¸ªUser Namespaceï¼Œè€Œåœ¨namespaceé‡Œé¢è¿™ä¸ªç”¨æˆ·è¢«æ˜ å°„ä¸ºrootç”¨æˆ·ã€‚è¿™æ„å‘³ç€ï¼Œè¿™ä¸ªè¿›ç¨‹åœ¨User Namespaceé‡Œæ‹¥æœ‰rootæƒé™ï¼Œä½†åœ¨å¤–é¢å´æ²¡æœ‰ã€‚ä»Linux Kernel 3.8å¼€å§‹ï¼Œérootè¿›ç¨‹ä¹Ÿå¯ä»¥åˆ›å»ºUser Namespaceå¹¶è¢«æ˜ å°„æˆrootã€‚</p>
<h4 id="Netwoek-Namespace"><a href="#Netwoek-Namespace" class="headerlink" title="Netwoek Namespace"></a>Netwoek Namespace</h4><p>ç”¨æ¥éš”ç¦»ç½‘ç»œè®¾å¤‡ã€IPåœ°å€ç«¯å£ç­‰ç½‘ç»œæ ˆã€‚å¯ä»¥è®©æ¯ä¸ªå®¹å™¨æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„è™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œä¸”å®¹å™¨å†…çš„åº”ç”¨å¯ä»¥ç»‘å®šåˆ°è‡ªå·±çš„ç«¯å£ï¼Œä½¿å¾—å„ä¸ªNamespaceå†…çš„ç«¯å£ä¸ä¼šäº’ç›¸å†²çªã€‚ä¸”åœ¨å®¿ä¸»æœºä¸Šæ­å»ºç½‘æ¡¥åï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®ç°å®¹å™¨é—´é€šä¿¡ã€‚æ­¤å¤–ï¼Œé€šè¿‡ç«¯å£æ˜ å°„ï¼Œå¯ä»¥ä½¿å¾—ä¸åŒå®¹å™¨ä¸Šçš„åº”ç”¨ä½¿ç”¨ç›¸åŒçš„ç«¯å£å·ã€‚</p>
<h3 id="Linux-Cgroups"><a href="#Linux-Cgroups" class="headerlink" title="Linux Cgroups"></a>Linux Cgroups</h3><p>namespaceæŠ€æœ¯å¯ä»¥å¸®åŠ©æ„å»ºå‡ºçš„å®¹å™¨æ‹¥æœ‰è‡ªå·±ä¸å¤–éƒ¨éš”ç¦»çš„å•ç‹¬çš„ç©ºé—´ï¼Œä½†Dockeræ˜¯å¦‚ä½•é™åˆ¶æ¯ä¸ªå®¹å™¨æ‰€å ç©ºé—´çš„å¤§å°ï¼Œä»è€Œä¿è¯å®ƒä»¬ä¸ä¼šç›¸äº’äº‰æŠ¢çš„å‘¢ï¼Ÿè¿™å°±è¦è¿ç”¨CgroupsæŠ€æœ¯ã€‚<br>Linux Cgroupsï¼ˆControl Groupsï¼‰æä¾›äº†å¯¹ä¸€ç»„è¿›ç¨‹åŠå…¶å°†æ¥å­è¿›ç¨‹çš„èµ„æºé™åˆ¶ã€æ§åˆ¶å’Œç»Ÿè®¡çš„èƒ½åŠ›ï¼Œè¿™äº›èµ„æºåŒ…æ‹¬CPU,å†…å­˜ï¼Œå­˜å‚¨ï¼Œç½‘ç»œç­‰ã€‚é€šè¿‡Cgroupsï¼Œå¯ä»¥æ–¹ä¾¿åœ°é™åˆ¶æŸä¸ªè¿›ç¨‹çš„èµ„æºå ç”¨ï¼Œå¹¶ä¸”å®æ—¶åœ°ç›‘æ§è¿›ç¨‹å’Œç»Ÿè®¡ä¿¡æ¯ã€‚<br>æ¯”å¦‚å¯ä»¥é€šè¿‡cgroupé™åˆ¶ç‰¹å®šè¿›ç¨‹ä½¿ç”¨ç‰¹å®šæ•°ç›®çš„cpuæ ¸æ•°å’Œç‰¹å®šå¤§å°çš„å†…å­˜ï¼Œå¦‚æœèµ„æºè¶…é™çš„æƒ…å†µä¸‹ï¼Œä¼šè¢«æš‚åœæˆ–è€…æ€æ‰ã€‚</p>
<ul>
<li>ä»»åŠ¡(task): åœ¨cgroupsä¸­ï¼Œtaskå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹ã€‚</li>
<li>æ§åˆ¶ç»„(control group): cgroupsçš„èµ„æºæ§åˆ¶æ˜¯ä»¥cgroupçš„æ–¹å¼å®ç°ï¼ŒcgroupæŒ‡æ˜äº†èµ„æºçš„é…é¢é™åˆ¶ã€‚è¿›ç¨‹å¯ä»¥åŠ å…¥åˆ°æŸä¸ªcgroupï¼Œä¹Ÿå¯ä»¥è¿ç§»åˆ°å¦ä¸€ä¸ªcgroupã€‚</li>
<li>å±‚çº§(hierarchy): cgroupæœ‰å±‚çº§å…³ç³»ï¼Œç±»ä¼¼æ ‘çš„ç»“æ„ï¼Œå­èŠ‚ç‚¹çš„cgroupç»§æ‰¿çˆ¶cgroupçš„å±æ€§(èµ„æºé…é¢ã€é™åˆ¶ç­‰)ã€‚</li>
<li>å­ç³»ç»Ÿ(subsystem): ä¸€ä¸ªsubsystemå…¶å®å°±æ˜¯ä¸€ç§èµ„æºçš„æ§åˆ¶å™¨ï¼Œæ¯”å¦‚memory subsystemå¯ä»¥æ§åˆ¶è¿›ç¨‹å†…å­˜çš„ä½¿ç”¨ã€‚subsysteméœ€è¦åŠ å…¥åˆ°æŸä¸ªhierarchyï¼Œç„¶åè¯¥hierarchyçš„æ‰€æœ‰cgroupï¼Œå‡å—åˆ°è¿™ä¸ªsubsystemçš„æ§åˆ¶ã€‚<br>subsystemçš„ç±»åˆ«ï¼š<ul>
<li>cpu: é™åˆ¶è¿›ç¨‹çš„ cpu ä½¿ç”¨ç‡ã€‚</li>
<li>cpuacct å­ç³»ç»Ÿï¼Œå¯ä»¥ç»Ÿè®¡ cgroups ä¸­çš„è¿›ç¨‹çš„ cpu ä½¿ç”¨æŠ¥å‘Šã€‚</li>
<li>cpuset: ä¸ºcgroupsä¸­çš„è¿›ç¨‹åˆ†é…å•ç‹¬çš„cpuèŠ‚ç‚¹æˆ–è€…å†…å­˜èŠ‚ç‚¹ã€‚</li>
<li>memory: é™åˆ¶è¿›ç¨‹çš„memoryä½¿ç”¨é‡ã€‚</li>
<li>blkio: é™åˆ¶è¿›ç¨‹çš„å—è®¾å¤‡ioã€‚</li>
<li>devices: æ§åˆ¶è¿›ç¨‹èƒ½å¤Ÿè®¿é—®æŸäº›è®¾å¤‡ã€‚</li>
<li>net_cls: æ ‡è®°cgroupsä¸­è¿›ç¨‹çš„ç½‘ç»œæ•°æ®åŒ…ï¼Œç„¶åå¯ä»¥ä½¿ç”¨tcæ¨¡å—ï¼ˆtraffic controlï¼‰å¯¹æ•°æ®åŒ…è¿›è¡Œæ§åˆ¶ã€‚</li>
<li>net_prio: é™åˆ¶è¿›ç¨‹ç½‘ç»œæµé‡çš„ä¼˜å…ˆçº§ã€‚</li>
<li>huge_tlb: é™åˆ¶HugeTLBçš„ä½¿ç”¨ã€‚</li>
<li>freezer:æŒ‚èµ·æˆ–è€…æ¢å¤cgroupsä¸­çš„è¿›ç¨‹ã€‚</li>
<li>ns: æ§åˆ¶cgroupsä¸­çš„è¿›ç¨‹ä½¿ç”¨ä¸åŒçš„namespaceã€‚</li>
</ul>
</li>
</ul>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œcgroupæ˜¯ç®¡ç†ä¸€ç»„taskçš„åŸºæœ¬å•å…ƒï¼Œå…¶ä½œä¸ºç»“ç‚¹ç»„æˆçš„æ ‘ç»“æ„å«åšhiierarchyã€‚subsystemé™„åŠ åœ¨hierarchyä¸Šï¼Œå¯¹å…¶ä¸­çš„cgroupè¿›è¡Œèµ„æºé™åˆ¶ï¼ŒåŒæ—¶å­ç»“ç‚¹ç»§æ‰¿çˆ¶ç»“ç‚¹çš„é…ç½®ã€‚<br><img src="https://i.loli.net/2021/11/16/nXhgHSrBY5IZ9oq.png" alt="cgroup.png"><br>ä¸‰ä¸ªç»„ä»¶çš„å…³ç³»ï¼šç³»ç»Ÿåˆ›å»ºæ–°çš„hierarchyåï¼Œç³»ç»Ÿä¸­çš„æ‰€æœ‰è¿›ç¨‹éƒ½ä¼šåŠ å…¥è¿™ä¸ªhierarchyçš„cgroupæ ¹èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ ¹èŠ‚ç‚¹æ˜¯ç”±hierarchyé»˜è®¤åˆ›å»ºçš„ã€‚ä¸€ä¸ªsubsystemåªèƒ½é™„åŠ åˆ°ä¸€ä¸ªhierarchyä¸Šé¢ï¼Œä¸€ä¸ªhierarchyå¯ä»¥é™„åŠ å¤šä¸ªsubsystemï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥ä½œä¸ºå¤šä¸ªcgroupçš„æˆå‘˜ï¼Œä½†è¿™äº›cgroupå¿…é¡»åœ¨ä¸åŒçš„hierarchyä¸­ï¼›ä¸€ä¸ªè¿›ç¨‹forkå‡ºå­è¿›ç¨‹æ—¶ï¼Œçˆ¶å­åŒå±äºä¸€ä¸ªcgroupï¼Œä½†ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦ç§»åˆ°ä¸åŒçš„cgroupä¸­ã€‚<br>å¦‚ä½•è°ƒç”¨å†…æ ¸æ‰èƒ½é…ç½®Cgroupså‘¢ï¼Ÿå‰é¢æåˆ°ï¼Œhierarchyæ˜¯ä¸€ç§æ ‘çŠ¶çš„ç»„ç»‡ç»“æ„ï¼Œkernelä¸ºäº†ä½¿å¯¹Cgroupsçš„é…ç½®æ›´åŠ ç›´è§‚ï¼Œæ˜¯é€šè¿‡ä¸€ä¸ªè™šæ‹Ÿçš„æ ‘çŠ¶æ–‡ä»¶ç³»ç»Ÿæ¥é…ç½®Cgroupçš„ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡å±‚çº§çš„ç›®å½•æ¥è™šæ‹Ÿå‡ºä¸€æ£µhierarchy(cgroup tree)ã€‚ç¤ºä¾‹ï¼š</p>
<pre><code>mkdir cgroup-test
sudo mount -t cgroup -o none, name=cgroup-test cgroup-test ./cgroup-test
ls ./cgroup-test
</code></pre>
<p>ä»¥ä¸Šåœ¨å½“å‰ç›®å½•åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œå¹¶æŒ‚è½½äº†ä¸€ä¸ªcgroupç±»å‹çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™æ ·å°±åˆ›å»ºäº†ä¸€æ£µhierarchyã€‚lsæŸ¥çœ‹ä¸€ä¸‹ç›®å½•ï¼Œä¼šå‘ç°ç”Ÿæˆäº†ä¸€äº›é»˜è®¤çš„æ–‡ä»¶ï¼š</p>
<ul>
<li><p>cgroup.clone_children cpusetçš„subsystemä¼šè¯»å–è¿™ä¸ªé…ç½®æ–‡ä»¶,å¦‚æœè¿™ä¸ªå€¼(é»˜è®¤å€¼æ˜¯0)æ˜¯ 1 å­cgroupæ‰ä¼šç»§æ‰¿çˆ¶cgroupçš„cpusetçš„é…ç½®</p>
</li>
<li><p>cgroup.procsæ˜¯æ ‘ä¸­å½“å‰èŠ‚ç‚¹cgroupä¸­çš„è¿›ç¨‹ç»„ID,ç°åœ¨çš„ä½ç½®æ˜¯æ ¹èŠ‚ç‚¹,è¿™ä¸ªæ–‡ä»¶ä¸­ä¼šæœ‰ç°åœ¨ç³»ç»Ÿä¸­æ‰€æœ‰è¿›ç¨‹ç»„çš„ID</p>
</li>
<li><p>notify_on_releaseå’Œrelease_agent ä¼šä¸€èµ·ä½¿ç”¨ã€‚notify_on_release æ ‡å¿—å½“è¿™ä¸ªcgroupæœ€åä¸€ä¸ªè¿›ç¨‹é€€å‡ºçš„æ—¶å€™æ˜¯å¦æ‰§è¡Œäº†release_agent</p>
</li>
<li><p>release_agent åˆ™æ˜¯ä¸€ä¸ªè·¯å¾„,é€šå¸¸ç”¨ä½œè¿›ç¨‹é€€å‡ºåè‡ªåŠ¨æ¸…ç†ä¸å†ä½¿ç”¨çš„cgroup</p>
</li>
<li><p>task æ ‡è¯†è¯¥cgroupä¸‹é¢è¿›ç¨‹ID,å¦‚æœæŠŠä¸€ä¸ªè¿›ç¨‹IDå†™åˆ°taskæ–‡ä»¶ä¸­,ä¾¿ä¼šæŠŠç›¸åº”çš„è¿›ç¨‹åŠ å…¥åˆ°è¿™ä¸ªcgroupä¸­ã€‚<br>åœ¨è¯¥ç›®å½•ä¸‹ç»§ç»­åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œå°±æ˜¯æ‰©å±•å­cgroupï¼Œå…¶ä¹Ÿä¼šè‡ªåŠ¨åˆ›å»ºä¸€äº›æ–‡ä»¶é…ç½®é¡¹ã€‚<br>ä½†æ˜¯ç”±äºæˆ‘ä»¬åˆ›å»ºçš„è¿™ä¸ªhierarchyæ²¡æœ‰é™„åŠ ä»»ä½•subsystemï¼ˆ-o åçš„å€¼ä¸ºnoneï¼‰ï¼Œæ‰€ä»¥æ²¡åŠæ³•å¯¹å…¶ä¸­çš„cgroupé™åˆ¶è¿›ç¨‹èµ„æºå ç”¨ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå„ç§subsystemåœ¨&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;ä¸‹æœ‰ç³»ç»Ÿå·²ç»åˆ›å»ºå¥½çš„é»˜è®¤çš„hierarchyï¼Œå› è€Œå¾ˆæ–¹ä¾¿æˆ‘ä»¬ä½¿ç”¨ã€‚(æˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨-o memory)<br>åœ¨&#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memoryä¸‹ï¼š</p>
<p>  sudo mkdir test &amp;&amp; cd test<br>  sudo sh -c â€œecho â€œ100mâ€ &gt; memory.limit_in_bytesâ€<br>  sudo sh -c â€œecho $$ &gt; tasksâ€<br>  stress â€“vm-bytes 200m â€“vm-keep -m 1</p>
</li>
</ul>
<p>ä»¥ä¸Šï¼Œæˆ‘ä»¬åœ¨æŒ‚è½½äº†memoryå­ç³»ç»Ÿçš„hierarchyä¸‹åˆ›å»ºäº†ä¸€ä¸ªcgroupï¼Œå¹¶é€šè¿‡ä¿®æ”¹é…ç½®é¡¹å¯¹å…¶å†…å­˜èµ„æºé™åˆ¶ï¼ˆ200mä»¥ä¸‹ï¼‰ï¼Œç„¶åä½¿ç”¨stressè¿›è¡Œå‹åŠ›æµ‹è¯•ã€‚<br>ä½¿ç”¨topç­‰å‘½ä»¤å¯ä»¥å‘ç°ï¼Œå…¶å†…å­˜ç¡®å®è¢«é™åˆ¶ï¼ŒéªŒè¯äº†cgroupsçš„é™åˆ¶èµ„æºçš„èƒ½åŠ›ã€‚<br>åœ¨Dockerä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¯åŠ¨ä¸€ä¸ªå®¹å™¨çš„æ—¶å€™ä¼ å…¥å‚æ•°-m 100mè¾¾åˆ°è¿™ç§æ•ˆæœï¼Œå³å°†å®¹å™¨çš„å†…å­˜å ç”¨é™åˆ¶åœ¨100mï¼Œè¿™èƒŒåå°±æ˜¯ç”±cgroupsæŠ€æœ¯å®ç°çš„ã€‚Dokceré€šè¿‡ä¸ºæ¯ä¸ªå®¹å™¨åˆ›å»ºcgroup,é…ç½®èµ„æºé™åˆ¶å’Œç›‘æ§ã€‚</p>
<h3 id="Union-File-System"><a href="#Union-File-System" class="headerlink" title="Union File System"></a>Union File System</h3><p>Union FSï¼Œæ˜¯ä¸€ç§ä¸ºlinux,fressBSD,netBSDæ“ä½œç³»ç»Ÿè®¾è®¡çš„ï¼ŒæŠŠå…¶ä»–æ–‡ä»¶ç³»ç»Ÿè”åˆåˆ°ä¸€ä¸ªè”åˆæŒ‚è½½ç‚¹çš„æ–‡ä»¶ç³»ç»ŸæœåŠ¡ã€‚å®ƒä½¿ç”¨branchæŠŠä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶å’Œç›®å½•é€æ˜åœ°è¦†ç›–ï¼Œå½¢æˆä¸€ä¸ªå•ä¸€çš„æ–‡ä»¶ç³»ç»Ÿã€‚è¿™äº›branchæˆ–è€…æ˜¯roçš„ï¼Œæˆ–è€…æ˜¯rwçš„ï¼Œæ‰€ä»¥å½“å¯¹è¿™ä¸ªè™šæ‹Ÿåçš„è”åˆæ–‡ä»¶ç³»ç»Ÿè¿›è¡Œå†™æ“ä½œæ—¶ï¼Œç³»ç»Ÿæ˜¯çœŸæ­£å†™åˆ°äº†ä¸€ä¸ªæ–°æ–‡ä»¶ä¸­ã€‚çœ‹èµ·æ¥è¿™ä¸ªè™šæ‹Ÿåçš„è”åˆæ–‡ä»¶ç³»ç»Ÿå¯ä»¥å¯¹ä»»ä½•æ–‡ä»¶è¿›è¡Œæ“ä½œï¼Œä½†å…¶å®å¹¶æ²¡æœ‰æ”¹å˜åŸæ¥çš„æ–‡ä»¶ï¼Œè¿™æ˜¯å› ä¸ºunionfsä½¿ç”¨äº†ä¸€ä¸ªé‡è¦çš„èµ„æºç®¡ç†æŠ€æœ¯â€”â€”<strong>å†™æ—¶å¤åˆ¶</strong>(copy-on-write)ã€‚<br>coWï¼Œä¹Ÿå«åšéšå¼å…±äº«ï¼Œæ˜¯ä¸€ç§å¯¹å¯ä¿®æ”¹èµ„æºå®ç°é«˜æ•ˆå¤åˆ¶çš„èµ„æºç®¡ç†æŠ€æœ¯ã€‚å®ƒçš„æ€æƒ³æ˜¯ï¼Œå¦‚æœä¸€ä¸ªèµ„æºæ˜¯é‡å¤çš„ï¼Œä½†æ²¡æœ‰ä»»ä½•ä¿®æ”¹ï¼Œè¿™æ—¶ä¸éœ€è¦ç«‹å³åˆ›å»ºä¸€ä¸ªæ–°çš„èµ„æºï¼Œè¿™ä¸ªèµ„æºå¯ä»¥è¢«æ–°æ—§å®ä¾‹å…±äº«ã€‚åˆ›å»ºæ–°èµ„æºåªä¼šå‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡å†™æ“ä½œï¼Œä¹Ÿå°±æ˜¯å¯¹èµ„æºè¿›è¡Œä¿®æ”¹çš„æ—¶å€™ã€‚é€šè¿‡è¿™ç§èµ„æºå…±äº«çš„æ–¹å¼ï¼Œå¯ä»¥æ˜¾è‘—å‡å°‘æœªä¿®æ”¹èµ„æºçš„å¤åˆ¶æ‰€å¸¦æ¥çš„æ¶ˆè€—ã€‚</p>
<h4 id="AUFS"><a href="#AUFS" class="headerlink" title="AUFS"></a>AUFS</h4><p>AUFSï¼Œå…¨ç§°æ˜¯Advanced Multi-Layerd Unification Filesystemï¼Œå®Œå…¨é‡å†™äº†æ—©æœŸçš„UnionFS 1.xï¼Œå¹¶å¼•å…¥äº†ä¸€äº›æ–°çš„åŠŸèƒ½ï¼Œæ¯”å¦‚å¯å†™åˆ†æ”¯çš„è´Ÿè½½å‡è¡¡ã€‚<br>AUFSæ˜¯dockeré€‰ç”¨çš„ç¬¬ä¸€ç§å­˜å‚¨é©±åŠ¨ï¼Œå…·æœ‰å¿«é€Ÿå¯åŠ¨å®¹å™¨ã€é«˜æ•ˆåˆ©ç”¨å­˜å‚¨å’Œå†…å­˜ç­‰ä¼˜ç‚¹ï¼Œç›´åˆ°ç°åœ¨ä¾ç„¶è¢«dockeræ”¯æŒã€‚æ¥ä¸‹æ¥ï¼Œä»‹ç»dockeræ˜¯å¦‚ä½•åˆ©ç”¨AUFSå­˜å‚¨é•œåƒå’Œå®¹å™¨çš„ã€‚<br>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨dockerä¸­ï¼Œæ¯ä¸€ä¸ªimageéƒ½æ˜¯ç”±ä¸€ç³»åˆ—read-only layerç»„æˆçš„ã€‚image layerçš„å†…å®¹éƒ½å­˜å‚¨åœ¨&#x2F;var&#x2F;lib&#x2F;docker&#x2F;aufs&#x2F;diffç›®å½•ä¸‹ã€‚è€Œ&#x2F;var&#x2F;lib&#x2F;docker&#x2F;aufs&#x2F;layersç›®å½•åˆ™å­˜å‚¨image layerå¦‚ä½•å †æ ˆè¿™äº›layerçš„metadataã€‚</p>
<p><img src="https://i.loli.net/2021/11/16/xpBINYUX5t6Mzlc.jpg" alt="container-layers.jpg"></p>
<h4 id="Overlay2"><a href="#Overlay2" class="headerlink" title="Overlay2"></a>Overlay2</h4><p>Overlay2æ˜¯ç°ç‰ˆæœ¬Dockeré»˜è®¤ä½¿ç”¨çš„å­˜å‚¨é©±åŠ¨ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œoverlay2 ä¼šæ¯”AUFSæ€§èƒ½æ›´å¥½ï¼Œè€Œä¸”æ›´åŠ ç¨³å®šï¼Œä½†æ˜¯äºŒè€…åŸºæœ¬çš„å­˜å‚¨æ€è·¯éƒ½æ˜¯åˆ†å±‚ã€‚overlay2 å’Œ AUFS ç±»ä¼¼ï¼Œå®ƒå°†æ‰€æœ‰ç›®å½•ç§°ä¹‹ä¸ºå±‚ï¼ˆlayerï¼‰ï¼Œoverlay2 çš„ç›®å½•æ˜¯é•œåƒå’Œå®¹å™¨åˆ†å±‚çš„åŸºç¡€ï¼Œè€ŒæŠŠè¿™äº›å±‚ç»Ÿä¸€å±•ç°åˆ°åŒä¸€çš„ç›®å½•ä¸‹çš„è¿‡ç¨‹ç§°ä¸ºè”åˆæŒ‚è½½ï¼ˆunion mountï¼‰ã€‚overlay2 æŠŠç›®å½•çš„ä¸‹ä¸€å±‚å«ä½œlowerdirï¼Œä¸Šä¸€å±‚å«ä½œupperdirï¼Œè”åˆæŒ‚è½½åçš„ç»“æœå«ä½œmergedã€‚<br>æ€»ä½“æ¥è¯´ï¼Œoverlay2 æ˜¯è¿™æ ·å‚¨å­˜æ–‡ä»¶çš„ï¼šoverlay2å°†é•œåƒå±‚å’Œå®¹å™¨å±‚éƒ½æ”¾åœ¨å•ç‹¬çš„ç›®å½•ï¼Œå¹¶ä¸”æœ‰å”¯ä¸€ IDï¼Œæ¯ä¸€å±‚ä»…å­˜å‚¨å‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶ï¼Œæœ€ç»ˆä½¿ç”¨è”åˆæŒ‚è½½æŠ€æœ¯å°†å®¹å™¨å±‚å’Œé•œåƒå±‚çš„æ‰€æœ‰æ–‡ä»¶ç»Ÿä¸€æŒ‚è½½åˆ°å®¹å™¨ä¸­ï¼Œä½¿å¾—å®¹å™¨ä¸­çœ‹åˆ°å®Œæ•´çš„ç³»ç»Ÿæ–‡ä»¶ã€‚</p>
<p>æ¥ä¸‹æ¥ä»¥overlay2ä¸ºä¾‹ï¼Œæ¢ç©¶dockeræ˜¯å¦‚ä½•å­˜æ”¾é•œåƒçš„ã€‚<br>é¦–å…ˆä»ä»“åº“æ‹‰å–ä¸€ä¸ªubuntu16.04é•œåƒï¼Œç„¶åæŸ¥çœ‹è¯¥é•œåƒçš„ä¿¡æ¯ï¼š</p>
<p><code>docker pull ubuntu:16.04</code><br>è§‚å¯Ÿåˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š</p>
<pre><code>16.04: Pulling from library/ubuntu
58690f9b18fc: Pull complete 
b51569e7c507: Pull complete 
da8ef40b9eca: Pull complete 
fb15d46c38dc: Pull complete 
Digest: sha256:0f71fa8d4d2d4292c3c617fda2b36f6dabe5c8b6e34c3dc5b0d17d4e704bd39c
Status: Downloaded newer image for ubuntu:16.04
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œé•œåƒæ­£æ˜¯è¢«åˆ†ä¸º4å±‚æ‹‰å–ä¸‹æ¥çš„ã€‚åœ¨&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2å¯ä»¥æ‰¾åˆ°æ‰€æœ‰æ‹‰å–ä¸‹æ¥çš„layerã€‚æ­¤å¤–ï¼Œè¯¥ç›®å½•ä¸‹è¿˜æœ‰ä¸€ä¸ªlç›®å½•ï¼Œè¿™é‡Œå…¨æ˜¯åˆ°å„å±‚diffä¹‹é—´çš„è½¯é“¾æ¥ï¼ŒæŠŠä¸€äº›è¾ƒçŸ­çš„éšæœºä¸²è½¯è¿åˆ°é•œåƒå±‚çš„ diff æ–‡ä»¶å¤¹ä¸‹ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†é¿å…è¾¾åˆ°mountå‘½ä»¤å‚æ•°çš„é•¿åº¦é™åˆ¶ã€‚<br>å…ˆéšæ„æŸ¥çœ‹ä¸€ä¸ªé•œåƒå±‚çš„å†…å®¹ï¼šdiff,link,lower,workã€‚<br>åœ¨è¿™é‡Œï¼Œlink æ–‡ä»¶å†…å®¹ä¸ºè¯¥é•œåƒå±‚å¯¹åº”lç›®å½•ä¸­çš„çŸ­ IDï¼Œdiff æ–‡ä»¶å¤¹ä¸ºè¯¥é•œåƒå±‚çš„æ”¹åŠ¨å†…å®¹ï¼Œä¹Ÿæ˜¯è¢«è”åˆæŒ‚è½½çš„å†…å®¹ï¼Œlower æ–‡ä»¶ä¸ºè¯¥å±‚çš„æ‰€æœ‰çˆ¶å±‚é•œåƒçš„çŸ­ IDï¼Œè§„å®šäº†é•œåƒé—´çš„å±‚åºå…³ç³»ã€‚<br>æˆ‘ä»¬å¯ä»¥ç”¨docker inspectæ¥æ‰¾åˆ°æŸä¸ªé•œåƒçš„å±‚çº§ä¹‹é—´çš„å…³ç³»ï¼š</p>
<pre><code>docker image inspect ubuntu
...
&quot;GraphDriver&quot;: &#123;
            &quot;Data&quot;: &#123;
                &quot;LowerDir&quot;: &quot;/var/lib/docker/overlay2/ca36b188418e7d85232c6d90144380e543ec45fb4cc962bf2f45d4a823c0f9cd/diff:/var/lib/docker/overlay2/4f934d2bbd300caf92c0f00c85201053c20881c91810f32c5bef850581990acd/diff:/var/lib/docker/overlay2/579a385ff86c563d0c4c71bcc5471133b674d102de7ab38555e66ec955f5dcdb/diff&quot;,
                &quot;MergedDir&quot;: &quot;/var/lib/docker/overlay2/aac78f83be662b8ec26fadd30aff555f35f66453b834a1d71edd7aea83607b40/merged&quot;,
                &quot;UpperDir&quot;: &quot;/var/lib/docker/overlay2/aac78f83be662b8ec26fadd30aff555f35f66453b834a1d71edd7aea83607b40/diff&quot;,
                &quot;WorkDir&quot;: &quot;/var/lib/docker/overlay2/aac78f83be662b8ec26fadd30aff555f35f66453b834a1d71edd7aea83607b40/work&quot;
            &#125;,
            &quot;Name&quot;: &quot;overlay2&quot;
        &#125;,
...
</code></pre>
<p>å…¶ä¸­ MergedDir ä»£è¡¨å½“å‰é•œåƒå±‚åœ¨ overlay2 å­˜å‚¨ä¸‹çš„ç›®å½•ï¼ŒLowerDir ä»£è¡¨å½“å‰é•œåƒçš„çˆ¶å±‚å…³ç³»ï¼Œä½¿ç”¨å†’å·åˆ†éš”ï¼Œå†’å·æœ€åä»£è¡¨è¯¥é•œåƒçš„æœ€åº•å±‚ã€‚<br>æ¥ç€å¯åŠ¨å®¹å™¨ï¼Œå†ç”¨docker inspectæŸ¥çœ‹å®¹å™¨çš„å±‚çº§å…³ç³»ï¼š</p>
<pre><code>docker inspect ubuntu
...
&quot;GraphDriver&quot;: &#123;
        &quot;Data&quot;: &#123;
            &quot;LowerDir&quot;: &quot;/var/lib/docker/overlay2/f5de3e3e085c8c0a6591705d368523927ba6e3fd5434ba802a3315d6747ce00d-init/diff:/var/lib/docker/overlay2/aac78f83be662b8ec26fadd30aff555f35f66453b834a1d71edd7aea83607b40/diff:/var/lib/docker/overlay2/ca36b188418e7d85232c6d90144380e543ec45fb4cc962bf2f45d4a823c0f9cd/diff:/var/lib/docker/overlay2/4f934d2bbd300caf92c0f00c85201053c20881c91810f32c5bef850581990acd/diff:/var/lib/docker/overlay2/579a385ff86c563d0c4c71bcc5471133b674d102de7ab38555e66ec955f5dcdb/diff&quot;,
            &quot;MergedDir&quot;: &quot;/var/lib/docker/overlay2/f5de3e3e085c8c0a6591705d368523927ba6e3fd5434ba802a3315d6747ce00d/merged&quot;,
            &quot;UpperDir&quot;: &quot;/var/lib/docker/overlay2/f5de3e3e085c8c0a6591705d368523927ba6e3fd5434ba802a3315d6747ce00d/diff&quot;,
            &quot;WorkDir&quot;: &quot;/var/lib/docker/overlay2/f5de3e3e085c8c0a6591705d368523927ba6e3fd5434ba802a3315d6747ce00d/work&quot;
        &#125;,
        &quot;Name&quot;: &quot;overlay2&quot;
    &#125;,
...
</code></pre>
<p>è¿™é‡ŒMergedDir çš„å†…å®¹å³ä¸ºå®¹å™¨å±‚çš„å·¥ä½œç›®å½•ï¼ŒLowerDir ä¸ºå®¹å™¨æ‰€ä¾èµ–çš„é•œåƒå±‚ç›®å½•ã€‚å®é™…ä¸Šï¼Œoverlay2å°†lowerdirã€upperdirã€workdirè”åˆæŒ‚è½½ï¼Œå½¢æˆæœ€ç»ˆçš„mergedæŒ‚è½½ç‚¹ï¼Œå…¶ä¸­lowerdiræ˜¯é•œåƒåªè¯»å±‚ï¼Œupperdiræ˜¯å®¹å™¨å¯è¯»å¯å†™å±‚ï¼Œworkdiræ˜¯æ‰§è¡Œæ¶‰åŠä¿®æ”¹lowerdiræ‰§è¡Œcopy_upæ“ä½œçš„ä¸­è½¬å±‚ï¼ˆä¾‹å¦‚ï¼Œupperdirä¸­ä¸å­˜åœ¨ï¼Œéœ€è¦ä»lowerdirä¸­è¿›è¡Œå¤åˆ¶ï¼Œè¯¥è¿‡ç¨‹æš‚æœªè¯¦ç»†äº†è§£ï¼Œé‡åˆ°äº†å†åˆ†æï¼‰ã€‚</p>
<h3 id="å®æˆ˜ï¼šè‡ªåˆ¶ç®€å•docker"><a href="#å®æˆ˜ï¼šè‡ªåˆ¶ç®€å•docker" class="headerlink" title="å®æˆ˜ï¼šè‡ªåˆ¶ç®€å•docker"></a>å®æˆ˜ï¼šè‡ªåˆ¶ç®€å•docker</h3><p>æ˜ç™½äº†ä»¥ä¸Šä¸‰ä¸ªåŸºæœ¬åŸç†ï¼Œå®é™…ä¸Šæˆ‘ä»¬å·²ç»å¯ä»¥åˆ¶ä½œä¸€ä¸ªç®€å•çš„å°dockeräº†ï¼è¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œè¿˜æ˜¯ä½¿ç”¨AUFSä½œä¸ºå­˜å‚¨ã€‚<br>é¦–å…ˆï¼Œä½¿ç”¨goçš„urfave&#x2F;cliå‘½ä»¤è¡Œå·¥å…·ï¼Œå°†ä»£ç æ”¹é€ æˆå‘½ä»¤è¡Œç¨‹åºï¼š</p>
<pre><code>const usage = `we make a small docker container by ourselves using basic knowledge.`

func main() &#123;
    app := cli.NewApp()
    app.Name = &quot;mydocker&quot;
    app.Usage = usage

    app.Commands = []cli.Command&#123;
        initCommand,
        runCommand,
    &#125;

    app.Before = func(context *cli.Context) error &#123;
        // Log as JSON instead of the default ASCII formatter.
        log.SetFormatter(&amp;log.JSONFormatter&#123;&#125;)

        log.SetOutput(os.Stdout)
        return nil
    &#125;

    if err := app.Run(os.Args); err != nil &#123;
        log.Fatal(err)
    &#125;
&#125;
</code></pre>
<p>è¿™é‡Œæˆ‘ä»¬è§„å®šäº†2æ¡å‘½ä»¤ï¼šrunå’Œinitï¼Œå…¶ä¸­runå°±å’Œdocker runä¸€æ ·æ˜¯å¯åŠ¨å®¹å™¨ï¼Œè€Œinitæ˜¯å†…éƒ¨è°ƒç”¨çš„ç”¨äºåˆå§‹åŒ–å®¹å™¨çš„å‘½ä»¤ã€‚æ¥ç€ï¼Œæˆ‘ä»¬è¯¦ç»†å®šä¹‰è¿™ä¸¤æ¡å‘½ä»¤ï¼š</p>
<pre><code>var runCommand = cli.Command&#123;
    Name: &quot;run&quot;,
    Usage: `Create a container with namespace and cgroups limit
            mydocker run -ti [command]`,
    Flags: []cli.Flag&#123;
        cli.BoolFlag&#123;
            Name:  &quot;ti&quot;,
            Usage: &quot;enable tty&quot;,
        &#125;,
    &#125;,
    Action: func(context *cli.Context) error &#123;
        if len(context.Args()) &lt; 1 &#123;
            return fmt.Errorf(&quot;Missing container command&quot;)
        &#125;
        var cmdArray []string
        for _, arg := range context.Args() &#123;
            cmdArray = append(cmdArray, arg)
        &#125;
        tty := context.Bool(&quot;ti&quot;)
        Run(tty, cmdArray)
        return nil
    &#125;,
&#125;

var initCommand = cli.Command&#123;
    Name:  &quot;init&quot;,
    Usage: &quot;Init container process run user&#39;s process in container. Do not call it outside&quot;,
    Action: func(context *cli.Context) error &#123;
        log.Infof(&quot;init come on&quot;)
        err := container.RunContainerInitProcess()
        return err
    &#125;,
&#125;
</code></pre>
<p>å…¶ä¸­flagsè§„å®šäº†ä¸€äº›è°ƒç”¨å‚æ•°ï¼Œå¦‚tiå°±å’Œdockerä¸­ä¸€æ ·ï¼Œæ„ä¹‰æ˜¯å¯åŠ¨ç»ˆç«¯å’Œäº¤äº’ã€‚actionæ˜¯å‘½ä»¤çœŸæ­£çš„å…¥å£ï¼Œè¿™é‡Œå…ˆåˆ¤æ–­æœ‰æ— å‘½ä»¤ï¼Œå†è¯»å–argså°†å‘½ä»¤å­˜å…¥cmdArrayã€‚æœ€åè°ƒç”¨äº†Runå‡½æ•°ï¼š</p>
<pre><code>func Run(tty bool, comArray []string) &#123;
    parent, writePipe := container.NewParentProcess(tty)
    if parent == nil &#123;
        log.Errorf(&quot;New parent process error&quot;)
        return
    &#125;
    if err := parent.Start(); err != nil &#123;
        log.Error(err)
    &#125;
    sendInitCommand(comArray, writePipe)
    parent.Wait()
    mntURL := &quot;/cproot/mnt/&quot;
    rootURL := &quot;/cproot/&quot;
    container.DeleteWorkSpace(rootURL, mntURL)
    os.Exit(0)
&#125;

func sendInitCommand(comArray []string, writePipe *os.File) &#123;
    command := strings.Join(comArray, &quot; &quot;)
    log.Infof(&quot;command all is %s&quot;, command)
    writePipe.WriteString(command)
    writePipe.Close()
&#125;
</code></pre>
<p>æ¥ç€ï¼Œé¦–å…ˆè°ƒç”¨äº†NewParentProcesså‡½æ•°ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code>func NewParentProcess(tty bool) (*exec.Cmd, *os.File) &#123;
    readPipe, writePipe, err := NewPipe()
    if err != nil &#123;
        log.Errorf(&quot;New pipe error %v&quot;, err)
        return nil, nil
    &#125;
    cmd := exec.Command(&quot;/proc/self/exe&quot;, &quot;init&quot;)
    cmd.SysProcAttr = &amp;syscall.SysProcAttr&#123;
        Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWPID | syscall.CLONE_NEWNS |
            syscall.CLONE_NEWNET | syscall.CLONE_NEWIPC,
    &#125;
    if tty &#123;
        cmd.Stdin = os.Stdin
        cmd.Stdout = os.Stdout
        cmd.Stderr = os.Stderr
    &#125;
    cmd.ExtraFiles = []*os.File&#123;readPipe&#125;
    mntURL := &quot;/cproot/mnt/&quot;
    rootURL := &quot;/cproot/&quot;
    NewWorkSpace(rootURL, mntURL)
    cmd.Dir = mntURL
    return cmd, writePipe
&#125;

func NewPipe() (*os.File, *os.File, error) &#123;
    read, write, err := os.Pipe()
    if err != nil &#123;
        return nil, nil, err
    &#125;
    return read, write, nil
&#125;
</code></pre>
<p>è¿™é‡Œå…ˆè°ƒç”¨NewPipeåˆ›å»ºäº†ç”¨äºå¤–éƒ¨å’Œå®¹å™¨é€šä¿¡çš„ç®¡é“ï¼Œæ¥ç€è®¾ç½®äº†éœ€è¦æ‰§è¡Œçš„ä¸¤æ¡å‘½ä»¤ï¼š<br>&#x2F;proc&#x2F;self&#x2F;exe å½“å‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æœ¬èº«çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿™å°±æ˜¯è‡ªå·±è°ƒç”¨è‡ªå·±ï¼Œæ¥åˆå§‹åŒ–åˆšåˆ›å»ºå‡ºçš„è¿›ç¨‹ã€‚<br>init å°±æ˜¯åˆšåˆšè‡ªå®šä¹‰çš„å‘½ä»¤ã€‚<br>æ¥ç€è®¾ç½®äº†ç³»ç»Ÿè°ƒç”¨å±æ€§ï¼šè¿™é‡Œå°±æ˜¯forkå‡ºä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œä¸”ä¸ºè¿™ä¸ªè¿›ç¨‹è®¾ç½®äº†è‹¥å¹²namespaceï¼Œæ¥ä¸å¤–éƒ¨ç¯å¢ƒè¿›è¡Œéš”ç¦»ã€‚<br>ç”±äºè¿›ç¨‹çš„3ä¸ªæ–‡ä»¶æè¿°ç¬¦å·²ç»è¢«æ ‡å‡†è¾“å…¥ã€è¾“å‡ºã€é”™è¯¯æ‰€å ç”¨ï¼Œæ‰€ä»¥å°±é€šè¿‡extraFilesä¼ å…¥äº†ç®¡é“è¯»å–ç«¯ç»™å­è¿›ç¨‹ã€‚æ¥ç€è§„å®šäº†ï¼Œè”åˆæ–‡ä»¶ç³»ç»Ÿæœ€ç»ˆçš„æŒ‚è½½ç›®å½•å’Œé•œåƒã€å®¹å™¨layeræ‰€åœ¨çš„ç›®å½•ã€‚ç´§æ¥ç€ä¾¿è°ƒç”¨äº†NewWorkSpaceå‡½æ•°ï¼š</p>
<pre><code>func NewWorkSpace(rootURL string, mntURL string) &#123;
    CreateReadOnlyLayer(rootURL)
    CreateWriteLayer(rootURL)
    CreateMountPoint(rootURL, mntURL)
&#125;

func CreateReadOnlyLayer(rootURL string) &#123;
    busyboxURL := rootURL + &quot;busybox/&quot;
    busyboxTarURL := rootURL + &quot;busybox.tar&quot;
    exist, err := PathExists(busyboxURL)
    if err != nil &#123;
        log.Infof(&quot;Fail to judge whether dir %s exists. %v&quot;, busyboxURL, err)
    &#125;
    if exist == false &#123;
        if err := os.Mkdir(busyboxURL, 0777); err != nil &#123;
            log.Errorf(&quot;Mkdir dir %s error. %v&quot;, busyboxURL, err)
        &#125;
        if _, err := exec.Command(&quot;tar&quot;, &quot;-xvf&quot;, busyboxTarURL, &quot;-C&quot;, busyboxURL).CombinedOutput(); err != nil &#123;
            log.Errorf(&quot;Untar dir %s error %v&quot;, busyboxURL, err)
        &#125;
    &#125;
&#125;

func CreateWriteLayer(rootURL string) &#123;
    writeURL := rootURL + &quot;writeLayer/&quot;
    if err := os.Mkdir(writeURL, 0777); err != nil &#123;
        log.Errorf(&quot;Mkdir dir %s error. %v&quot;, writeURL, err)
    &#125;
&#125;

func CreateMountPoint(rootURL string, mntURL string) &#123;
    if err := os.Mkdir(mntURL, 0777); err != nil &#123;
        log.Errorf(&quot;Mkdir dir %s error. %v&quot;, mntURL, err)
    &#125;
    dirs := &quot;dirs=&quot; + rootURL + &quot;writeLayer:&quot; + rootURL + &quot;busybox&quot;
    cmd := exec.Command(&quot;mount&quot;, &quot;-t&quot;, &quot;aufs&quot;, &quot;-o&quot;, dirs, &quot;none&quot;, mntURL)
    cmd.Stdout = os.Stdout
    cmd.Stderr = os.Stderr
    if err := cmd.Run(); err != nil &#123;
        log.Errorf(&quot;%v&quot;, err)
    &#125;
&#125;
</code></pre>
<p>è¿™ä¸ªå‡½æ•°åˆ†ä¸º3ä¸ªéƒ¨åˆ†ï¼Œé¦–å…ˆæ˜¯åˆ›å»ºé•œåƒå±‚ï¼ˆåªè¯»ï¼‰ï¼Œæ¥ç€æ˜¯åˆ›å»ºå®¹å™¨å¯å†™å±‚ï¼Œæœ€åå°±æ˜¯ç”¨AUFSçš„æ–¹å¼å°†å®¹å™¨å±‚ã€å¯å†™å±‚è”åˆæŒ‚è½½åˆ°æŒ‡å®šçš„mntURLä¸‹ã€‚<br>é€šè¿‡è°ƒç”¨newparentprocessï¼Œæˆ‘ä»¬å°±ä»è¿”å›å€¼å¾—åˆ°äº†è¿™æ ·çš„ä¸€æ¡å‘½ä»¤ï¼Œå¹¶åœ¨Runå‡½æ•°ä¸­å¯¹å…¶è°ƒç”¨startå‡½æ•°ï¼Œè¿™æ‰æ˜¯çœŸæ­£å¼€å§‹è¿™æ¡å‘½ä»¤çš„æ‰§è¡Œï¼Œå®ƒä¼šé¦–å…ˆcloneå‡ºä¸€ä¸ªnamespaceéš”ç¦»çš„è¿›ç¨‹ï¼Œå¹¶åœ¨å­è¿›ç¨‹ä¸­å…ˆè°ƒç”¨&#x2F;proc&#x2F;self&#x2F;exeï¼Œå³å…¶æœ¬èº«ï¼Œæ¥ç€è°ƒç”¨æˆ‘ä»¬å†™çš„initæ–¹æ³•ï¼Œè¿›è¡Œåˆå§‹åŒ–ã€‚ç„¶åä¾¿å¼€å§‹æ‰§è¡ŒsendInitCommandå‡½æ•°ï¼Œå³å°†ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤è¯»å–åˆ°ç®¡é“çš„å†™å…¥ç«¯ã€‚å½“ç¨‹åºæ‰§è¡Œå®Œæ¯•åï¼Œä¼šè°ƒç”¨waité‡Šæ”¾è¿›ç¨‹èµ„æºå¹¶é€€å‡ºï¼Œä»¥åŠæ‰§è¡ŒDeleteWorkSpaceåˆ é™¤å¯å†™å±‚å’Œè§£æŒ‚aufsç³»ç»Ÿï¼ˆç›¸å½“äºé€€å‡ºå®¹å™¨ï¼‰ï¼Œè¿™äº›éƒ½æ˜¯åè¯ã€‚<br>ç”Ÿæˆå­è¿›ç¨‹åï¼Œé¦–å…ˆä¼šè°ƒç”¨è‡ªå·±ï¼Œå³å¯åŠ¨å­è¿›ç¨‹ã€‚æ¥ç€å­è¿›ç¨‹å°±ä¼šæ‰§è¡Œinitå‘½ä»¤ï¼Œè°ƒç”¨RunContainerInitProcess()ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œæˆ‘ä»¬å·²ç»èº«å¤„namespaceå†…çš„å­è¿›ç¨‹äº†ï¼š</p>
<pre><code>func RunContainerInitProcess() error &#123;
    cmdArray := readUserCommand()
    if cmdArray == nil || len(cmdArray) == 0 &#123;
        return fmt.Errorf(&quot;Run container get user command error, cmdArray is nil&quot;)
    &#125;

    setUpMount()

    path, err := exec.LookPath(cmdArray[0])
    if err != nil &#123;
        log.Errorf(&quot;Exec loop path error %v&quot;, err)
        return err
    &#125;
    log.Infof(&quot;Find path %s&quot;, path)
    if err := syscall.Exec(path, cmdArray[0:], os.Environ()); err != nil &#123;
        log.Errorf(err.Error())
    &#125;
    return nil
&#125;

func readUserCommand() []string &#123;
    pipe := os.NewFile(uintptr(3), &quot;pipe&quot;)
    msg, err := ioutil.ReadAll(pipe)
    if err != nil &#123;
        log.Errorf(&quot;init read pipe error %v&quot;, err)
        return nil
    &#125;
    msgStr := string(msg)
    return strings.Split(msgStr, &quot; &quot;)
&#125;

/**
Init æŒ‚è½½ç‚¹
*/
func setUpMount() &#123;
    pwd, err := os.Getwd()
    if err != nil &#123;
        log.Errorf(&quot;Get current location error %v&quot;, err)
        return
    &#125;
    log.Infof(&quot;Current location is %s&quot;, pwd)
    pivotRoot(pwd)

    //mount proc
    defaultMountFlags := syscall.MS_NOEXEC | syscall.MS_NOSUID | syscall.MS_NODEV
    quarantineMountFlags := syscall.MS_PRIVATE | syscall.MS_REC
    syscall.Mount(&quot;&quot;,&quot;/&quot;,&quot;&quot;, uintptr(quarantineMountFlags), &quot;&quot;)
    syscall.Mount(&quot;proc&quot;, &quot;/proc&quot;, &quot;proc&quot;, uintptr(defaultMountFlags), &quot;&quot;)

    //syscall.Mount(&quot;tmpfs&quot;, &quot;/dev&quot;, &quot;tmpfs&quot;, syscall.MS_NOSUID|syscall.MS_STRICTATIME, &quot;mode=755&quot;)
&#125;

func pivotRoot(root string) error &#123;
    /**
    ä¸ºäº†ä½¿å½“å‰rootçš„è€ root å’Œæ–° root ä¸åœ¨åŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸‹ï¼Œæˆ‘ä»¬æŠŠrooté‡æ–°mountäº†ä¸€æ¬¡
    bind mountæ˜¯æŠŠç›¸åŒçš„å†…å®¹æ¢äº†ä¸€ä¸ªæŒ‚è½½ç‚¹çš„æŒ‚è½½æ–¹æ³•
    */
    log.Infof(&quot;pivotroot: root is %s&quot;, root)
    if err := syscall.Mount(root, root, &quot;bind&quot;, syscall.MS_BIND|syscall.MS_REC, &quot;&quot;); err != nil &#123;
        return fmt.Errorf(&quot;Mount rootfs to itself error: %v&quot;, err)
    &#125;
    // åˆ›å»º rootfs/.pivot_root å­˜å‚¨ old_root
    pivotDir := filepath.Join(root, &quot;.pivot_root&quot;)
    if err := os.Mkdir(pivotDir, 0777); err != nil &#123;
        return err
    &#125;
    // pivot_root åˆ°æ–°çš„rootfs, ç°åœ¨è€çš„ old_root æ˜¯æŒ‚è½½åœ¨rootfs/.pivot_root
    // æŒ‚è½½ç‚¹ç°åœ¨ä¾ç„¶å¯ä»¥åœ¨mountå‘½ä»¤ä¸­çœ‹åˆ°
    if err := syscall.PivotRoot(root, pivotDir); err != nil &#123;
        return fmt.Errorf(&quot;pivot_root %v&quot;, err)
    &#125;
    // ä¿®æ”¹å½“å‰çš„å·¥ä½œç›®å½•åˆ°æ ¹ç›®å½•
    if err := syscall.Chdir(&quot;/&quot;); err != nil &#123;
        return fmt.Errorf(&quot;chdir / %v&quot;, err)
    &#125;

    pivotDir = filepath.Join(&quot;/&quot;, &quot;.pivot_root&quot;)
    // umount rootfs/.pivot_root
    if err := syscall.Unmount(pivotDir, syscall.MNT_DETACH); err != nil &#123;
        return fmt.Errorf(&quot;unmount pivot_root dir %v&quot;, err)
    &#125;
    // åˆ é™¤ä¸´æ—¶æ–‡ä»¶å¤¹
    return os.Remove(pivotDir)
&#125;
</code></pre>
<p>é¦–å…ˆæ˜¯è°ƒç”¨readCommandä»ç®¡é“è¯»å–ç”¨æˆ·ä¼ å…¥çš„å‘½ä»¤ï¼Œå¹¶åœ¨åæ¥è¯†åˆ«ç³»ç»Ÿç¯å¢ƒå˜é‡å¹¶äºˆä»¥æ‰§è¡Œã€‚æ¥ç€è°ƒç”¨setupMountå¼€å§‹ä¸€ç³»åˆ—æŒ‚è½½å·¥ä½œã€‚è¿™é‡Œè¯»å–åˆ°çš„pwdå°±æ˜¯æŒ‡å®šçš„mntURLï¼Œä¹Ÿå°±æ˜¯è”åˆæ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹ï¼Œå®¹å™¨çš„å·¥ä½œç›®å½•ã€‚æ¥ç€ï¼Œè°ƒç”¨pivotRoot(pwd)ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œpivot_rootæ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä¸»è¦åŠŸèƒ½æ˜¯æ”¹å˜å½“å‰çš„rootfsã€‚pivot_rootå¯ä»¥å°†å½“å‰è¿›ç¨‹çš„rootfsç§»åŠ¨åˆ°put_oldæ–‡ä»¶å¤¹ï¼Œå†ä½¿new_rootæˆä¸ºæ–°çš„rootfsã€‚new_rootå’Œput_oldå¿…é¡»ä¸èƒ½åŒæ—¶å­˜åœ¨å½“å‰rootçš„åŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­ã€‚è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å’Œchrootå‘½ä»¤åŒºåˆ«åœ¨äºï¼Œå‰è€…æ˜¯å°†æ•´ä¸ªç³»ç»Ÿåˆ‡æ¢åˆ°ä¸€ä¸ªæ–°çš„rootç›®å½•ï¼Œå¹¶ç§»é™¤å¯¹ä¹‹å‰rootæ–‡ä»¶ç³»ç»Ÿçš„ä¾èµ–ï¼Œè¿™æ ·å°±èƒ½umountåŸå…ˆçš„rootfsã€‚è€Œåè€…åªæ˜¯é’ˆå¯¹æŸä¸ªè¿›ç¨‹ï¼Œç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†ä¾æ—§è¿è¡Œäºè€çš„rootç›®å½•ä¸­ã€‚<br>æ³¨æ„ï¼åœ¨æŒ‚è½½å¼€å§‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆæœ‰è¿™æ ·çš„æ“ä½œï¼š</p>
<pre><code>quarantineMountFlags := syscall.MS_PRIVATE | syscall.MS_REC
syscall.Mount(&quot;&quot;,&quot;/&quot;,&quot;&quot;, uintptr(quarantineMountFlags), &quot;&quot;)
</code></pre>
<p>è¿™å°±æ˜¯å¼€å§‹å°†mount namespaceæ—¶æå‡ºçš„ï¼Œå…¶ä½œç”¨ç›¸å½“äºmount â€“make-rprivate &#x2F;,å³é€’å½’ä¿®æ”¹æ•´ä¸ªmountæ ‘çš„propagate typeä¸ºprivateï¼Œè¿™æ ·æˆ‘ä»¬åœ¨å®¹å™¨å†…çš„æŒ‚è½½æ“ä½œæ‰ä¸ä¼šä¼ ç»™å¤–éƒ¨ã€‚å¦åˆ™åœ¨æ¥ä¸‹æ¥æŒ‚è½½procåï¼Œå›åˆ°ä¸»æœºç³»ç»Ÿï¼Œä¼šå‘ç°å¾ˆå¤šå‘½ä»¤éƒ½æ— æ³•ä½¿ç”¨äº†ã€‚è¿™å…¶å®å°±æ˜¯å› ä¸ºä¸»æœºçš„procè¢«ä¿®æ”¹äº†ï¼Œéœ€è¦åœ¨ä¸»æœºé‡æ–°mountä¸€æ¬¡procæ‰èƒ½æ¢å¤æ­£å¸¸ã€‚<br>è¿™ä¹‹åï¼Œinitå‘½ä»¤çš„å·¥ä½œä¹Ÿå°±åšå®Œäº†ï¼Œæ­¤æ—¶æˆ‘ä»¬çš„å®¹å™¨å·²å¯åŠ¨èµ·æ¥ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.eynnzerr.top/2025/08/29/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/otae.jpg">
      <meta itemprop="name" content="Eynnzerr">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eynnzerr's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/08/29/hello-world/" class="post-title-link" itemprop="url">Eynnzerr's Blog å¤æ´»</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-08-29 16:43:57 / ä¿®æ”¹æ—¶é—´ï¼š20:51:27" itemprop="dateCreated datePublished" datetime="2025-08-29T16:43:57+08:00">2025-08-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%85%B6%E5%AE%83/" itemprop="url" rel="index"><span itemprop="name">å…¶å®ƒ</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>404</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>1 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>åœ¨è¿˜æ˜¯æ‡µæ‡‚çš„å¤§ä¸€æœ¬ç§‘ç”Ÿæ—¶ï¼Œæ›¾ç»æŠ˜è…¾è¿‡ä¸€å°æœåŠ¡å™¨éƒ¨ç½²äº†ä¸€ä¸ªåšå®¢ç½‘ç«™ï¼Œä¿æŒè¿‡ä¸€å¹´çš„æ›´æ–°ï¼Œæœ€ç»ˆå´å¹¶æœªåšæŒä¸‹å»ã€‚åšå®¢åºŸå¼ƒäº†ï¼ŒåŸŸåæ—©å·²è¿‡æœŸï¼ŒæœåŠ¡å™¨ä¹Ÿåœæœºé‡Šæ”¾äº†ã€‚</p>
<p>ä¸‰å¹´åçš„ä»Šå¤©ï¼Œåœ¨æ•´ç†æ—§ç”µè„‘çš„æ•°æ®æ—¶ï¼Œæ— æ„é—´çœ‹åˆ°äº†æ›¾ç»å†™è¿‡çš„å‡ ç¯‡å†…å®¹ã€‚ä¹Ÿè®¸æ–‡ç¬”ç¨šå«©ï¼Œä¹Ÿè®¸æŠ€æœ¯åŠ›å°šæ¬ ç¼ºï¼Œå´ä¸€ç¬é—´å°†æˆ‘å¸¦å›ä»å‰ï¼Œé‚£æ®µæ—¶å…‰ä¸­ï¼Œæœ€å‹¤å¥‹å¥½å­¦ï¼Œè´ªå©ªåœ°æ±²å–çŸ¥è¯†ï¼ŒæœŸå¾…ç€å˜å¼ºçš„è‡ªå·±ã€‚</p>
<p>æœç„¶ï¼Œåšå®¢è¿˜æ˜¯è¦åšä¸‹å»ã€‚å½“å†åº¦èŒç”Ÿè¿™ä¸ªæƒ³æ³•æ—¶ï¼Œè¿™ä¸ªæ–°çš„ç«™ç‚¹å°±è¯ç”Ÿäº†ã€‚ä¸ºäº†è¿½æ±‚å¿«é€Ÿéƒ¨ç½²ï¼Œé‡‡ç”¨äº†<strong>Github Pages</strong> + <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo">Hexo</a>ï¼Œä¸»é¢˜æš‚ä¸”è¿˜æ˜¯ä½¿ç”¨äº†çƒ‚å¤§è¡—ä½†æ˜¯ç¡®å®å¾ˆç®€çº¦è€çœ‹çš„<a target="_blank" rel="noopener" href="https://github.com/next-theme/hexo-theme-next">Next</a>ã€‚æˆ‘ä¼šåƒä»å‰ä¸€æ ·ï¼Œåœ¨è¿™é‡Œè®°å½•è‡ªå·±çš„æŠ€æœ¯å­¦ä¹ ä¸å®è·µç»éªŒï¼Œä¸ä»…ä¸ºè‡ªå·±çš„åæ€æ€»ç»“ï¼Œå¦‚æœèƒ½å¸®åˆ°ä¸€äº›äººé‚£ä¾¿æ›´å¥½ã€‚ç›®å‰æˆ‘ä¼šå…ˆå¯¹ä¿ç•™çš„è€åšå®¢æ–‡ç« ä½œç­›é€‰ï¼Œå°†ä¸€éƒ¨åˆ†ä»æœ‰ä¸€å®šä»·å€¼çš„æ–‡ç« æ¬è¿è¿‡æ¥ã€‚</p>
<p>åŒæ—¶åœ¨æŠ€æœ¯ä¹‹å¤–ï¼Œè¿™ä¸ªç½‘ç«™ä¹Ÿä¼šæ”¶å½•ä¸€äº›ä¸ªäººåœ¨å¹³å¸¸çš„æ‰€æ„Ÿæ‰€æƒ³ï¼Œæ— æ„ä¹‰çš„å¿µå¨ï¼Œä»¥åŠç”Ÿæ´»çš„ç¢ç‰‡ã€‚æˆ‘æƒ³ï¼Œäººæ€»å½’è¿˜æ˜¯å¸Œæœ›èƒ½ç•™ä¸‹äº›ä»€ä¹ˆä¸œè¥¿ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Eynnzerr"
      src="/images/otae.jpg">
  <p class="site-author-name" itemprop="name">Eynnzerr</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Eynnzerr" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;Eynnzerr" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:eynnzerr@gmail.com" title="E-Mail â†’ mailto:eynnzerr@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://plus.google.com/eynnzerr" title="Google â†’ https:&#x2F;&#x2F;plus.google.com&#x2F;eynnzerr" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i>Google</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">çš–ICPå¤‡2022012668å·-1 </a>
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Eynnzerr</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">70k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">2:07</span>
</div>
  <div class="powered-by">
    <!--ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨ -->
  </div>

<!-- ç½‘ç«™è¿è¡Œæ—¶é—´çš„è®¾ç½® -->
<span id="timeDate">è½½å…¥å¤©æ•°...</span>
<span id="times">è½½å…¥æ—¶åˆ†ç§’...</span>
<script>
    var now = new Date();
    function createtime() {
        var grt= new Date("01/07/2021 10:00:00"); //æ­¤å¤„ä¿®æ”¹ä½ çš„å»ºç«™æ—¶é—´æˆ–è€…ç½‘ç«™ä¸Šçº¿æ—¶é—´
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "æœ¬ç«™å·²å®‰å…¨è¿è¡Œ "+dnum+" å¤© ";
        document.getElementById("times").innerHTML = hnum + " å°æ—¶ " + mnum + " åˆ† " + snum + " ç§’.";
    }
setInterval("createtime()",250);
</script>
        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
